<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Management System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- General & Premium Look CSS --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

/* --- Login Page Styles --- */
#login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f0f2f5;
    z-index: 2000;
}
.login-box {
    background: white;
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    width: 100%;
    max-width: 400px;
    text-align: center;
}
.login-box h2 {
    margin-bottom: 25px;
    color: var(--dark-color);
}
.input-group {
    text-align: left;
    margin-bottom: 20px;
}
.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
}
.input-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
}
.login-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    background-color: var(--primary-color);
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
}
.login-btn:hover {
    background-color: #357ABD;
}
.error-message {
    color: var(--danger-color);
    margin-top: 15px;
    font-weight: 500;
    height: 20px;
}
.hidden {
    display: none !important;
}
/* Style for disabled action buttons */
.action-btn.disabled-action {
    opacity: 0.5;
    pointer-events: none; /* This makes the button unclickable */
    text-decoration: line-through;
}


        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50e3c2;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --white-color: #ffffff;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --deep-blue: #2c3a6b;
            --normal-blue: #4a90e2;
            --text-red: #c0392b;
            --text-violet: #8e44ad;
            --text-green: #27ae60;
            --warning-bg: #fffbe6;
            --warning-border: #ffe58f;
            --danger-bg-light: #ffebee;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: var(--white-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 60px; /* Space for footer */
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        h1, h2, h3, h4 {
            color: var(--dark-color);
            margin-bottom: 1rem;
        }
        
        .report-section h3 {
             color: var(--deep-blue);
             border-bottom: 2px solid var(--primary-color);
             padding-bottom: 10px;
             margin-top: 25px;
        }
        
        /* --- Sync Status Indicator --- */
        #syncStatus {
            font-size: 0.9em;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        #syncStatus.syncing { background-color: rgba(255, 165, 0, 0.2); color: #e67e22; }
        #syncStatus.synced { background-color: rgba(46, 204, 113, 0.2); color: var(--success-color); }
        #syncStatus.error { background-color: rgba(231, 76, 60, 0.2); color: var(--danger-color); }
        #syncStatus.loading { background-color: rgba(74, 144, 226, 0.2); color: var(--primary-color); }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            background: var(--dark-color);
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: var(--light-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: var(--white-color);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .sub-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sub-tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 500;
            color: #555;
            position: relative;
        }
        .sub-tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        .sub-tab-button.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        .sub-tab-button.active::after {
            width: 100%;
        }
        
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }


        /* --- Forms --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
            color: #777;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        /* Specific Label Colors */
        .label-deep-blue { color: var(--deep-blue); font-weight: bold; }
        .label-normal-blue { color: var(--normal-blue); font-weight: bold; }
        .label-red { color: var(--text-red); font-weight: bold; }
        .label-violet { color: var(--text-violet); font-weight: bold; }
        .label-green { color: var(--text-green); font-weight: bold; }

        .calculated-value {
            font-weight: bold;
            color: var(--text-red);
            font-size: 16px;
            margin-top: 5px;
        }

        /* --- Buttons --- */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #357ABD; }
        .btn-secondary { background-color: var(--dark-color); color: white; }
        .btn-secondary:hover { background-color: #1a2531; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #27ae60; }
        .btn-clear { background-color: #bdc3c7; }
        .btn-clear:hover { background-color: #95a5a6; }
        
        .btn-link {
            background: none;
            color: var(--primary-color);
            text-decoration: underline;
            padding: 0 5px;
            margin: 0;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-link.btn-danger { color: var(--danger-color); }
        .btn-link-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0 5px;
            font-size: 1.2em;
        }

        /* --- Tables/Lists & Rate List --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background-color: var(--dark-color);
            color: white;
            font-weight: 600;
        }
        .data-table tr:nth-child(even) { background-color: #f8f8f8; }
        .data-table tr:hover { background-color: #e8f4f8; }
        .data-table tr.low-stock-warning {
            background-color: var(--danger-bg-light) !important;
            font-weight: bold;
        }
         .data-table tr.low-stock-warning td:first-child { color: var(--text-red); }
        
        /* --- Pagination --- */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .pagination-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: #fff;
        }
        .pagination-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* --- Modals (Pop-ups) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            overflow-y: auto; padding: 20px 0;
        }

        .modal-content {
            background: white; padding: 30px; border-radius: 8px;
            width: 90%; max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slide-down 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }

        @keyframes slide-down {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-table-container {
            max-height: 250px; overflow-y: auto;
            border: 1px solid #ddd; border-radius: 6px; margin-top: 15px;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
        }
        .modal-header h3 { margin: 0; }
        .close-button {
            cursor: pointer; border: none; background: none;
            font-size: 24px; font-weight: bold;
        }
        
        .challan-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .btn-add-remove {
            padding: 8px 12px;
            font-size: 18px;
            line-height: 1;
        }

        /* Utility & Footer */
        .mt-20 { margin-top: 20px; }
        .d-flex { display: flex; align-items: center; }
        .gap-10 { gap: 10px; }
        .w-100 { width: 100%; }
        hr { border: 0; height: 1px; background: #ddd; margin: 30px 0; }
        .search-box {
            padding: 12px; border: 1px solid #ccc; border-radius: 6px;
            width: 300px; font-size: 15px; margin-bottom: 20px;
        }
        .item-details-box {
            padding: 15px; background-color: #f9f9f9; border: 1px solid #e0e0e0;
            border-radius: 8px; margin-top: 15px; display: grid;
            grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .modal-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee;
        }
        .hidden { display: none; }
        
        .app-footer {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); font-size: 14px;
            color: #777; font-style: italic;
        }
        
        .disabled-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 10;
        }

/* Add this to your existing CSS */
.ledger-row-purchase {
    background-color: #d4edda !important; /* Light Green */
    color: #155724;
}
.ledger-row-issue {
    background-color: #ffffff;
}


/* --- ORDER TAB STYLES --- */
#printContainer { display: none; }

/* Print Specific Styles */
/* --- PRINT CSS (Add inside <style> tag) --- */
    @media print {
    body * { visibility: hidden; } /* বাকি সব লুকানো থাকবে */
    #printContainer, #printContainer * { visibility: visible; } /* শুধু প্রিন্ট কন্টেইনার দেখা যাবে */
    
    #printContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
        color: black;
        font-family: 'Times New Roman', serif;
        font-size: 12pt;
    }

    /* Page Setup */
    .print-page {
        width: 210mm;
        min-height: 297mm; /* A4 size */
        padding: 20mm;
        margin: 0 auto;
        box-sizing: border-box;
        position: relative;
    }

    /* Page Break Logic */
    .page-break { 
        page-break-after: always; /* ১ নম্বর পেজের পর ব্রেক দেবে */
        display: block;
        height: 1px;
    }

    /* Letterhead Space */
    .letter-head-space { height: 120px; }

    /* Layout Helpers */
    .print-header-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-weight: bold;
    }

    .signature-section {
        margin-top: 80px;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
    }

    /* Print Tables */
    .print-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-bottom: 15px;
    }
    .print-table th, .print-table td {
        border: 1px solid black;
        padding: 6px;
        text-align: left;
        font-size: 11pt;
    }
    .print-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }

    /* Hide UI elements */
    .btn, .tabs, .header, .modal-overlay { display: none !important; }
}

/* --- UPDATE: Scrollable Modal --- */
.modal-content {
    max-height: 85vh; /* স্ক্রিনের উচ্চতার ৮৫% */
    overflow-y: auto; /* কন্টেন্ট বেশি হলে স্ক্রল হবে */
}

/* Edit Table styling inside modal */
.editing-qty, .editing-rate {
    width: 70px;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* --- UPDATE: Scrollable Modal & Print Fixes --- */
.modal-content {
    max-height: 85vh; /* স্ক্রিনের উচ্চতার ৮৫% */
    overflow-y: auto; /* কন্টেন্ট বেশি হলে স্ক্রল হবে */
}

/* Print specific styles for Webel Format */
@media print {
    .page-break { 
        page-break-after: always;
        display: block;
        height: 1px;
    }
    .webel-header {
        text-align: center;
        margin-bottom: 20px;
        color: #0056b3 !important; /* Webel Blue */
    }
    .webel-logo-text {
        font-size: 40px;
        font-weight: bold;
        font-family: sans-serif;
    }
    .webel-subtext {
        font-size: 14px;
        color: #333;
    }
    .print-table th, .print-table td {
        border: 1px solid black !important;
        padding: 5px;
        font-size: 12px;
    }
    .signature-section {
        margin-top: 60px;
        display: flex;
        justify-content: space-between;
    }
}
    </style>
</head>




<body>
<div id="login-container">
    <div class="login-box">
        <h2>Store Management System Login</h2>
        <form onsubmit="handleLogin(event)">
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
            <p id="login-error" class="error-message"></p>
        </form>
    </div>
</div>
<div id="app-container" class="hidden">
<div class="container">
    <header class="header">
    <h1>Store Management System</h1>
    <div style="display: flex; align-items: center;">
        <button id="logout-button" class="btn btn-danger" onclick="handleLogout()" style="margin-right: 15px;">Logout</button>
        <div id="syncStatus" class="loading">Loading...</div>
    </div>
</header>

<nav class="tabs">
    <button class="tab-button active" onclick="openTab(event, 'itemManage')"><b>ITEM MANAGE</b></button>
    <button class="tab-button" onclick="openTab(event, 'itemRates'); renderLiveRateReport();"><b>RATE OF ITEMS</b></button>
    <button class="tab-button" onclick="openTab(event, 'purchaseManage')"><b>PURCHASE MANAGE</b></button>
    <button class="tab-button" onclick="openTab(event, 'issueManage')"><b>ISSUE REQUISITION MANAGE</b></button>
    <button class="tab-button" onclick="openTab(event, 'report')"><b>REPORT</b></button>
    <button class="tab-button" onclick="openTab(event, 'settings')"><b>SETTINGS</b></button>
    <button class="tab-button" onclick="openTab(event, 'orderManage')"><b>ORDER</b></button>
</nav>
    <datalist id="itemListData"></datalist>
    <datalist id="miscListData"></datalist>
    <main id="itemManage" class="tab-content active">
        <div class="sub-tabs">
            <button class="sub-tab-button active" onclick="openSubTab(event, 'addItem', 'itemManage')">ADD ITEM</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'itemList', 'itemManage')">STORE ITEM LIST</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'lowStockList', 'itemManage'); renderLowStockItems();">LOW STOCK ITEMS</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'miscItemList', 'itemManage'); filterMiscItemsLog();">MISCELLANEOUS ITEMS</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'manageMiscItems', 'itemManage'); renderMiscItemListForEditing();">MANAGE MISC. ITEMS</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'miscDefaults', 'itemManage'); renderMiscDefaultsForm();">MISC DEFAULTS</button>
        </div>
<div id="manageMiscItems" class="sub-tab-content">
    <h3>Manage Miscellaneous Items</h3>
    <p>From here, you can edit the name and unit of a miscellaneous item. Changes will be reflected across all historical invoices, challans, and requisitions.</p>
    <input type="text" id="manageMiscSearch" class="search-box" onkeyup="renderMiscItemListForEditing()" placeholder="Search for miscellaneous items...">
    <table class="data-table">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Current Stock</th>
                <th>Unit</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="manageMiscItemsBody">
        </tbody>
    </table>
    <div id="manageMiscPaginationControls" class="pagination-controls"></div>
</div>
        <div id="addItem" class="sub-tab-content active">
            <h3>Add New Item</h3>
            <form id="addItemForm" class="form-grid">
                <div class="form-group">
                    <label class="label-deep-blue">ITEM NAME</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label class="label-normal-blue">ITEM CODE</label>
                    <input type="text" id="itemCode" required>
                </div>
                <div class="form-group">
                    <label class="label-red">STOCK PAGE NO.</label>
                    <input type="number" id="stockPageNo" required>
                </div>
                <div class="form-group">
                    <label class="label-violet">PURCH. PAGE NO.</label>
                    <input type="number" id="purchPageNo" required>
                    <div class="d-flex gap-10 mt-20">
                        <input type="checkbox" id="sameAsStockPage">
                        <label for="sameAsStockPage">Same as Stock Page No.</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>UNIT MEASURE</label>
                    <select id="unitMeasure">
                    </select>
                </div>
                 <div class="form-group">
                    <label class="label-red">REORDER LEVEL</label>
                    <input type="number" id="reorderLevel" value="0" required>
                </div>
                <div class="form-group">
                    <label class="label-green">CURRENT STOCK</label>
                    <input type="number" id="currentStock" value="0" readonly>
                </div>
            </form>
            <div class="mt-20">
                <button type="button" class="btn btn-primary" onclick="saveItem()">SAVE ITEM</button>
                <button type="button" class="btn btn-clear" onclick="document.getElementById('addItemForm').reset()">CLEAR</button>
            </div>
            <hr>
            <h3>Import Items from Excel</h3>
            <div class="form-group">
                <label>Select Excel File (.xlsx)</label>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls">
                <p style="font-size: 12px; margin-top: 5px;">
                    Required format: 'Item Name', 'Item Code', 'Stock Page No.', 'Purch. Page No.', 'Unit Measure'. Optional: 'Reorder Level'.
                </p>
            </div>
             <button class="btn btn-success mt-20" onclick="importItemsFromExcel()">Import Items</button>
        </div>

        <div id="itemList" class="sub-tab-content">
            <h3>Item List</h3>
            <input type="text" id="itemSearch" class="search-box" onkeyup="filterItemList()" placeholder="Search for items...">
            <button class="btn btn-secondary" onclick="openModal('updateAllPurchPageModal')">Update All Item Purch. Page No.</button>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Item Code</th>
                        <th>Stock Page</th>
                        <th>Purch. Page</th>
                        <th>Current Stock</th>
                        <th>Reorder Lvl</th>
                        <th>Unit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="itemListBody">
                </tbody>
            </table>
            <div id="paginationControls" class="pagination-controls"></div>
             <hr>
            <h3>Update Items from Excel</h3>
            <div class="form-group">
                <label>Select Excel File (.xlsx) to Update</label>
                <input type="file" id="excelUpdateFileInput" accept=".xlsx, .xls">
                <p style="font-size: 12px; margin-top: 5px;">
                    Required: 'Item Code'. Can update: 'Item Name', 'Stock Page No.', 'Purch. Page No.', 'Unit Measure', 'Reorder Level'.
                </p>
            </div>
             <button class="btn btn-success mt-20" onclick="updateItemsFromExcel()">Update Items</button>
        </div>
        
        <div id="lowStockList" class="sub-tab-content">
            <h3>Low Stock Items</h3>
            <p>This list shows all items where the current stock is at or below the set reorder level.</p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Item Code</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody id="lowStockListBody">
                </tbody>
            </table>
        </div>
        
        <div id="miscItemList" class="sub-tab-content">
            <h3>Miscellaneous Item Transaction Log</h3>
            <p>This log shows all purchase and issue transactions for items not in the master list. Use Update to edit the source transaction.</p>
            <input type="text" id="miscItemSearch" class="search-box" onkeyup="filterMiscItemsLog()" placeholder="Search for misc items...">
            <table class="data-table">
                <thead>
    <tr>
        <th>Item Name</th>
        <th>Type</th>
        <th>Qty</th>
        <th>Unit</th>
        <th>Rate</th>
        <th>Vendor's/Department</th>
        <th>Date</th>
        <th>Transaction Details</th>
        <th>Actions</th>
    </tr>
</thead>
                <tbody id="miscItemListBody">
                </tbody>
            </table>
            <div id="miscPaginationControls" class="pagination-controls"></div>
        </div>
        
        <div id="miscDefaults" class="sub-tab-content">
            <h3>Miscellaneous Item Defaults</h3>
            <p>Set the default information that will be displayed for any miscellaneous item.</p>
            <form id="miscDefaultsForm" class="form-grid">
                 <div class="form-group">
                    <label class="label-normal-blue">DEFAULT ITEM CODE</label>
                    <input type="text" id="miscDefaultCode">
                </div>
                 <div class="form-group">
                    <label class="label-red">DEFAULT STOCK PAGE NO.</label>
                    <input type="text" id="miscDefaultStockPage">
                </div>
                 <div class="form-group">
                    <label class="label-violet">DEFAULT PURCH. PAGE NO.</label>
                    <input type="text" id="miscDefaultPurchPage">
                </div>
                <div class="form-group">
                    <label>DEFAULT UNIT MEASURE</label>
                    <select id="miscDefaultUnit"></select>
                </div>
            </form>
            <div class="mt-20">
                 <button class="btn btn-primary" onclick="saveMiscDefaults()">SAVE DEFAULTS</button>
            </div>
        </div>
    </main>
    
    <main id="itemRates" class="tab-content">
        <h3>Rate Per Unit Report</h3>
        <p>This report automatically shows the most recent rate for each item based on your saved invoices.</p>
        <input type="text" id="liveRateSearch" class="search-box" onkeyup="renderLiveRateReport()" placeholder="Search by item or vendor...">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Rate per Unit (Incl. GST)</th>
                    <th>Vendor's Name</th>
                </tr>
            </thead>
            <tbody id="liveRateListBody">
                </tbody>
        </table>
        <div id="ratePaginationControls" class="pagination-controls"></div>
    </main>

    <main id="purchaseManage" class="tab-content">
        <div class="sub-tabs">
            <button class="sub-tab-button active" onclick="openSubTab(event, 'challanEntry', 'purchaseManage')">CHALLAN ENTRY</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'challanUpdate', 'purchaseManage'); renderSavedChallans();">CHALLAN UPDATE TO INVOICE</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'invoiceEntry', 'purchaseManage')">INVOICE ENTRY</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'viewSavedInvoice', 'purchaseManage'); filterInvoiceList();">VIEW SAVED INVOICE</button>
        </div>

        <div id="challanEntry" class="sub-tab-content active">
            <h3>Challan Entry</h3>
            <form id="challanEntryForm" class="form-grid">
                <div class="form-group">
                    <label>SELECT VENDOR NAME</label>
                    <select id="challanVendorName"></select>
                </div>
                <div class="form-group">
                    <label>CHALLAN NUMBER</label>
                    <input type="text" id="challanNumber">
                </div>
                <div class="form-group">
                    <label>CHALLAN DATE</label>
                    <input type="date" id="challanDate">
                </div>
            </form>
            <hr>
            <h4>Add Items to Challan</h4>
            <div class="d-flex gap-10">
                <input type="checkbox" id="challanMiscCheckbox" onchange="toggleMiscItem('challan')">
                <label for="challanMiscCheckbox">Miscellaneous Item</label>
            </div>
             <div class="form-grid mt-20">
                 
                <div class="form-group">
    <label>SELECT/WRITE ITEM</label>
    <input type="text" id="challanItemName" list="itemListData" onchange="showChallanItemDetails(); populateOrderRefDropdown('challan');">
    <input type="text" id="challanMiscItemName" class="hidden mt-20" placeholder="Enter Miscellaneous Item Name" oninput="showChallanItemDetails()">
</div>

<div class="form-group" id="challanOrderRefGroup" style="display:none; background: #fffbe6; padding: 10px; border: 1px solid #ffe58f; border-radius: 5px;">
    <label style="color: var(--deep-blue); font-size: 12px;">LINK TO ORDER (VALIDATION)</label>
    <select id="challanOrderRef" onchange="validateOrderQty('challan')" style="width:100%; padding:8px;"></select>
    <small id="challanOrderLimitMsg" style="color: red; display:none; font-weight:bold;"></small>
</div>

<div class="form-group">
    <label>SUPPLIED QUANTITIES</label>
    <input type="number" id="challanSuppliedQty" value="0" oninput="calculateChallanNewStock(); validateOrderQty('challan')">
</div>
                <div id="challanMiscUnitGroup" class="form-group hidden">
                    <label>UNIT MEASURE</label>
                    <select id="challanMiscUnit"></select>
                </div>
            </div>
             <div class="item-details-box" style="margin-top: 0;">
                <span id="challanNewStockResult" class="calculated-value"></span>
             </div>
            <div id="challanItemDetails" class="item-details-box" style="display:none;"></div>
            <button type="button" class="btn btn-secondary mt-20" onclick="addItemToChallan()">ADD ITEM TO CHALLAN</button>
            
            <h4 class="mt-20">Items in this Challan</h4>
            <table class="data-table">
                <thead><tr><th>Item Name</th><th>Item Code</th><th>Supplied Qty</th><th>Unit</th><th>Action</th></tr></thead>
                <tbody id="challanItemsTableBody"></tbody>
            </table>
            
            <div class="mt-20">
                <button class="btn btn-primary" onclick="saveChallan()">SAVE CHALLAN</button>
                <button class="btn btn-clear" onclick="clearChallanForm()">CLEAR</button>
            </div>
        </div>

        <div id="challanUpdate" class="sub-tab-content">
            <h3>Saved Challans</h3>
            <p>Select challans from the same vendor to update to a single invoice.</p>
             <table class="data-table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Challan No.</th>
                        <th>Challan Date</th>
                        <th>Vendor</th>
                        <th>Items</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="savedChallansBody"></tbody>
            </table>
            <button class="btn btn-success mt-20" onclick="prepareUpdateToInvoice()">Update to Invoice</button>
        </div>

        <div id="invoiceEntry" class="sub-tab-content">
            <h3>Direct Invoice Entry</h3>
            <form id="directInvoiceForm" class="form-grid">
                <div class="form-group">
                    <label>INVOICE NUMBER</label>
                    <input type="text" id="directInvoiceNumber" required>
                </div>
                <div class="form-group">
                    <label>INVOICE DATE</label>
                    <input type="date" id="directInvoiceDate" required>
                </div>
                <div class="form-group">
                    <label>SELECT VENDOR NAME</label>
                    <select id="directInvoiceVendorName" required onchange="fetchRateForDirectInvoice()"></select>
                </div>
            </form>
            <hr>
            <div class="d-flex" style="justify-content: space-between; align-items: flex-end;">
                <h4>Challan Details</h4>
                <button class="btn btn-success btn-add-remove" onclick="addChallanInput()">+</button>
            </div>
            <div id="challanInputsContainer">
                <div class="challan-input-row">
                    <input type="text" placeholder="Challan Number" class="challan-number-input">
                    <input type="date" class="challan-date-input">
                    <button class="btn btn-danger btn-add-remove" onclick="this.parentElement.remove()">-</button>
                </div>
            </div>
            <hr>
            <h4>Add Items to Invoice</h4>
            <div class="d-flex gap-10">
                <input type="checkbox" id="directInvoiceMiscCheckbox" onchange="toggleMiscItem('directInvoice')">
                <label for="directInvoiceMiscCheckbox">Miscellaneous Item</label>
            </div>
            <div class="form-grid mt-20">
    <div class="form-group">
    <label>SELECT/WRITE ITEM</label>
    <input type="text" id="directInvoiceItemName" list="itemListData" 
           onchange="showDirectInvoiceItemDetails(); fetchRateForDirectInvoice(); populateOrderRefDropdown('directInvoice');">
    
    <input type="text" id="directInvoiceMiscItemName" class="hidden mt-20" 
           placeholder="Enter Miscellaneous Item Name" 
           oninput="showDirectInvoiceItemDetails(); populateOrderRefDropdown('directInvoice');">
</div>

<div class="form-group" id="directInvoiceOrderRefGroup" style="display:none; background: #fffbe6; padding: 10px; border: 1px solid #ffe58f; border-radius: 5px;">
    <label style="color: var(--deep-blue); font-size: 12px;">LINK TO ORDER (VALIDATION)</label>
    <select id="directInvoiceOrderRef" onchange="validateOrderQty('directInvoice')" style="width:100%; padding:8px;"></select>
    <small id="directInvoiceOrderLimitMsg" style="color: red; display:none; font-weight:bold;"></small>
</div>

<div class="form-group">
    <label>SUPPLIED QUANTITIES</label>
    <input type="number" id="directInvoiceSuppliedQty" value="0" oninput="calculateDirectInvoiceNewStock(); calculateDirectInvoiceItemValue(); validateOrderQty('directInvoice')">
</div>
                 <div id="directInvoiceMiscUnitGroup" class="form-group hidden">
                    <label>UNIT MEASURE</label>
                    <select id="directInvoiceMiscUnit"></select>
                </div>
                 <div class="form-group">
                    <label>RATE</label>
                    <input type="number" id="directInvoiceRate" value="0" oninput="calculateDirectInvoiceItemValue()">
                </div>
                 <div class="form-group">
                    <label>GST %</label>
                    <div class="d-flex">
                        <select id="directInvoiceGst" class="w-100" onchange="calculateDirectInvoiceItemValue()"></select>
                    </div>
                </div>
            </div>
            <div class="item-details-box" style="margin-top:0;">
                 <span id="directInvoiceNewStockResult" class="calculated-value"></span>
                 <span id="directInvoiceItemValue" class="calculated-value label-green" style="text-align: right;"></span>
            </div>
            <div id="directInvoiceItemDetails" class="item-details-box" style="display:none;"></div>
            <div class="d-flex mt-20" style="align-items: center;">
                <button type="button" class="btn btn-secondary" onclick="addItemToDirectInvoice()">ADD ITEM TO INVOICE</button>
                <h4 id="directInvoiceTotalValue" class="label-red" style="margin-left: 20px;">Total Value: 0.00</h4>
            </div>

            <h4 class="mt-20">Items in this Invoice</h4>
            <table class="data-table">
                <thead><tr><th>Item Name</th><th>Qty</th><th>Unit</th><th>Rate</th><th>GST %</th><th>Value</th><th>Action</th></tr></thead>
                <tbody id="directInvoiceItemsTableBody"></tbody>
            </table>

            <div class="mt-20">
                <button class="btn btn-primary" onclick="saveDirectInvoice()">SAVE INVOICE</button>
                <button class="btn btn-clear" onclick="clearDirectInvoiceForm()">CLEAR</button>
            </div>
        </div>

<div id="viewSavedInvoice" class="sub-tab-content">
    <h3>View Saved Invoices</h3>

    <div class="form-grid" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
        <div class="form-group">
            <label>Search by Invoice No. or Vendor</label>
            <input type="text" id="invoiceSearch" class="search-box" style="width: 100%; margin: 0;" onkeyup="filterInvoiceList()" placeholder="Search...">
        </div>
        <div class="form-group">
            <label>Filter by Vendor</label>
            <select id="invoiceFilterVendor" onchange="filterInvoiceList()" style="padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;"></select>
        </div>
        <div class="form-group">
            <label>Filter by Item Type</label>
            <select id="invoiceFilterItemType" onchange="toggleStoreItemFilter(); filterInvoiceList();" style="padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;">
                <option value="all">All Items</option>
                <option value="store">Store Items Only</option>
                <option value="misc">Miscellaneous Items Only</option>
            </select>
        </div>
        <div class="form-group" id="invoiceStoreItemFilterContainer" style="display: none;">
            <label>Select Store Item</label>
            <select id="invoiceFilterStoreItem" onchange="filterInvoiceList()" style="padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;"></select>
        </div>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="invoiceFilterStartDate" onchange="filterInvoiceList()">
        </div>
        <div class="form-group">
            <label>End Date</label>
            <input type="date" id="invoiceFilterEndDate" onchange="filterInvoiceList()">
        </div>
        <div class="form-group" style="align-self: flex-end;">
             <button class="btn btn-clear" onclick="clearInvoiceFilters()" style="width: 100%;">Clear Filters</button>
        </div>
    </div>
    <table class="data-table">
        <thead>
    <tr>
        <th>Invoice No.</th>
        <th>Invoice Date</th>
        <th>Vendor</th>
        <th>Challan Number(s)</th>
        <th>Challan Date(s)</th>
        <th>Items</th>
        <th>Total Amount</th>
        <th>Actions</th>
    </tr>
</thead>
        <tbody id="savedInvoicesBody"></tbody>
    </table>
    <div id="invoicePaginationControls" class="pagination-controls"></div>
</div>
    </main>

    <main id="issueManage" class="tab-content">
        <div class="sub-tabs">
            <button class="sub-tab-button active" onclick="openSubTab(event, 'requisitionEntry', 'issueManage')">REQUISITION ENTRY</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'legacyRequisitionUpload', 'issueManage'); initializeLegacySingleItemEntry();">LEGACY REQUISITION ENTRY</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'viewSavedRequisition', 'issueManage'); filterRequisitionList();">VIEW SAVED REQUISITION</button>
        </div>
        
        <div id="requisitionEntry" class="sub-tab-content active">
             <h3>Requisition Entry</h3> <div id="lastReqInfo" style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #90caf9; color: #1565c0; font-size: 14px;">
                Loading last entry info...
             </div>
             <form id="requisitionEntryForm" class="form-grid">
                <div class="form-group">
                    <label>DATE</label>
                    <input type="date" id="reqDate">
                </div>
                <div class="form-group">
                    <label>REQUISITION SLIP NUMBER</label>
                    <div class="d-flex gap-10">
                        <input type="text" id="reqSlipNo" oninput="formatReqSlipNo(this)">
                    </div>
                </div>
                <div class="form-group">
                    <label>SELECT DEPARTMENT</label>
                    <select id="reqDepartment"></select>
                </div>
            </form>
             <hr>
            <h4>Add Items to Requisition</h4>
             <div class="form-group">
                <label>Select Item Type:</label>
                <div class="d-flex gap-10">
                    <input type="radio" id="reqStoreItemRadio" name="reqItemType" value="store" onchange="toggleRequisitionItemType('req')" checked> <label for="reqStoreItemRadio">Store Item</label>
                    <input type="radio" id="reqMiscItemRadio" name="reqItemType" value="misc" onchange="toggleRequisitionItemType('req')"> <label for="reqMiscItemRadio">Miscellaneous Item</label>
                </div>
            </div>
             <div class="form-grid mt-20">
                 <div class="form-group">
                    <label>SELECT ITEM</label>
                    <select id="reqItemName" onchange="showReqItemDetails()">
                    </select>
                </div>
                <div class="form-group">
                    <label>ISSUED QUANTITIES</label>
                    <input type="number" id="reqIssuedQty" value="0" oninput="calculateReqNewStock()">
                    <span id="reqNewStockResult" class="calculated-value"></span>
                </div>
            </div>
            <div id="reqItemDetails" class="item-details-box" style="display:none;"></div>
            <button type="button" class="btn btn-secondary mt-20" onclick="addItemToRequisition()">ADD ITEM TO REQUISITION</button>

            <h4 class="mt-20">Items in this Requisition</h4>
            <table class="data-table">
             <thead><tr><th>Sl. No.</th><th>Item Name</th><th>Item Code</th><th>Issued Qty</th><th>Unit</th><th>Action</th></tr></thead>  
                <tbody id="requisitionItemsTableBody"></tbody>
            </table>

            <div class="mt-20">
                <button class="btn btn-primary" onclick="saveRequisition()">SAVE REQUISITION</button>
                <button class="btn btn-clear" onclick="clearRequisitionForm()">CLEAR</button>
            </div>
        </div>
        <div id="legacyRequisitionUpload" class="sub-tab-content">
            <h3>Legacy Requisition Entry (Single Item)</h3>
            <p>First select an item. Then add multiple requisition slips for that single item.</p>
            
            <div class="form-grid" style="grid-template-columns: 2fr 1fr; align-items: end;">
                <div class="form-group">
                    <label class="label-deep-blue">ITEM SELECT (STORE ITEM)</label>
                    <select id="legacySingleItemSelect" onchange="selectLegacySingleItem()"></select>
                </div>
                <button class="btn btn-secondary" id="legacyChangeItemBtn" onclick="clearLegacySingleItemForm()" style="margin-bottom: 1px;">Change Item</button>
            </div>
            
            <div id="legacySingleItemDetails" class="item-details-box" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"></div>
            <hr>
            
            <div id="legacySingleReqEntryContainer" style="position: relative;">
                <div id="legacySingleReqEntryOverlay" class="disabled-overlay"></div>
                <h4>Add Requisition Slip</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>DATE</label>
                        <input type="date" id="legacySingleReqDate">
                    </div>
                    <div class="form-group">
                        <label>REQUISITION SLIP NUMBER</label>
                        <input type="text" id="legacySingleReqSlipNo" oninput="formatLegacyReqSlipNo(this)">
                    </div>
                    <div class="form-group">
                        <label>SUPPLIED QUANTITIES</label>
                        <input type="number" id="legacySingleReqIssuedQty" value="0">
                    </div>
                    <div class="form-group">
                        <label>SELECT DEPARTMENT</label>
                        <select id="legacySingleReqDepartment"></select>
                    </div>
                    <div class="form-group d-flex" style="align-items: flex-end; justify-content: flex-start;">
                        <button type="button" class="btn btn-success" onclick="addLegacySingleReqToList()" style="width: 60px; height: 45px; font-size: 24px;">+</button>
                    </div>
                </div>
            </div>
            
            <hr>
            <h3>Upload Requisitions from Excel</h3>
                <div class="form-group">
                    <label>Select Excel File (.xlsx) for the item selected above.</label>
                    <input type="file" id="legacyExcelInput" accept=".xlsx, .xls">
                    <p style="font-size: 12px; margin-top: 5px;">
                        Required format: 'Date', 'Requisition Slip No.', 'Department', 'Quantities'.
                    </p>
                </div>
            <button class="btn btn-success mt-20" onclick="importLegacyRequisitionsFromExcel()">Upload from Excel & Add to List</button>
            <hr>

            <h4 class="mt-20">Requisition Slips to be Saved</h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Slip No.</th>
                        <th>Department</th>
                        <th>Issued Qty</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="legacySingleReqItemsTableBody"></tbody>
            </table>
            
            <div class="mt-20">
                <button class="btn btn-primary" onclick="saveAllLegacySingleItemReqs()">SAVE ALL REQUISITIONS</button>
                <button class="btn btn-clear" onclick="clearLegacySingleItemForm()">CLEAR ALL</button>
            </div>

        </div>
        <div id="viewSavedRequisition" class="sub-tab-content">
     <h3>View Saved Requisitions</h3>
     <input type="text" id="requisitionSearch" class="search-box" style="width: 100%; margin:0;" 
     onkeyup="currentRequisitionPage=1; filterRequisitionList()" placeholder="Search any text...">

<select id="requisitionFilterDept" class="w-100" 
      onchange="currentRequisitionPage=1; filterRequisitionList()"></select>
    <div class="form-grid" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
        <div class="form-group">
            <label>Search (Slip No, Dept, Item)</label>
            <input type="text" id="requisitionSearch" class="search-box" style="width: 100%; margin:0;" onkeyup="filterRequisitionList()" placeholder="Search any text...">
        </div>
        <div class="form-group">
            <label>Filter by Department</label>
            <select id="requisitionFilterDept" class="w-100" onchange="filterRequisitionList()"></select>
        </div>
        <div class="form-group">
            <label>Filter by Item Type</label>
            <select id="requisitionFilterItemType" class="w-100" onchange="toggleRequisitionItemFilters(); filterRequisitionList();">
                <option value="all">All Items</option>
                <option value="store">Store Item</option>
                <option value="misc">Miscellaneous Item</option>
            </select>
        </div>
        <div class="form-group" id="requisitionStoreItemContainer" style="display: none;">
            <label>Select Store Item</label>
            <select id="requisitionFilterStoreItem" class="w-100" onchange="filterRequisitionList()"></select>
        </div>
        <div class="form-group" id="requisitionMiscItemContainer" style="display: none;">
            <label>Select Miscellaneous Item</label>
            <select id="requisitionFilterMiscItem" class="w-100" onchange="filterRequisitionList()"></select>
        </div>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="requisitionFilterStartDate" onchange="filterRequisitionList()">
        </div>
        <div class="form-group">
            <label>End Date</label>
            <input type="date" id="requisitionFilterEndDate" onchange="filterRequisitionList()">
        </div>
         <div class="form-group" style="align-self: flex-end;">
             <button class="btn btn-clear" onclick="clearRequisitionFilters()" style="width: 100%;">Clear Filters</button>
        </div>
    </div>
    <div class="d-flex" style="justify-content: flex-end; align-items: center; margin-bottom: 20px;">
        <div>
           <button class="btn btn-danger" onclick="findAndMergeDuplicateRequisitions()">Find & Merge Duplicate Slips</button>
           <button class="btn btn-danger" onclick="autoMergeAllDuplicateRequisitions()">Auto-Merge All Duplicates</button>
        </div>
     </div>

     <table class="data-table">
        <thead>
            <tr>
                <th>Req. Slip/No.</th>
                <th>Req. Date</th>
                <th>Department</th>
                <th>Items</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="savedRequisitionsBody"></tbody>
    </table>
    <div id="requisitionPaginationControls" class="pagination-controls"></div>
</div>
    </main>

    <main id="report" class="tab-content">
        <h2>Reports</h2>
        <div class="report-section">
            <h3>Current Stock Value Report</h3>
            <p>Generates a report of all Store Items with their Current Stock and Total Valuation.</p>
            
            <div class="d-flex gap-10 mt-20">
                <button class="btn btn-secondary" onclick="viewCurrentStockValueReport()">👁️ View Report</button>
                
                <button class="btn btn-primary" onclick="generateCurrentStockValueReport('pdf')">📄 Generate PDF</button>
                <button class="btn btn-success" onclick="generateCurrentStockValueReport('excel')">📊 Generate Excel</button>
            </div>
        </div>
        <hr>
        <div class="report-section">
            <h3>Rate Chart Report (Comparative)</h3>
            <p>Vendor-wise comparative rate chart within a specific date range. Lowest rate is highlighted.</p>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="rateChartStartDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="rateChartEndDate">
                </div>
            </div>
        
            <div class="d-flex gap-10 mt-20">
                <button class="btn btn-primary" onclick="previewRateChart()">👁️ Preview Rate Chart</button>
                <button class="btn btn-primary" onclick="exportRateChart('pdf')">📄 Download PDF</button>
                <button class="btn btn-success" onclick="exportRateChart('excel')">📊 Download Excel</button>
            </div>
        </div>
        <hr>
        <div class="report-section">
            <h3>Monthly Store Item Supply Report</h3>
            <p>Generates a report of total supplied quantities (from both Challans and Invoices) for all store items for a selected month and year.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Month</label>
                    <select id="supplyReportMonth">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Year</label>
                    <select id="supplyReportYear">
                        </select>
                </div>
            </div>
            <button class="btn btn-primary mt-20" onclick="generateMonthlySupplyReport()">Generate Report</button>
        </div>
        <div class="report-section">
            <h3>Item Ledger Report</h3>
            <p>Generates a detailed transaction history for a single item, showing all purchases and issues within a date range.</p>
            <div class="form-grid">
                 <div class="form-group">
                    <label>Select Item</label>
                    <select id="ledgerItemSelect"></select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="ledgerReportStartDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="ledgerReportEndDate">
                </div>
            </div>
            <button class="btn btn-primary mt-20" onclick="generateItemLedgerReport('pdf')">Generate PDF</button>
            <button class="btn btn-success mt-20" onclick="generateItemLedgerReport('excel')">Generate Excel</button>
            <button class="btn btn-primary mt-20" onclick="previewItemLedgerReport()">Generate Report</button>
        </div>
        
        <hr>
        
        <div class="report-section">
            <h3>Purchase Report</h3>
            <p>Generates a detailed report of all items purchased within a specified date range.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="storePurchaseReportStartDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="storePurchaseReportEndDate">
                </div>
            </div>
            <button class="btn btn-primary mt-20" onclick="generateStorePurchaseReport('pdf')">Generate PDF</button>
            <button class="btn btn-success mt-20" onclick="generateStorePurchaseReport('excel')">Generate Excel</button>
        </div>
        
        <hr>

        <div class="report-section">
            <h3>Issued Requisition Report</h3>
            <p>Generates a hierarchical report of items issued to departments, with consumed value.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="valuedIssueReportStartDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="valuedIssueReportEndDate">
                </div>
            </div>
            <button class="btn btn-primary mt-20" onclick="generateValuedIssueReport('pdf')">Generate PDF</button>
            <button class="btn btn-success mt-20" onclick="generateValuedIssueReport('excel')">Generate Excel</button>
        </div>

        <hr>

        <div class="report-section">
            <h3>Miscellaneous Item Reports</h3>
            <p>Generates reports for miscellaneous items purchased or issued within a date range.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="miscReportStartDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="miscReportEndDate">
                </div>
            </div>
            <h4 class="mt-20">Generate Purchase Report</h4>
            <button class="btn btn-primary" onclick="generateMiscPurchaseReport('pdf')">PDF</button>
            <button class="btn btn-success" onclick="generateMiscPurchaseReport('excel')">Excel</button>
            
            <h4 class="mt-20">Generate Issued Report</h4>
            <button class="btn btn-primary" onclick="generateMiscIssuedReport('pdf')">PDF</button>
            <button class="btn btn-success" onclick="generateMiscIssuedReport('excel')">Excel</button>
        </div>
    </main>
<main id="orderManage" class="tab-content">
        <div class="sub-tabs">
            <button class="sub-tab-button active" onclick="openSubTab(event, 'makeOrder', 'orderManage')">MAKE ORDER</button>
            <button class="sub-tab-button" onclick="openSubTab(event, 'viewSavedOrders', 'orderManage'); filterSavedOrders();">VIEW SAVED ORDERS</button>
        </div>

        <div id="makeOrder" class="sub-tab-content active">
            <h3>Make New Order</h3>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Select Item Type:</label>
                <div class="d-flex gap-10">
                    <input type="radio" id="orderStoreItemRadio" name="orderItemType" value="store" checked onchange="toggleOrderItemType()"> 
                    <label for="orderStoreItemRadio">STORE ITEM</label>
                    
                    <input type="radio" id="orderMiscItemRadio" name="orderItemType" value="misc" onchange="toggleOrderItemType()"> 
                    <label for="orderMiscItemRadio">MISCELLANEOUS ITEM</label>
                </div>
            </div>
        
            <div class="form-grid">
                <div class="form-group">
                    <label>SELECT / SEARCH ITEM</label>
                    <input type="text" id="orderItemSearch" list="itemListData" onchange="fetchPurchaseHistory()" placeholder="Type Character, Alphabet, Number...">
                </div>
            </div>
        
            <small id="orderNewItemNote" style="display:none; color:orange;">* New Item (Will be treated as Miscellaneous)</small>
        
            <div id="purchaseHistorySection" style="display:none; margin-top:10px; border:1px solid #ddd; padding:10px; background:#fffbe6;">
                <h4>Purchase History (Lowest to Highest Rates)</h4>
                <table class="data-table" style="font-size: 0.9em;">
                    <thead>
                        <tr><th>Select</th><th>Date</th><th>Vendor Name</th><th>Rate (Incl. GST)</th></tr>
                    </thead>
                    <tbody id="purchaseHistoryBody"></tbody>
                </table>
            </div>
            <hr>
        
            <div class="form-grid">
                <div class="form-group">
                    <label>SELECTED VENDOR</label>
                    <input type="text" id="orderVendor" placeholder="Vendor Name">
                </div>
                <div class="form-group">
                    <label>RATE (Per Unit)</label>
                    <input type="number" id="orderRate" oninput="calcOrderTotal()">
                </div>
                <div class="form-group">
                    <label>GST % (Amount will be auto added)</label>
                    <select id="orderGst" onchange="calcOrderTotal()">
                        <option value="0">0%</option>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18">18%</option>
                        <option value="28">28%</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ORDER QTY</label>
                    <input type="number" id="orderQty" oninput="calcOrderTotal()">
                </div>
                <div class="form-group">
                    <label>UNIT</label>
                    <select id="orderUnit"></select>
                </div>
                <div class="form-group">
                    <label>TOTAL PRICE (With GST)</label>
                    <input type="text" id="orderTotalPrice" readonly style="font-weight:bold; color:var(--primary-color);">
                </div>
            </div>
            
            <button class="btn btn-secondary mt-20" onclick="addToOrderCart()">ADD TO ORDER</button>
        
            <h4 class="mt-20">Current Order Sheet</h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Vendor</th>
                        <th>Rate</th>
                        <th>GST %</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="orderCartBody"></tbody>
            </table>
            
            <h3 style="text-align:right; margin-top:10px;">Grand Total: <span id="orderGrandTotal">0.00</span></h3>
        
            <div class="mt-20">
                <button class="btn btn-primary" onclick="finalizeOrder()">MAKE ORDER NOTE</button>
                <button class="btn btn-clear" onclick="clearOrderCart()">CLEAR</button>
            </div>
        </div>
            <hr>
        
        

        <div id="viewSavedOrders" class="sub-tab-content">
            <h3>Saved Orders</h3>
            <div class="form-grid">
                <input type="text" id="savedOrderSearch" class="search-box" onkeyup="filterSavedOrders()" placeholder="Search by Ref, Vendor, Item...">
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Order Date</th>
                        <th>Reference Number</th>
                        <th>Item & Vendors Details</th>
                        <th>Total Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="savedOrdersBody"></tbody>
            </table>
            <div id="savedOrderPagination" class="pagination-controls"></div>
        </div>
    </main>

    <div id="limitAlertModal" class="modal-overlay">
        <div class="modal-content" style="border-top: 5px solid red;">
            <div class="modal-header">
                <h3 style="color:red;">⚠️ LIMIT WARNING</h3>
            </div>
            <p style="font-size: 18px; font-weight: bold; color: #c0392b;">
                আপনার ORDER AMOUNT একটি (Vendor এর নাম) ৯,৯৯০/- এর উর্ধে<br>
                Your Order Amount (<span id="alertVendorName"></span>) Exceeds 9,990/-
            </p>
            <p>Current Total: <span id="alertVendorTotal"></span></p>
            <hr>
            <div style="display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px;">
                <button class="btn btn-secondary" onclick="closeModal('limitAlertModal')">Reduce Amount (Back to Edit)</button>
                <button class="btn btn-primary" onclick="splitAndSaveOrder()">Make Multiple Order Sheets</button>
            </div>
        </div>
    </div>

    <div id="printContainer"></div>
    <main id="settings" class="tab-content">
        <h2>Settings & Data Management</h2>
        <p>Manage application-wide settings like vendors, departments, and units. Data is automatically synced with the cloud.</p>
        
        <div class="form-grid mt-20" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <button class="btn btn-secondary" onclick="openModal('vendorModal'); renderVendorList();">Manage Vendors</button>
            <button class="btn btn-secondary" onclick="openModal('departmentModal'); renderDepartmentList();">Manage Departments</button>
            <button class="btn btn-secondary" onclick="openModal('measureModal'); renderMeasureList();">Manage Measure Units</button>
            <button class="btn btn-secondary" onclick="openModal('gstModal'); renderGstList();">Manage GST Percentages</button>
        </div>
        
        <hr>
        
        <h3>Data Sync Status</h3>
        <p>
            This application is connected to a Google Sheet which acts as the database.
            The status indicator in the top-right corner shows the current connection status.
        </p>

    </main>
    
    <footer class="app-footer">
        Designed and Developed by WEBEL, Administrative Department
    </footer>

</div> 

<div id="measureModal" class="modal-overlay" onclick="if(event.target.id === 'measureModal') closeModal('measureModal');">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Measure Units</h3>
            <button class="close-button" onclick="closeModal('measureModal')">&times;</button>
        </div>
        <h4>Add/Edit/Delete</h4>
        <div class="form-group d-flex gap-10">
            <input type="text" id="newMeasureName" placeholder="Enter new measure name" class="w-100">
            <button class="btn btn-primary" onclick="addMeasure()">Add</button>
        </div>
        <div id="measureList"></div>
        <hr>
        <h4>Merge Units</h4>
        <div id="measureMergeSection"></div>
    </div>
</div>

<div id="vendorModal" class="modal-overlay" onclick="if(event.target.id === 'vendorModal') closeModal('vendorModal');">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Vendors</h3>
            <button class="close-button" onclick="closeModal('vendorModal')">&times;</button>
        </div>
        <div class="form-group d-flex gap-10">
            <input type="text" id="newVendorName" placeholder="Enter new vendor name" class="w-100">
            <button class="btn btn-primary" onclick="addVendor()">Add</button>
        </div>
        <hr>
        <div id="vendorList"></div>
    </div>
</div>

<div id="departmentModal" class="modal-overlay" onclick="if(event.target.id === 'departmentModal') closeModal('departmentModal');">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Departments</h3>
            <button class="close-button" onclick="closeModal('departmentModal')">&times;</button>
        </div>
        <h4>Add/Edit/Delete</h4>
         <div class="form-group d-flex gap-10">
            <input type="text" id="newDepartmentName" placeholder="Enter new department name" class="w-100">
            <button class="btn btn-primary" onclick="addDepartment()">Add</button>
        </div>
        <div id="departmentList"></div>
        <hr>
        <h4>Merge Departments</h4>
        <div id="departmentMergeSection"></div>
    </div>
</div>

<div id="gstModal" class="modal-overlay" onclick="if(event.target.id === 'gstModal') closeModal('gstModal');">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage GST Percentages</h3>
            <button class="close-button" onclick="closeModal('gstModal')">&times;</button>
        </div>
         <div class="form-group d-flex gap-10">
            <input type="number" id="newGstValue" placeholder="Enter new GST %" class="w-100">
            <button class="btn btn-primary" onclick="addGst()">Add</button>
        </div>
        <hr>
        <div id="gstList"></div>
    </div>
</div>

<div id="editItemModal" class="modal-overlay" onclick="if(event.target.id === 'editItemModal') closeModal('editItemModal');">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Item</h3>
            <button class="close-button" onclick="closeModal('editItemModal')">&times;</button>
        </div>
        <form id="editItemForm" class="form-grid">
            <input type="hidden" id="editItemId">
            <div class="form-group">
                <label class="label-deep-blue">ITEM NAME</label>
                <input type="text" id="editItemName" required>
            </div>
            <div class="form-group">
                <label class="label-normal-blue">ITEM CODE</label>
                <input type="text" id="editItemCode" required>
            </div>
            <div class="form-group">
                <label class="label-red">STOCK PAGE NO.</label>
                <input type="number" id="editStockPageNo" required>
            </div>
            <div class="form-group">
                <label class="label-violet">PURCH. PAGE NO.</label>
                <input type="number" id="editPurchPageNo" required>
            </div>
            <div class="form-group">
                <label>UNIT MEASURE</label>
                <select id="editUnitMeasure"></select>
            </div>
            <div class="form-group">
                <label class="label-red">REORDER LEVEL</label>
                <input type="number" id="editReorderLevel" required>
            </div>
            <div class="form-group">
                <label class="label-green">CURRENT STOCK</label>
                <input type="number" id="editCurrentStock">
            </div>
        </form>
        <div class="mt-20">
            <button class="btn btn-primary" onclick="updateItem()">UPDATE ITEM</button>
        </div>
    </div>
</div>

<div id="editInvoiceModal" class="modal-overlay" onclick="if(event.target.id === 'editInvoiceModal') closeModal('editInvoiceModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Edit Invoice</h3>
            <button class="close-button" onclick="closeModal('editInvoiceModal')">&times;</button>
        </div>
        <div id="editInvoiceModalBody">
            </div>
    </div>
</div>

<div id="viewInvoiceModal" class="modal-overlay" onclick="if(event.target.id === 'viewInvoiceModal') closeModal('viewInvoiceModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>View Invoice</h3>
            <button class="close-button" onclick="closeModal('viewInvoiceModal')">&times;</button>
        </div>
        <div id="viewInvoiceModalBody">
            </div>
    </div>
</div>

<div id="editRequisitionModal" class="modal-overlay" onclick="if(event.target.id === 'editRequisitionModal') closeModal('editRequisitionModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Edit Requisition</h3>
            <button class="close-button" onclick="closeModal('editRequisitionModal')">&times;</button>
        </div>
        <div id="editRequisitionModalBody">
            </div>
    </div>
</div>

<div id="viewRequisitionModal" class="modal-overlay" onclick="if(event.target.id === 'viewRequisitionModal') closeModal('viewRequisitionModal');">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>View Requisition</h3>
            <button class="close-button" onclick="closeModal('viewRequisitionModal')">&times;</button>
        </div>
        <div id="viewRequisitionModalBody">
            </div>
    </div>
</div>

<div id="editChallanModal" class="modal-overlay" onclick="if(event.target.id === 'editChallanModal') closeModal('editChallanModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Edit Challan</h3>
            <button class="close-button" onclick="closeModal('editChallanModal')">&times;</button>
        </div>
        <div id="editChallanModalBody">
            </div>
    </div>
</div>

<div id="viewChallanModal" class="modal-overlay" onclick="if(event.target.id === 'viewChallanModal') closeModal('viewChallanModal');">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>View Challan</h3>
            <button class="close-button" onclick="closeModal('viewChallanModal')">&times;</button>
        </div>
        <div id="viewChallanModalBody">
            </div>
    </div>
</div>


<div id="updateAllPurchPageModal" class="modal-overlay" onclick="if(event.target.id === 'updateAllPurchPageModal') closeModal('updateAllPurchPageModal');">
     <div class="modal-content">
        <div class="modal-header">
            <h3>Update All Purchase Page Numbers</h3>
            <button class="close-button" onclick="closeModal('updateAllPurchPageModal')">&times;</button>
        </div>
        <div class="form-group">
            <label>NEW PURCHASE PAGE NUMBER</label>
            <input type="number" id="newGlobalPurchPageNo" class="w-100">
        </div>
        <button class="btn btn-primary mt-20" onclick="updateAllPurchPageNumbers()">Update All</button>
    </div>
</div>

<div id="updateToInvoiceModal" class="modal-overlay" onclick="if(event.target.id === 'updateToInvoiceModal') closeModal('updateToInvoiceModal');">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header"><h3>Create Invoice from Challans</h3><button class="close-button" onclick="closeModal('updateToInvoiceModal')">&times;</button></div>
        <div id="updateToInvoiceModalBody">
        </div>
    </div>
</div>

<div id="requisitionMergeModal" class="modal-overlay" onclick="if(event.target.id === 'requisitionMergeModal') closeModal('requisitionMergeModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header"><h3>Merge Duplicate Requisitions</h3><button class="close-button" onclick="closeModal('requisitionMergeModal')">&times;</button></div>
        <div id="requisitionMergeModalBody"></div>
    </div>
</div>

<div id="monthlySupplyReportModal" class="modal-overlay" onclick="if(event.target.id === 'monthlySupplyReportModal') closeModal('monthlySupplyReportModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="monthlySupplyReportTitle">Monthly Supply Report</h3>
            <button class="close-button" onclick="closeModal('monthlySupplyReportModal')">&times;</button>
        </div>
        <div class="d-flex" style="justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="exportMonthlySupplyReport('pdf')">Export PDF</button>
            <button class="btn btn-success" onclick="exportMonthlySupplyReport('excel')">Export Excel</button>
        </div>
        <div class="modal-table-container" style="max-height: 60vh;">
            <table id="monthlySupplyReportTable" class="data-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Item Code</th>
                        <th>Total Supplied Qty</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody id="monthlySupplyReportBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="stockMovementReportModal" class="modal-overlay" onclick="if(event.target.id === 'stockMovementReportModal') closeModal('stockMovementReportModal');">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h3 id="stockMovementReportTitle">Stock Movement Report</h3>
            <button class="close-button" onclick="closeModal('stockMovementReportModal')">&times;</button>
        </div>
        <div class="d-flex" style="justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="exportStockMovementReport('pdf')">Export PDF</button>
            <button class="btn btn-success" onclick="exportStockMovementReport('excel')">Export Excel</button>
        </div>
        <div class="modal-table-container" style="max-height: 60vh;">
            <table id="stockMovementReportTable" class="data-table">
    <thead>
        <tr>
            <th>Item Name</th>
            <th>Item Code</th>
            <th>Opening Stock</th>
            <th>Qty Supplied (In)</th>
            <th>Supplied Value</th>
            <th>Qty Issued (Out)</th>
            <th>Issued Value</th>
            <th>Closing Stock</th>
            <th>Closing Stock Value</th>
        </tr>
    </thead>
    <tbody id="stockMovementReportBody">
        </tbody>
</table>
        </div>
    </div>
</div>

<div id="itemLedgerReportModal" class="modal-overlay" onclick="if(event.target.id === 'itemLedgerReportModal') closeModal('itemLedgerReportModal');">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3 id="itemLedgerReportTitle">Item Ledger Report</h3>
            <button class="close-button" onclick="closeModal('itemLedgerReportModal')">&times;</button>
        </div>
        
        <div id="itemLedgerReportHeader" style="padding: 15px; background: #f4f7f6; border-radius: 8px; margin-bottom: 15px;">
            </div>
        
        <div class="d-flex" style="justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="exportItemLedgerReport('pdf')">Export PDF</button>
            <button class="btn btn-success" onclick="exportItemLedgerReport('excel')">Export Excel</button>
        </div>
        
        <div class="modal-table-container" style="max-height: 60vh;">
            <table id="itemLedgerReportTable" class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Details</th>
                        <th>Qty In</th>
                        <th>Qty Out</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="itemLedgerReportBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>


<div id="editMiscItemModal" class="modal-overlay" onclick="if(event.target.id === 'editMiscItemModal') closeModal('editMiscItemModal');">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Miscellaneous Item</h3>
            <button class="close-button" onclick="closeModal('editMiscItemModal')">&times;</button>
        </div>
        <form id="editMiscItemForm" class="form-grid">
            <input type="hidden" id="editMiscItemId">
            <div class="form-group">
                <label>NEW ITEM NAME</label>
                <input type="text" id="editMiscItemName" required>
            </div>
            <div class="form-group">
                <label>NEW UNIT MEASURE</label>
                <select id="editMiscItemUnit"></select>
            </div>
        </form>
        <div class="mt-20">
            <button class="btn btn-primary" onclick="updateMiscItem()">SAVE CHANGES</button>
        </div>
    </div>
</div>
<!-- এটি আপনার body ট্যাগের শেষের দিকে থাকা আবশ্যক -->
<div id="printContainer"></div>
<div id="printPreviewModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 210mm; width: 100%;">
        <div class="modal-header">
            <h3>Print Preview</h3>
            <div>
                <button class="btn btn-primary" onclick="executePrint()">🖨️ Print Now</button>
                <button class="close-button" onclick="closeModal('printPreviewModal')">&times;</button>
            </div>
        </div>
        <div id="printPreviewBody" style="border: 1px solid #ddd; padding: 20px; min-height: 500px; max-height: 80vh; overflow-y: auto;">
            </div>
    </div>
</div>

<div id="editOrderModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 950px;">
        <div class="modal-header">
            <h3>Edit Order</h3>
            <button class="close-button" onclick="closeModal('editOrderModal')">&times;</button>
        </div>
        <div id="editOrderModalBody">
            </div>
    </div>
</div>

<div id="rateChartModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 95%; width: 95%; max-height: 90vh;">
        <div class="modal-header">
            <h3>Rate Chart (Comparative Statement)</h3>
            <button class="close-button" onclick="closeModal('rateChartModal')">&times;</button>
        </div>
        <div class="modal-table-container" style="max-height: 75vh; overflow-y: auto;">
            <table id="rateChartTable" class="data-table" style="font-size: 13px;">
                <thead id="rateChartHeader"></thead>
                <tbody id="rateChartBody"></tbody>
            </table>
        </div>
        <div class="mt-20" style="text-align: right;">
            <small>* <b>Bold</b> = Lowest Rate, <b><i>Bold & Italic</i></b> = 2nd Lowest Rate</small>
        </div>
    </div>
</div>

<div id="currentStockValueModal" class="modal-overlay" onclick="if(event.target.id === 'currentStockValueModal') closeModal('currentStockValueModal');">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="currentStockValueTitle">Current Stock Value Report</h3>
            <button class="close-button" onclick="closeModal('currentStockValueModal')">&times;</button>
        </div>
        
        <div class="modal-table-container" style="max-height: 60vh;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="position: sticky; top: 0; background: var(--dark-color); color: white;">Item Name</th>
                        <th style="position: sticky; top: 0; background: var(--dark-color); color: white;">Item Code</th>
                        <th style="position: sticky; top: 0; background: var(--dark-color); color: white;">Current Stock</th>
                        <th style="position: sticky; top: 0; background: var(--dark-color); color: white;">Unit</th>
                        <th style="position: sticky; top: 0; background: var(--dark-color); color: white;">Latest Rate (Incl. GST)</th>
                        <th style="position: sticky; top: 0; background: var(--dark-color); color: white;">Total Value</th>
                    </tr>
                </thead>
                <tbody id="currentStockValueBody">
                    </tbody>
            </table>
        </div>
        
        <hr>
        <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
            <h3 style="color: var(--text-red);">Grand Total Value: <span id="currentStockValueGrandTotal">0.00</span></h3>
        </div>
    </div>
</div>


<script>
  // --- IMPORTANT SETUP ---
    // 1. Follow the instructions to create a Google Apps Script Web App.
    // 2. Paste the Web App URL you get after deployment here.
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwIhYGTJSMuZZ-q9KuAhZm3Y5275kNP16UOEBQ8eJt_08-oaJi3-JF9OdQjN3SyF064/exec';

// --- User Authentication and Role Management ---

// ব্যবহারকারীদের নাম এবং পাসওয়ার্ড এখানে জমা থাকবে
const users = {
    "Admin": "admin123",
    "Viewer": "view123",
    "Data Entry": "data123"
};

let currentUserRole = null; // বর্তমানে কোন ব্যবহারকারী লগইন করেছে তা ট্র্যাক করার জন্য

// DOM Element References
const loginContainer = document.getElementById('login-container');
const appContainer = document.getElementById('app-container');
const loginError = document.getElementById('login-error');

    // --- DATA STORE (Local state, synced with Google Sheets) ---
    let appData = {
        items: [], vendors: [], departments: [], measures: [], gsts: [], miscItems: [],
        challans: [], requisitions: [], invoices: [],orders: [],
        nextId: {}, miscItemDefaults: {}
    };
    
    // ADD TO EXISTING VARIABLES
let orderCart = [];
let currentOrderPage = 1;
let currentSavedOrderPage = 1;
const ordersPerPage = 25; // Pagination limit set to 25
let editingOrderOriginalState = null;
    
    // --- Syncing & Debouncing Logic ---
    let syncTimeout;
    let retryTimeout;
    let retryCount = 0;
    const MAX_RETRIES = 5;
    const INITIAL_RETRY_DELAY = 2000; // 2 seconds
    const syncStatus = document.getElementById('syncStatus');

    let editingInvoiceOriginalState = null;
    let editingRequisitionOriginalState = null;
    let editingChallanOriginalState = null;
    
    // Pagination State
    let currentItemPage = 1;
    let currentMiscPage = 1;
    let currentManageMiscPage = 1;
    const manageMiscItemsPerPage = 70;
    let currentInvoicePage = 1;
    let currentRatePage = 1;
    let currentRequisitionPage = 1;
    const itemsPerPage = 25;
    const invoicesPerPage = 30;
    const ratesPerPage = 30;
    const requisitionsPerPage = 25;

    // Temporary storage for forms
    let tempChallanItems = [];
    let tempDirectInvoiceItems = [];
    let tempRequisitionItems = [];
    let tempSingleItemRequisitions = [];

    // --- DATA PERSISTENCE FUNCTIONS (GOOGLE SHEETS) ---
    function updateSyncStatus(status, message) {
        syncStatus.className = status;
        syncStatus.textContent = message;
    }

    async function loadData() {
        if (GOOGLE_SHEET_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
            updateSyncStatus('error', 'Configuration needed!');
            alert('Please configure the GOOGLE_SHEET_WEB_APP_URL in the script.');
            initializeDefaultData(); // Start with default data if not configured
            renderAll();
            return;
        }
        
        updateSyncStatus('loading', '🔄 Loading data...');
        try {
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            if (data && data.items && data.vendors && data.nextId) {
                appData = data;
                // Ensure all keys exist to prevent errors
                if (!appData.departments) appData.departments = [];
                if (!appData.measures) appData.measures = ['Pcs', 'Kg', 'Ltr', 'Box', 'Meter'];
                if (!appData.gsts) appData.gsts = [0, 5, 12, 18, 28];
                if (!appData.miscItems) appData.miscItems = [];
                if (!appData.challans) appData.challans = [];
                if (!appData.requisitions) appData.requisitions = [];
                if (!appData.invoices) appData.invoices = [];
                if (!appData.orders) appData.orders = [];
                if (!appData.miscItemDefaults) appData.miscItemDefaults = { code: 'M0002', stockPage: '155', purchPage: '53', unit: 'Pcs' };

            } else {
                initializeDefaultData();
            }
            console.log('Data loaded successfully from Google Sheet.');
            updateSyncStatus('synced', '✅ Synced');
        } catch (error) {
            console.error('Failed to load data from Google Sheet:', error);
            updateSyncStatus('error', '❌ Load failed');
            initializeDefaultData(); // Start with defaults if loading fails
        }
        renderAll();
    }
    
    function initializeDefaultData() {
        appData = {
            items: [], vendors: [], departments: [],
            measures: ['Pcs', 'Kg', 'Ltr', 'Box', 'Meter'],
            gsts: [0, 5, 12, 18, 28],
            miscItems: [], challans: [], requisitions: [], invoices: [],
            nextId: { item: 1, vendor: 1, department: 1, misc: 1, challan: 1, requisition: 1, invoice: 1 },
            miscItemDefaults: { code: 'M0002', stockPage: '155', purchPage: '53', unit: 'Pcs' }
        };
    }

    function saveData() {
        console.log("DEBUG: saveData() function called."); // DEBUG LOG
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(syncDataWithGoogleSheet, 1500); // Debounce
        updateSyncStatus('syncing', '🔄 Saving...');
    }

    async function syncDataWithGoogleSheet() {
        clearTimeout(retryTimeout);

        if (GOOGLE_SHEET_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
            console.error('Google Sheet URL is not configured.');
            updateSyncStatus('error', 'Configuration needed!');
            return;
        }

        try {
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', // Use no-cors for simple POST requests to Apps Script
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Send as plain text
                },
                body: JSON.stringify(appData)
            });
            
            console.log('Data sync initiated.');
            updateSyncStatus('synced', '✅ Synced');
            retryCount = 0;
        } catch (error) {
            console.error('Failed to sync data:', error);
            updateSyncStatus('error', `❌ Offline. Retrying... (${retryCount + 1})`);
            handleSyncError();
        }
    }

    function handleSyncError() {
        if (retryCount < MAX_RETRIES) {
            const delay = INITIAL_RETRY_DELAY * Math.pow(2, retryCount);
            retryCount++;
            retryTimeout = setTimeout(syncDataWithGoogleSheet, delay);
        } else {
            console.error('Max retries reached. Could not sync data.');
            updateSyncStatus('error', '❌ Sync failed. Check connection.');
        }
    }
    
    function getNextId(type) {
        if (!appData.nextId[type]) appData.nextId[type] = 1;
        return appData.nextId[type]++;
    }

    // --- UTILITY FUNCTIONS ---
    // This new function converts date formats like DD/MM/YYYY to YYYY-MM-DD
function formatDateToYYYYMMDD(dateString) {
    if (!dateString || typeof dateString !== 'string') return '';
    
    // Check if it's already in the correct format
    if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dateString;
    }
    
    // Split the date by '/' and rearrange it
    const parts = dateString.split('/');
    if (parts.length === 3) {
        const [day, month, year] = parts;
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }
    
    // Fallback for other formats, though unlikely
    const dateObj = new Date(dateString);
    if (!isNaN(dateObj.getTime())) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    return ''; // Return empty if conversion fails
}
    
    function populateDropdown(selectElement, data, useObject = false, key = 'name', valueKey = 'name') {
        if (!selectElement) return;
        selectElement.innerHTML = '';
        data.forEach(item => {
            const value = useObject ? item[valueKey] : item;
            const text = useObject ? item[key] : (selectElement.id.includes('Gst') ? `${item}%` : item);
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            selectElement.appendChild(option);
        });
    }

    
    
    
    
function populateItemDatalist() {
    const itemListData = document.getElementById('itemListData');
    if (itemListData) {
        const sortedItems = [...appData.items].sort((a, b) => a.name.localeCompare(b.name));
        // নিচের লাইনে backticks (`) যোগ করা হয়েছে
        const optionsHtml = sortedItems.map(item => `<option value="${item.name}"></option>`).join('');
        itemListData.innerHTML = optionsHtml;
    }
}

    function populateAllDropdowns() {
        populateItemDatalist();
        
  {
    const miscListData = document.getElementById('miscListData');
    if (miscListData) {
        const sortedItems = [...appData.miscItems].sort((a, b) => a.name.localeCompare(b.name));
        // নিচের লাইনে backticks (`) যোগ করা হয়েছে
        const optionsHtml = sortedItems.map(item => `<option value="${item.name}"></option>`).join('');
        miscListData.innerHTML = optionsHtml;
    }
}
       
        populateDropdown(document.getElementById('unitMeasure'), appData.measures);
        populateDropdown(document.getElementById('miscDefaultUnit'), appData.measures);
        populateDropdown(document.getElementById('challanMiscUnit'), appData.measures);
        populateDropdown(document.getElementById('directInvoiceMiscUnit'), appData.measures);
        populateDropdown(document.getElementById('challanVendorName'), appData.vendors, true);
        populateDropdown(document.getElementById('directInvoiceVendorName'), appData.vendors, true);
        populateDropdown(document.getElementById('reqDepartment'), appData.departments, true);
        populateDropdown(document.getElementById('directInvoiceGst'), appData.gsts);
        
        const ledgerItemSelect = document.getElementById('ledgerItemSelect');
        if (ledgerItemSelect) {
            populateDropdown(ledgerItemSelect, [...appData.items].sort((a,b) => a.name.localeCompare(b.name)), true, 'name', 'id');
        }
    }
    
    function toggleMiscItem(prefix, isModal = false, modalId = '') {
        const checkboxId = isModal ? `edit${modalId}MiscCheckbox` : `${prefix}MiscCheckbox`;
        const isChecked = document.getElementById(checkboxId).checked;
        
        const storeInputId = isModal ? `edit${modalId}ItemName` : `${prefix}ItemName`;
        const miscInputId = isModal ? `edit${modalId}MiscItemName` : `${prefix}MiscItemName`;
        const detailsBoxId = isModal ? `edit${modalId}ItemDetails` : `${prefix}ItemDetails`;
        const miscUnitGroupId = `${prefix}MiscUnitGroup`; // New ID for the unit dropdown container

        document.getElementById(storeInputId).classList.toggle('hidden', isChecked);
        document.getElementById(miscInputId).classList.toggle('hidden', !isChecked);
        
        // Show/hide the misc unit dropdown
        const miscUnitGroup = document.getElementById(miscUnitGroupId);
        if(miscUnitGroup) {
            miscUnitGroup.classList.toggle('hidden', !isChecked);
        }

        document.getElementById(storeInputId).value = '';
        document.getElementById(miscInputId).value = '';
        document.getElementById(detailsBoxId).style.display = 'none';
    }
    

// REPLACE your old function with this new one
function updateMiscItemStock(itemName, qtyChange, unit = appData.miscItemDefaults.unit) {
    let miscItem = appData.miscItems.find(mi => mi.name.toLowerCase() === itemName.toLowerCase());
    if (miscItem) {
        miscItem.stock += qtyChange;
    } else if (qtyChange > 0) {
        // Now creates the new misc item with the correct unit you selected
        appData.miscItems.push({
            id: getNextId('misc'),
            name: itemName,
            stock: qtyChange,
            unit: unit 
        });
    }
}


    
    function toggleRequisitionItemType(prefix) {
        const itemType = document.querySelector(`input[name="${prefix}ItemType"]:checked`).value;
        const itemSelect = document.getElementById(`${prefix}ItemName`);
        
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="">-- Select an Item --</option>'; 
        
        let sourceData = [];
        if (itemType === 'store') {
            sourceData = appData.items.filter(i => i.stock > 0);
        } else {
            sourceData = appData.miscItems.filter(i => i.stock > 0);
        }

        sourceData.sort((a, b) => a.name.localeCompare(b.name));

        sourceData.forEach(item => {
            const option = document.createElement('option');
            option.value = item.name;
            option.textContent = item.name;
            itemSelect.appendChild(option);
        });

        document.getElementById(`${prefix}ItemDetails`).style.display = 'none';
        
        const slipNoInput = document.getElementById('reqSlipNo');
        if (slipNoInput) {
             slipNoInput.value = '';
             formatReqSlipNo(slipNoInput);
        }
    }


    // --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => { loginContainer.classList.remove('hidden'); appContainer.classList.add('hidden');
});

function renderAll() {
    populateYearDropdown();
    filterItemList();
    
    
    populateAllDropdowns(); 
    populateMiscDatalist();
    
    populateInvoiceFilters();
    populateRequisitionFilters();
    renderVendorList();
    renderDepartmentList();
    renderMeasureList();
    renderGstList();
    filterMiscItemsLog();
    toggleRequisitionItemType('req');
    renderSavedChallans();
    filterInvoiceList();
    filterRequisitionList();
    renderLowStockItems();
    renderMiscDefaultsForm();
    updateLastReqInfo();
}

function populateAllDropdowns() {
    populateItemDatalist(); // এটি আইটেম লিস্ট লোড করে
    
    // ভেন্ডর, ইউনিট এবং ডিপার্টমেন্ট লোড করা
    populateDropdown(document.getElementById('unitMeasure'), appData.measures);
    populateDropdown(document.getElementById('miscDefaultUnit'), appData.measures);
    populateDropdown(document.getElementById('challanMiscUnit'), appData.measures);
    populateDropdown(document.getElementById('directInvoiceMiscUnit'), appData.measures);
    
    populateDropdown(document.getElementById('challanVendorName'), appData.vendors, true);
    populateDropdown(document.getElementById('directInvoiceVendorName'), appData.vendors, true);
    populateDropdown(document.getElementById('reqDepartment'), appData.departments, true);
    populateDropdown(document.getElementById('directInvoiceGst'), appData.gsts);
    
    const ledgerItemSelect = document.getElementById('ledgerItemSelect');
    if (ledgerItemSelect) {
        populateDropdown(ledgerItemSelect, [...appData.items].sort((a,b) => a.name.localeCompare(b.name)), true, 'name', 'id');
    }
}

// এই ফাংশনটি মিসিং থাকার কারণে লগইন আটকাচ্ছিল
function populateMiscDatalist() {
    const miscListData = document.getElementById('miscListData');
    if (miscListData) {
        const sortedItems = [...appData.miscItems].sort((a, b) => a.name.localeCompare(b.name));
        const optionsHtml = sortedItems.map(item => `<option value="${item.name}"></option>`).join('');
        miscListData.innerHTML = optionsHtml;
    }
}

    // --- TAB & SUB-TAB NAVIGATION ---
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function openSubTab(evt, subTabName, mainTabId) {
        const subTabContent = document.getElementById(mainTabId).getElementsByClassName("sub-tab-content");
        for (let i = 0; i < subTabContent.length; i++) {
            subTabContent[i].classList.remove('active');
        }
        const subTabLinks = document.getElementById(mainTabId).getElementsByClassName("sub-tab-button");
        for (let i = 0; i < subTabLinks.length; i++) {
            subTabLinks[i].classList.remove('active');
        }
        document.getElementById(subTabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    // --- MODAL (POP-UP) CONTROLS ---
    function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        if (modalId === 'editInvoiceModal') editingInvoiceOriginalState = null;
        if (modalId === 'editRequisitionModal') editingRequisitionOriginalState = null;
        if (modalId === 'editChallanModal') editingChallanOriginalState = null;
    }
    
    // --- ITEM MANAGEMENT & PAGINATION ---
    document.getElementById('sameAsStockPage').addEventListener('change', function() {
        if (this.checked) {
            const stockPageNo = document.getElementById('stockPageNo').value;
            document.getElementById('purchPageNo').value = stockPageNo;
        } else {
            document.getElementById('purchPageNo').value = '';
        }
    });

    function saveItem() {
        const newItem = {
            id: getNextId('item'),
            name: document.getElementById('itemName').value.trim(),
            code: document.getElementById('itemCode').value.trim(),
            stockPage: document.getElementById('stockPageNo').value,
            purchPage: document.getElementById('purchPageNo').value,
            stock: 0,
            unit: document.getElementById('unitMeasure').value,
            reorderLevel: parseInt(document.getElementById('reorderLevel').value) || 0
        };

        if (!newItem.name || !newItem.code) {
            alert('Item Name and Code are required.');
            return;
        }
        appData.items.push(newItem);
        saveData();
        alert('Item Saved Successfully!');
        document.getElementById('addItemForm').reset();
        renderAll();
    }
    
    function renderItemList(itemsToRender) {
        const listBody = document.getElementById('itemListBody');
        if (!listBody) return;
        listBody.innerHTML = ''; 
        
        const start = (currentItemPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = itemsToRender.slice(start, end);

        paginatedItems.forEach(item => {
            const isLowStock = item.stock <= (item.reorderLevel || 0) && item.reorderLevel > 0;
            const rowClass = isLowStock ? 'low-stock-warning' : '';
            const row = `
                <tr data-item-name="${item.name.toLowerCase()}" class="${rowClass}">
                    <td>${item.name}</td>
                    <td>${item.code}</td>
                    <td>${item.stockPage}</td>
                    <td>${item.purchPage}</td>
                    <td><strong>${item.stock}</strong></td>
                    <td>${item.reorderLevel || 0}</td>
                    <td>${item.unit}</td>
                    <td>
    <button class="btn-link action-btn" onclick="editItem(${item.id})">Edit</button>
    <button class="btn-link btn-danger action-btn" onclick="deleteItem(${item.id})">Delete</button>
</td>
                </tr>
            `;
            listBody.innerHTML += row;
        });
       reapplyPermissionsOnRender(); 
    }
    

    function renderPagination(filteredItems, controlsId, changePageFn, itemsPerPageCount, currentPageVar) {
        const paginationControls = document.getElementById(controlsId);
        paginationControls.innerHTML = '';
        const pageCount = Math.ceil(filteredItems.length / itemsPerPageCount);
        
        if (pageCount <= 1) return;

        paginationControls.innerHTML += `<button class="pagination-btn" onclick="${changePageFn.name}(${currentPageVar - 1})" ${currentPageVar === 1 ? 'disabled' : ''}>Previous</button>`;
        for (let i = 1; i <= pageCount; i++) {
            paginationControls.innerHTML += `<button class="pagination-btn ${i === currentPageVar ? 'active' : ''}" onclick="${changePageFn.name}(${i})">${i}</button>`;
        }
        paginationControls.innerHTML += `<button class="pagination-btn" onclick="${changePageFn.name}(${currentPageVar + 1})" ${currentPageVar === pageCount ? 'disabled' : ''}>Next</button>`;
    }

    function changeItemPage(page) {
        currentItemPage = page;
        filterItemList();
    }

    function filterItemList() {
        const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
        let filteredItems = [...appData.items].sort((a,b) => a.name.localeCompare(b.name));
        if (searchTerm) {
            filteredItems = appData.items.filter(item => item.name.toLowerCase().includes(searchTerm) || item.code.toLowerCase().includes(searchTerm));
        }
        
        renderItemList(filteredItems);
        renderPagination(filteredItems, 'paginationControls', changeItemPage, itemsPerPage, currentItemPage);
    }
    
    function renderLowStockItems() {
        const listBody = document.getElementById('lowStockListBody');
        if (!listBody) return;
        
        const lowStockItems = appData.items
            .filter(item => item.stock <= (item.reorderLevel || 0) && item.reorderLevel > 0)
            .sort((a, b) => a.name.localeCompare(b.name));
            
        listBody.innerHTML = '';
        if (lowStockItems.length === 0) {
            listBody.innerHTML = '<tr><td colspan="5">No items are currently low on stock.</td></tr>';
            return;
        }

        lowStockItems.forEach(item => {
            const row = `
                <tr class="low-stock-warning">
                    <td>${item.name}</td>
                    <td>${item.code}</td>
                    <td><strong>${item.stock}</strong></td>
                    <td>${item.reorderLevel || 0}</td>
                    <td>${item.unit}</td>
                </tr>
            `;
            listBody.innerHTML += row;
        });
    }

    function editItem(id) {
        const item = appData.items.find(i => i.id === id);
        if (item) {
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemCode').value = item.code;
            document.getElementById('editStockPageNo').value = item.stockPage;
            document.getElementById('editPurchPageNo').value = item.purchPage;
            document.getElementById('editCurrentStock').value = item.stock;
            document.getElementById('editReorderLevel').value = item.reorderLevel || 0;
            
            const editUnitMeasure = document.getElementById('editUnitMeasure');
            populateDropdown(editUnitMeasure, appData.measures);
            editUnitMeasure.value = item.unit;
            openModal('editItemModal');
        }
    }
    
    function updateItem() {
        const id = parseInt(document.getElementById('editItemId').value);
        const itemIndex = appData.items.findIndex(i => i.id === id);
        if (itemIndex > -1) {
            appData.items[itemIndex].name = document.getElementById('editItemName').value.trim();
            appData.items[itemIndex].code = document.getElementById('editItemCode').value.trim();
            appData.items[itemIndex].stockPage = document.getElementById('editStockPageNo').value;
            appData.items[itemIndex].purchPage = document.getElementById('editPurchPageNo').value;
            appData.items[itemIndex].unit = document.getElementById('editUnitMeasure').value;
            appData.items[itemIndex].reorderLevel = parseInt(document.getElementById('editReorderLevel').value) || 0;
            appData.items[itemIndex].stock = parseInt(document.getElementById('editCurrentStock').value) || 0;
        }
        saveData();
        closeModal('editItemModal');
        renderAll();
        alert('Item updated!');
    }


    function deleteItem(id) {
        if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
            appData.items = appData.items.filter(i => i.id !== id);
            saveData();
            renderAll();
        }
    }
    
    function updateAllPurchPageNumbers() {
        const newPageNo = document.getElementById('newGlobalPurchPageNo').value;
        if (!newPageNo) {
            alert('Please enter a new page number.');
            return;
        }
        if (confirm(`Are you sure you want to update ALL items' purchase page number to ${newPageNo}?`)) {
            appData.items.forEach(item => {
                item.purchPage = newPageNo;
            });
            saveData();
            filterItemList();
            closeModal('updateAllPurchPageModal');
            alert('All purchase page numbers updated.');
        }
    }
    
    function importItemsFromExcel() {
        const fileInput = document.getElementById('excelFileInput');
        if (fileInput.files.length === 0) {
            alert('Please select an Excel file to import.');
            return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                let importedCount = 0;
                json.forEach(row => {
                    if (row['Item Name'] && row['Item Code']) {
                        appData.items.push({
                            id: getNextId('item'),
                            name: String(row['Item Name']),
                            code: String(row['Item Code']),
                            stockPage: String(row['Stock Page No.'] || ''),
                            purchPage: String(row['Purch. Page No.'] || ''),
                            stock: 0,
                            unit: String(row['Unit Measure'] || 'Pcs'),
                            reorderLevel: parseInt(row['Reorder Level']) || 0
                        });
                        importedCount++;
                    }
                });
                saveData();
                renderAll();
                alert(`${importedCount} items imported successfully!`);
            } catch (e) {
                console.error("Error reading Excel file:", e);
                alert("Error reading file. Please ensure it's a valid Excel file and the format is correct.");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function updateItemsFromExcel() {
        const fileInput = document.getElementById('excelUpdateFileInput');
        if (fileInput.files.length === 0) {
            alert('Please select an Excel file.');
            return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                let updatedCount = 0;

                json.forEach(row => {
                    const itemCode = String(row['Item Code']);
                    if (!itemCode) return;

                    const itemIndex = appData.items.findIndex(item => item.code === itemCode);
                    if (itemIndex > -1) {
                        if (row['Item Name']) appData.items[itemIndex].name = String(row['Item Name']);
                        if (row['Stock Page No.']) appData.items[itemIndex].stockPage = String(row['Stock Page No.']);
                        if (row['Purch. Page No.']) appData.items[itemIndex].purchPage = String(row['Purch. Page No.']);
                        if (row['Unit Measure']) appData.items[itemIndex].unit = String(row['Unit Measure']);
                        if (row['Reorder Level'] !== undefined) appData.items[itemIndex].reorderLevel = parseInt(row['Reorder Level']) || 0;
                        updatedCount++;
                    }
                });

                saveData();
                renderAll();
                alert(`${updatedCount} items updated successfully from Excel file.`);
            } catch (e) {
                console.error("Error updating from Excel:", e);
                alert("An error occurred. Please check the file format and content.");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // --- MISCELLANEOUS ITEMS ---
    function renderMiscDefaultsForm() {
        document.getElementById('miscDefaultCode').value = appData.miscItemDefaults.code;
        document.getElementById('miscDefaultStockPage').value = appData.miscItemDefaults.stockPage;
        document.getElementById('miscDefaultPurchPage').value = appData.miscItemDefaults.purchPage;
        document.getElementById('miscDefaultUnit').value = appData.miscItemDefaults.unit;
    }
    
    function saveMiscDefaults() {
        appData.miscItemDefaults.code = document.getElementById('miscDefaultCode').value.trim();
        appData.miscItemDefaults.stockPage = document.getElementById('miscDefaultStockPage').value.trim();
        appData.miscItemDefaults.purchPage = document.getElementById('miscDefaultPurchPage').value.trim();
        appData.miscItemDefaults.unit = document.getElementById('miscDefaultUnit').value.trim();
        saveData();
        alert('Miscellaneous item defaults saved successfully!');
    }

 
 // PASTE AND REPLACE THIS ENTIRE FUNCTION (Step 3)
function renderMiscItemsLog(logEntries) {
    const listBody = document.getElementById('miscItemListBody');
    listBody.innerHTML = '';

    const start = (currentMiscPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedItems = logEntries.slice(start, end);

    if (paginatedItems.length === 0) {
        listBody.innerHTML = '<tr><td colspan="9">No miscellaneous items found.</td></tr>';
        return;
    }

    paginatedItems.forEach(entry => {
        // Determine the Type label color and text
        let typeClass = '';
        let typeText = entry.type;
        if (entry.type === 'Purchased') {
            typeClass = 'label-green';
        } else if (entry.type === 'Supplied') {
            typeClass = 'label-normal-blue';
        } else if (entry.type === 'Issued') {
            typeClass = 'label-red';
            typeText = 'Issued';
        }

        listBody.innerHTML += `
            <tr>
                <td>${entry.name}</td>
                <td class="${typeClass}"><strong>${typeText}</strong></td>
                <td>${entry.qty}</td>
                <td>${entry.unit}</td>
                <td>${entry.rate !== undefined ? entry.rate.toFixed(2) : 'N/A'}</td>
                <td>${entry.source}<br>(${entry.sourceType})</td>
                <td>${formatDateToDDMMYYYY(entry.date)}</td>
                <td>${entry.transactionDetails}</td>
                <td>
    <button class="btn-link action-btn" onclick="openTransactionSource('${entry.id}')">Update</button>
    <button class="btn-link btn-danger action-btn" onclick="deleteMiscTransaction('${entry.id}')">Delete</button>
</td>
            </tr>`;
    });
    reapplyPermissionsOnRender();
}
 

//----MISC ITEM LOG VIEW----
// PASTE AND REPLACE THIS ENTIRE FUNCTION
// PASTE AND REPLACE THIS ENTIRE FUNCTION
function filterMiscItemsLog() {
    const searchTerm = document.getElementById('miscItemSearch').value.toLowerCase();
    let log = [];

    // Process Invoices (Purchased)
    appData.invoices.forEach(inv => {
        inv.items.forEach((item, index) => {
            if (item.isMisc) {
                let challanDetails = '';
                if (inv.challans && inv.challans.length > 0) {
                    challanDetails = inv.challans.map(c => `CH. NO.-${c.number} (Date:${formatDateToDDMMYYYY(c.date)})`).join('<br>') + '<br>';
                }
                const invoiceDetails = `INV.NO.-${inv.number} (Date:${formatDateToDDMMYYYY(inv.date)})`;

                log.push({
                    id: `inv-${inv.id}-${index}`,
                    name: item.name, type: 'Purchased', qty: item.qty, unit: item.unit, rate: item.rate,
                    source: inv.vendor,
                    sourceType: 'Vendor',
                    date: inv.date, 
                    transactionDetails: challanDetails + invoiceDetails
                });
            }
        });
    });

    // Process Pending Challans (Supplied)
    appData.challans.forEach(c => {
        if (c.status === 'pending') {
             c.items.forEach((item, index) => {
                if (item.isMisc) {
                    log.push({
                        id: `challan-${c.id}-${index}`,
                        name: item.name, type: 'Supplied', qty: item.qty, unit: item.unit, rate: undefined,
                        source: c.vendor,
                        sourceType: 'Vendor',
                        date: c.date, 
                        transactionDetails: `CH. NO.-${c.number} (Date:${formatDateToDDMMYYYY(c.date)})`
                    });
                }
            });
        }
    });

    // Process Requisitions (Issued)
    appData.requisitions.forEach(req => {
        req.items.forEach((item, index) => {
            if (item.isMisc) {
                log.push({
                    id: `req-${req.id}-${index}`,
                    name: item.name, type: 'Issued', qty: item.qty, unit: item.unit, rate: undefined,
                    source: req.department,
                    sourceType: 'Department',
                    date: req.date, 
                    transactionDetails: `${req.slipNo} (Req Date:${formatDateToDDMMYYYY(req.date)})`
                });
            }
        });
    });

    let filteredLog = log.filter(entry => entry.name.toLowerCase().includes(searchTerm) || entry.source.toLowerCase().includes(searchTerm));

    // Sorting logic to group items and order transactions
    filteredLog.sort((a, b) => {
        // 1. Primary Sort: By Item Name (A-Z)
        const nameA = a.name.toLowerCase();
        const nameB = b.name.toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;

        // 2. Secondary Sort: By Type (Supplied/Purchased first, then Issued)
        const typeWeight = { 'Supplied': 1, 'Purchased': 1, 'Issued': 2 };
        const weightA = typeWeight[a.type] || 3;
        const weightB = typeWeight[b.type] || 3;
        if (weightA < weightB) return -1;
        if (weightA > weightB) return 1;

        // 3. Tertiary Sort: By Date (Oldest to Newest)
        return new Date(a.date) - new Date(b.date);
    });

    renderMiscItemsLog(filteredLog);
    renderPagination(filteredLog, 'miscPaginationControls', changeMiscPage, itemsPerPage, currentMiscPage);
}
    function changeMiscPage(page) {
        currentMiscPage = page;
        filterMiscItemsLog();
    }
    
    function openTransactionSource(logId) {
        const [type, transactionIdStr] = logId.split('-');
        const transactionId = parseInt(transactionIdStr);

        switch(type) {
            case 'inv': editInvoice(transactionId); break;
            case 'challan': editChallan(transactionId); break;
            case 'req': editRequisition(transactionId); break;
            default: alert("Could not find the source of this transaction.");
        }
    }

    function deleteMiscTransaction(logId) {
        if (!confirm("Are you sure you want to delete this miscellaneous item transaction? This will reverse the stock change and cannot be undone.")) return;

        const [type, transactionId, itemIndex] = logId.split('-');
        const id = parseInt(transactionId);
        const index = parseInt(itemIndex);

        let transaction, stockChangeSign = 0;

        if (type === 'inv') {
            transaction = appData.invoices.find(inv => inv.id === id); stockChangeSign = -1;
        } else if (type === 'challan') {
            transaction = appData.challans.find(c => c.id === id); stockChangeSign = -1;
        } else if (type === 'req') {
            transaction = appData.requisitions.find(r => r.id === id); stockChangeSign = 1;
        }

        if (transaction && transaction.items[index]) {
            const item = transaction.items[index];
            updateMiscItemStock(item.name, item.qty * stockChangeSign);
            transaction.items.splice(index, 1);
            if (type === 'inv') {
                transaction.totalAmount = transaction.items.reduce((sum, i) => sum + (i.qty * i.rate * (1 + i.gst / 100)), 0);
            }
            saveData();
            renderAll();
            alert("Transaction item deleted and stock adjusted.");
        } else {
            alert("Error: Could not find the transaction item to delete.");
        }
    }
    
    // --- RATE OF ITEMS (NEW LIVE REPORT) ---
    function getLiveRates() {
        const latestRates = new Map();
        const sortedInvoices = [...appData.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));

        for (const invoice of sortedInvoices) {
            for (const item of invoice.items) {
                const key = `${item.name}|${invoice.vendor}`;
                if (!latestRates.has(key)) {
                    latestRates.set(key, {
                        itemName: item.name,
                        rateWithGst: (item.rate * (1 + item.gst / 100)).toFixed(2),
                        vendorName: invoice.vendor
                    });
                }
            }
        }
        return Array.from(latestRates.values()).sort((a,b) => a.itemName.localeCompare(b.itemName));
    }
    
    function changeRatePage(page) {
        currentRatePage = page;
        renderLiveRateReport();
    }

    function renderLiveRateReport() {
        const rates = getLiveRates();
        const body = document.getElementById('liveRateListBody');
        const searchTerm = document.getElementById('liveRateSearch').value.toLowerCase();
        
        body.innerHTML = '';
        let filteredRates = rates;
        if (searchTerm) {
            filteredRates = rates.filter(r => r.itemName.toLowerCase().includes(searchTerm) || r.vendorName.toLowerCase().includes(searchTerm));
        }
        
        const start = (currentRatePage - 1) * ratesPerPage;
        const end = start + ratesPerPage;
        const paginatedRates = filteredRates.slice(start, end);
        
        if (paginatedRates.length === 0) {
            body.innerHTML = '<tr><td colspan="3">No rates found in invoice history.</td></tr>';
            renderPagination([], 'ratePaginationControls', changeRatePage, ratesPerPage, currentRatePage);
            return;
        }

        paginatedRates.forEach(rate => {
            body.innerHTML += `<tr data-search-term="${rate.itemName.toLowerCase()} ${rate.vendorName.toLowerCase()}"><td>${rate.itemName}</td><td>${rate.rateWithGst}</td><td>${rate.vendorName}</td></tr>`;
        });
        
        renderPagination(filteredRates, 'ratePaginationControls', changeRatePage, ratesPerPage, currentRatePage);
    }
    
    // --- FIX FOR DIRECT INVOICE ---
function fetchRateForDirectInvoice() {
    const itemName = document.getElementById('directInvoiceItemName').value;
    const vendorName = document.getElementById('directInvoiceVendorName').value;

    if (!itemName || !vendorName) return;

    // পূর্বের ভুল লজিকটি পরিবর্তন করে সঠিক লুপ ব্যবহার করা হয়েছে
    let foundRate = 0;
    let foundGst = 0;

    // সব ইনভয়েস চেক করা হচ্ছে
    // আমরা উল্টো দিক থেকে চেক করব যাতে লেটেস্ট রেট পাওয়া যায়
    for (let i = appData.invoices.length - 1; i >= 0; i--) {
        const inv = appData.invoices[i];
        if (inv.vendor === vendorName) {
            const foundItem = inv.items.find(item => item.name.toLowerCase() === itemName.toLowerCase());
            if (foundItem) {
                foundRate = foundItem.rate;
                foundGst = foundItem.gst;
                break; // লেটেস্ট রেট পাওয়া গেছে, লুপ থামান
            }
        }
    }

    if (foundRate > 0) {
        document.getElementById('directInvoiceRate').value = foundRate;
        // GST ড্রপডাউন সিলেক্ট করা
        const gstSelect = document.getElementById('directInvoiceGst');
        if (gstSelect) {
            gstSelect.value = foundGst;
        }
        calculateDirectInvoiceItemValue();
    }
}


    // --- PURCHASE MANAGEMENT (CHALLAN) ---
    function showChallanItemDetails() {
        const isMisc = document.getElementById('challanMiscCheckbox').checked;
        const itemName = isMisc ? document.getElementById('challanMiscItemName').value : document.getElementById('challanItemName').value;
        const detailsBox = document.getElementById('challanItemDetails');

        if (!itemName) {
            detailsBox.style.display = 'none';
            return;
        }
        
        if (isMisc) {
            const miscItem = appData.miscItems.find(mi => mi.name.toLowerCase() === itemName.toLowerCase());
            const currentStock = miscItem ? miscItem.stock : 0;
            detailsBox.innerHTML = `
                <div><span class="label-normal-blue">ITEM CODE:</span> ${appData.miscItemDefaults.code}</div>
                <div><span class="label-red">STOCK PAGE NO:</span> ${appData.miscItemDefaults.stockPage}</div>
                <div><span class="label-violet">PURCH. PAGE NO:</span> ${appData.miscItemDefaults.purchPage}</div>
                <div><span class="label-green">CURRENT STOCK:</span> <span id="challanCurrentStockValue">${currentStock}</span></div>
            `;
            detailsBox.style.display = 'grid';
            calculateChallanNewStock();
        } else {
            const item = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
            if (item) {
                detailsBox.innerHTML = `
                    <div><span class="label-normal-blue">ITEM CODE:</span> ${item.code}</div>
                    <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage}</div>
                    <div><span class="label-violet">PURCH. PAGE NO:</span> ${item.purchPage}</div>
                    <div><span class="label-green">CURRENT STOCK:</span> <span id="challanCurrentStockValue">${item.stock}</span></div>
                `;
                detailsBox.style.display = 'grid';
                calculateChallanNewStock();
            } else {
                detailsBox.style.display = 'none';
            }
        }
    }

    function calculateChallanNewStock() {
        const currentStockEl = document.getElementById('challanCurrentStockValue');
        if (!currentStockEl) return;
        const currentStock = parseInt(currentStockEl.innerText);
        const suppliedQty = parseInt(document.getElementById('challanSuppliedQty').value) || 0;
        document.getElementById('challanNewStockResult').innerText = `New Stock: ${currentStock + suppliedQty}`;
    }
    
    function addItemToChallan() {
    // 1. Validation Check (NEW)
    if (!validateOrderQty('challan')) {
        alert("Error: Supplied quantity exceeds the Remaining Order quantity.");
        return;
    }
    
    // 2. Original Logic with Order Link
    const isMisc = document.getElementById('challanMiscCheckbox').checked;
    const itemName = (isMisc ? document.getElementById('challanMiscItemName').value : document.getElementById('challanItemName').value).trim();
    const suppliedQty = parseInt(document.getElementById('challanSuppliedQty').value);
    // Get Selected Order ID
    const orderRefId = document.getElementById('challanOrderRef').value; 

    if (!itemName || !suppliedQty || suppliedQty <= 0) {
        alert('Please select/enter an item and a valid quantity.');
        return;
    }
    
    const itemDetails = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    const unit = isMisc ? document.getElementById('challanMiscUnit').value : itemDetails.unit;
    const item = itemDetails ? {...itemDetails} : { id: null, name: itemName, code: appData.miscItemDefaults.code };

    tempChallanItems.push({
        itemId: item.id, 
        name: item.name, 
        code: item.code, 
        qty: suppliedQty, 
        unit: unit, 
        isMisc: !itemDetails,
        orderRefId: orderRefId // SAVE THE ORDER LINK
    });

    renderTempChallanItems();
    
    // Reset fields
    document.getElementById('challanItemName').value = '';
    document.getElementById('challanMiscItemName').value = '';
    document.getElementById('challanSuppliedQty').value = 0;
    document.getElementById('challanItemDetails').style.display = 'none';
    document.getElementById('challanNewStockResult').innerText = '';
    
    // Reset Order Dropdown
    document.getElementById('challanOrderRef').value = ''; 
    document.getElementById('challanOrderRefGroup').style.display = 'none';
}
    function renderTempChallanItems() {
        const tableBody = document.getElementById('challanItemsTableBody');
        tableBody.innerHTML = '';
        tempChallanItems.forEach((item, index) => {
            tableBody.innerHTML += `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.code}</td>
                    <td>${item.qty}</td>
                    <td>${item.unit}</td>
                    <td><button class="btn-link" onclick="removeTempChallanItem(${index})">Remove</button></td>
                </tr>
            `;
        });
    }

    function removeTempChallanItem(index) {
        tempChallanItems.splice(index, 1);
        renderTempChallanItems();
    }


// REPLACE your old function with this new one
function saveChallan() {
    const challanNumber = document.getElementById('challanNumber').value.trim();
    const challanDate = document.getElementById('challanDate').value;
    const vendorName = document.getElementById('challanVendorName').value;

    if (!challanNumber || !challanDate || !vendorName || tempChallanItems.length === 0) {
        alert('Please fill all challan details and add at least one item.');
        return;
    }

    const newChallan = {
        id: getNextId('challan'), number: challanNumber, date: challanDate,
        vendor: vendorName, items: [...tempChallanItems], status: 'pending'
    };

    appData.challans.push(newChallan);

    newChallan.items.forEach(challanItem => {
        if (challanItem.isMisc) {
            // This line is updated to pass the correct unit
            updateMiscItemStock(challanItem.name, challanItem.qty, challanItem.unit);
        } else {
            const itemInDb = appData.items.find(i => i.id === challanItem.itemId);
            if (itemInDb) itemInDb.stock += challanItem.qty;
        }
    });
    
    saveData();
    alert('Challan saved successfully and stock updated!');
    clearChallanForm();
    renderAll();
}


    function clearChallanForm() {
        document.getElementById('challanEntryForm').reset();
        tempChallanItems = [];
        renderTempChallanItems();
    }

    function renderSavedChallans() {
        const body = document.getElementById('savedChallansBody');
        body.innerHTML = '';
        const pendingChallans = appData.challans.filter(c => c.status === 'pending').sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if (pendingChallans.length === 0) {
            body.innerHTML = '<tr><td colspan="6">No pending challans found.</td></tr>';
            return;
        }

        pendingChallans.forEach(c => {
            const itemsSummary = c.items.map(i => `${i.name} (x${i.qty})`).join(', ');
            body.innerHTML += `
                <tr>
                    <td><input type="checkbox" class="challan-checkbox" value="${c.id}" data-vendor="${c.vendor}"></td>
                    <td>${c.number}</td>
                    <td>${formatDateToDDMMYYYY(c.date)}</td>
                    <td>${c.vendor}</td>
                    <td>${itemsSummary}</td>
                    <td>
                        <button class="btn-link" onclick="viewChallan(${c.id})">View</button>
                        <button class="btn-link" onclick="editChallan(${c.id})">Edit</button>
                        <button class="btn-link btn-danger" onclick="deleteChallan(${c.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    function deleteChallan(id) {
    // ডিলিট করার আগে ওয়ার্নিং মেসেজ
    if (!confirm('Are you sure you want to delete this challan? Note: Stock will REMAIN THE SAME (Not Reduced).')) return;
    
    const challanIndex = appData.challans.findIndex(c => c.id === id);
    if (challanIndex > -1) {
        // --- স্টক কমানোর লজিকটি এখানে বন্ধ (OFF) করে দেওয়া হয়েছে ---
        /*
        const challanToDelete = appData.challans[challanIndex];
        challanToDelete.items.forEach(challanItem => {
            if (challanItem.isMisc) {
                updateMiscItemStock(challanItem.name, -challanItem.qty);
            } else {
                const itemInDb = appData.items.find(i => i.id === challanItem.itemId);
                if (itemInDb) itemInDb.stock -= challanItem.qty;
            }
        });
        */
        // -------------------------------------------------------

        appData.challans.splice(challanIndex, 1);
        saveData(); // ডাটা সেভ হবে
        renderAll(); // পেজ রিফ্রেশ হবে
        alert('Challan deleted. Stock quantity remained unchanged.');
    }
}

    function prepareUpdateToInvoice() {
        const selectedCheckboxes = document.querySelectorAll('.challan-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one challan.');
            return;
        }

        const firstVendor = selectedCheckboxes[0].dataset.vendor;
        const selectedChallanIds = [];
        
        for (const checkbox of selectedCheckboxes) {
            if (checkbox.dataset.vendor !== firstVendor) {
                alert('You can only select challans from the same vendor.');
                return;
            }
            selectedChallanIds.push(parseInt(checkbox.value));
        }

        const challansToInvoice = appData.challans.filter(c => selectedChallanIds.includes(c.id));
        const allItems = challansToInvoice.flatMap(c => c.items);
        
        const aggregatedItems = allItems.reduce((acc, item) => {
            const existing = acc.find(i => i.name === item.name);
            if (existing) {
                existing.qty += item.qty;
            } else {
                acc.push({ ...item });
            }
            return acc;
        }, []);

        const modalBody = document.getElementById('updateToInvoiceModalBody');
        const challanNumbers = challansToInvoice.map(c => c.number).join(', ');

        modalBody.innerHTML = `
            <div class="form-grid">
                <div class="form-group"><label>Vendor</label><input type="text" id="challanToInvoiceVendor" value="${firstVendor}" readonly></div>
                <div class="form-group"><label>Selected Challans</label><input type="text" value="${challanNumbers}" readonly></div>
                <div class="form-group"><label>Invoice Number</label><input type="text" id="invoiceNumberModal"></div>
                <div class="form-group"><label>Invoice Date</label><input type="date" id="invoiceDateModal"></div>
            </div> <hr> <h4>Items to Invoice</h4>
            <div class="modal-table-container">
                <table class="data-table">
                    <thead><tr><th>Item</th><th>Total Qty</th><th>Rate</th><th>GST %</th><th>Value</th></tr></thead>
                    <tbody id="invoiceItemsModalBody"></tbody>
                </table>
            </div>
            <h3 class="mt-20">Total Invoice Amount: <span id="totalInvoiceAmountModal">0.00</span></h3>
            <div class="mt-20">
                <button class="btn btn-primary" onclick="saveInvoiceFromChallans(${JSON.stringify(selectedChallanIds)})">Save to Invoice</button>
            </div>
        `;
        
        const invoiceItemsBody = document.getElementById('invoiceItemsModalBody');
        let gstOptions = appData.gsts.map(g => `<option value="${g}">${g}%</option>`).join('');
        const liveRates = getLiveRates();

        aggregatedItems.forEach((item, index) => {
            const liveRateInfo = liveRates.find(r => r.itemName === item.name && r.vendorName === firstVendor);
            let rate = 0, gst = 0;
            
            if (liveRateInfo) {
                // --- FIX: Correctly finding the previous invoice item ---
                const previousInvoice = appData.invoices.find(inv => 
                    inv.vendor === firstVendor && 
                    inv.items.some(i => i.name === item.name)
                );

                if (previousInvoice) {
                    const foundItem = previousInvoice.items.find(i => i.name === item.name);
                    if (foundItem) {
                        rate = foundItem.rate;
                        gst = foundItem.gst;
                    }
                }
                // --- END FIX ---
            }

            invoiceItemsBody.innerHTML += `
                <tr>
                    <td>${item.name}</td> <td>${item.qty}</td>
                    <td><input type="number" class="invoice-rate" value="${rate}" oninput="calculateInvoiceTotal()" data-index="${index}"></td>
                    <td><select class="invoice-gst" onchange="calculateInvoiceTotal()" data-index="${index}">${gstOptions}</select></td>
                    <td class="invoice-value">0.00</td>
                </tr>
            `;
             // Safely set GST value
             const gstSelect = invoiceItemsBody.querySelector(`select[data-index="${index}"]`);
             if(gstSelect) gstSelect.value = gst;
        });
        calculateInvoiceTotal();
        openModal('updateToInvoiceModal');
    }

    function calculateInvoiceTotal() {
        let total = 0;
        const rows = document.querySelectorAll('#invoiceItemsModalBody tr');
        rows.forEach(row => {
            const qty = parseFloat(row.cells[1].innerText);
            const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
            const gst = parseFloat(row.querySelector('.invoice-gst').value) || 0;
            const value = qty * rate * (1 + gst / 100);
            row.cells[4].innerText = value.toFixed(2);
            total += value;
        });
        document.getElementById('totalInvoiceAmountModal').innerText = total.toFixed(2);
    }
    

// REPLACE your old saveInvoiceFromChallans function with this new one
function saveInvoiceFromChallans(challanIds) {
    const invoiceNumber = document.getElementById('invoiceNumberModal').value.trim();
    const invoiceDate = document.getElementById('invoiceDateModal').value;
    const vendorName = document.getElementById('challanToInvoiceVendor').value;

    if (!invoiceNumber || !invoiceDate) {
        alert('Please provide Invoice Number and Date.'); return;
    }

    const relatedChallans = appData.challans.filter(c => challanIds.includes(c.id));
    challanIds.forEach(id => { const challan = appData.challans.find(c => c.id === id); if (challan) challan.status = 'invoiced'; });
    
    const invoiceItems = [];
    document.querySelectorAll('#invoiceItemsModalBody tr').forEach(row => {
        const name = row.cells[0].innerText;
        const itemDetails = appData.items.find(i => i.name === name);
        const isMisc = !itemDetails;
        
        // --- START OF FIX ---
        // This new logic finds the correct unit for both store and misc items.
        let unit = '';
        if (isMisc) {
            // For misc items, find its record or use the default unit.
            const miscItem = appData.miscItems.find(mi => mi.name === name);
            unit = miscItem ? miscItem.unit : appData.miscItemDefaults.unit;
        } else {
            // For store items, get the unit from the main item list.
            unit = itemDetails.unit;
        }
        // --- END OF FIX ---

        invoiceItems.push({
            itemId: itemDetails ? itemDetails.id : null,
            name: name,
            qty: parseFloat(row.cells[1].innerText),
            unit: unit, // <-- The 'unit' is now correctly added here.
            rate: parseFloat(row.querySelector('.invoice-rate').value) || 0,
            gst: parseFloat(row.querySelector('.invoice-gst').value) || 0,
            isMisc: isMisc
        });
    });

    appData.invoices.push({
        id: getNextId('invoice'),
        number: invoiceNumber,
        date: invoiceDate,
        vendor: vendorName,
        items: invoiceItems,
        totalAmount: parseFloat(document.getElementById('totalInvoiceAmountModal').innerText),
        challans: relatedChallans.map(c => ({number: c.number, date: c.date}))
    });

    saveData();
    alert('Invoice created successfully!');
    closeModal('updateToInvoiceModal');
    renderSavedChallans();
    filterInvoiceList();
}

    
    // --- PURCHASE MANAGEMENT (DIRECT INVOICE) ---
    function addChallanInput() {
        const container = document.getElementById('challanInputsContainer');
        const newRow = document.createElement('div');
        newRow.className = 'challan-input-row';
        newRow.innerHTML = `
            <input type="text" placeholder="Challan Number" class="challan-number-input">
            <input type="date" class="challan-date-input">
            <button class="btn btn-danger btn-add-remove" onclick="this.parentElement.remove()">-</button>
        `;
        container.appendChild(newRow);
    }

    function showDirectInvoiceItemDetails() {
        const isMisc = document.getElementById('directInvoiceMiscCheckbox').checked;
        const itemName = isMisc ? document.getElementById('directInvoiceMiscItemName').value : document.getElementById('directInvoiceItemName').value;
        const detailsBox = document.getElementById('directInvoiceItemDetails');

        if (!itemName) { detailsBox.style.display = 'none'; return; }

        if (isMisc) {
            const miscItem = appData.miscItems.find(mi => mi.name.toLowerCase() === itemName.toLowerCase());
            const currentStock = miscItem ? miscItem.stock : 0;
            detailsBox.innerHTML = `
                <div><span class="label-normal-blue">ITEM CODE:</span> ${appData.miscItemDefaults.code}</div>
                <div><span class="label-red">STOCK PAGE NO:</span> ${appData.miscItemDefaults.stockPage}</div>
                <div><span class="label-violet">PURCH. PAGE NO:</span> ${appData.miscItemDefaults.purchPage}</div>
                <div><span class="label-green">CURRENT STOCK:</span> <span id="directInvoiceCurrentStockValue">${currentStock}</span></div>
            `;
            detailsBox.style.display = 'grid';
            calculateDirectInvoiceNewStock();
        } else {
            const item = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
            if (item) {
                detailsBox.innerHTML = `
                    <div><span class="label-normal-blue">ITEM CODE:</span> ${item.code}</div>
                    <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage}</div>
                    <div><span class="label-violet">PURCH. PAGE NO:</span> ${item.purchPage}</div>
                    <div><span class="label-green">CURRENT STOCK:</span> <span id="directInvoiceCurrentStockValue">${item.stock}</span></div>
                `;
                detailsBox.style.display = 'grid';
                calculateDirectInvoiceNewStock();
            } else {
                 detailsBox.style.display = 'none';
            }
        }
    }

    function calculateDirectInvoiceNewStock() {
        const currentStockEl = document.getElementById('directInvoiceCurrentStockValue');
        if (!currentStockEl) return;
        const currentStock = parseInt(currentStockEl.innerText);
        const suppliedQty = parseInt(document.getElementById('directInvoiceSuppliedQty').value) || 0;
        document.getElementById('directInvoiceNewStockResult').innerText = `New Stock: ${currentStock + suppliedQty}`;
    }
    
    function calculateDirectInvoiceItemValue() {
        const qty = parseFloat(document.getElementById('directInvoiceSuppliedQty').value) || 0;
        const rate = parseFloat(document.getElementById('directInvoiceRate').value) || 0;
        const gst = parseFloat(document.getElementById('directInvoiceGst').value) || 0;
        const value = qty * rate * (1 + gst / 100);
        document.getElementById('directInvoiceItemValue').innerText = `Item Value: ${value.toFixed(2)}`;
    }

    function addItemToDirectInvoice() {
     // 1. Validation Check
     if (!validateOrderQty('directInvoice')) {
        alert("Error: Supplied quantity exceeds the Remaining Order quantity.");
        return;
    }

    // 2. Original Logic
    const isMisc = document.getElementById('directInvoiceMiscCheckbox').checked;
    const itemName = (isMisc ? document.getElementById('directInvoiceMiscItemName').value : document.getElementById('directInvoiceItemName').value).trim();
    const qty = parseInt(document.getElementById('directInvoiceSuppliedQty').value);
    const rate = parseFloat(document.getElementById('directInvoiceRate').value);
    const gst = parseFloat(document.getElementById('directInvoiceGst').value);
    // Get Selected Order ID
    const orderRefId = document.getElementById('directInvoiceOrderRef').value; 
    
    if (!itemName || !qty || qty <= 0 || isNaN(rate) || isNaN(gst)) {
        alert('Please fill item name, quantity, rate, and GST.'); return;
    }
    
    const itemDetails = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    const unit = isMisc ? document.getElementById('directInvoiceMiscUnit').value : itemDetails.unit;
    const item = itemDetails ? {...itemDetails} : { id: null, name: itemName, code: appData.miscItemDefaults.code };
    const value = qty * rate * (1 + gst / 100);

    tempDirectInvoiceItems.push({
        itemId: item.id, 
        name: item.name, 
        qty, 
        unit, 
        rate, 
        gst, 
        value, 
        isMisc: !itemDetails,
        orderRefId: orderRefId // SAVE THE ORDER LINK
    });

    renderTempDirectInvoiceItems();
    updateDirectInvoiceTotalValue();
    
    // Reset Inputs
    document.getElementById('directInvoiceItemName').value = '';
    document.getElementById('directInvoiceMiscItemName').value = '';
    document.getElementById('directInvoiceSuppliedQty').value = 0;
    document.getElementById('directInvoiceRate').value = 0;
    document.getElementById('directInvoiceGst').value = appData.gsts[0] || 0;
    document.getElementById('directInvoiceItemDetails').style.display = 'none';
    document.getElementById('directInvoiceNewStockResult').innerText = '';
    document.getElementById('directInvoiceItemValue').innerText = '';

    // Reset Order Dropdown
    document.getElementById('directInvoiceOrderRef').value = ''; 
    document.getElementById('directInvoiceOrderRefGroup').style.display = 'none';
}
    function updateDirectInvoiceTotalValue() {
        const totalValue = tempDirectInvoiceItems.reduce((sum, item) => sum + item.value, 0);
        document.getElementById('directInvoiceTotalValue').innerText = `Total Value: ${totalValue.toFixed(2)}`;
    }

    function renderTempDirectInvoiceItems() {
        const tableBody = document.getElementById('directInvoiceItemsTableBody');
        tableBody.innerHTML = '';
        tempDirectInvoiceItems.forEach((item, index) => {
            tableBody.innerHTML += `
                <tr>
                    <td>${item.name}</td> <td>${item.qty}</td> <td>${item.unit}</td> <td>${item.rate.toFixed(2)}</td>
                    <td>${item.gst}%</td> <td>${item.value.toFixed(2)}</td>
                    <td><button class="btn-link" onclick="removeTempDirectInvoiceItem(${index})">Remove</button></td>
                </tr>
            `;
        });
    }

    function removeTempDirectInvoiceItem(index) {
        tempDirectInvoiceItems.splice(index, 1);
        renderTempDirectInvoiceItems();
        updateDirectInvoiceTotalValue();
    }


// REPLACE your old function with this new one
function saveDirectInvoice() {
    const invoiceNumber = document.getElementById('directInvoiceNumber').value.trim();
    const invoiceDate = document.getElementById('directInvoiceDate').value;
    const vendorName = document.getElementById('directInvoiceVendorName').value;
    
    const challanInputs = document.querySelectorAll('#challanInputsContainer .challan-input-row');
    const challansData = [];
    challanInputs.forEach(row => {
        const number = row.querySelector('.challan-number-input').value.trim();
        const date = row.querySelector('.challan-date-input').value;
        if (number && date) {
            challansData.push({ number, date });
        }
    });

    if (!invoiceNumber || !invoiceDate || !vendorName || tempDirectInvoiceItems.length === 0 || challansData.length === 0) {
        alert('Please fill all Invoice details, add at least one Challan, and add at least one item.'); return;
    }
    
    const newInvoice = {
        id: getNextId('invoice'), number: invoiceNumber, date: invoiceDate, vendor: vendorName,
        totalAmount: tempDirectInvoiceItems.reduce((sum, item) => sum + item.value, 0),
        items: [...tempDirectInvoiceItems], 
        challans: challansData
    };
    appData.invoices.push(newInvoice);

    newInvoice.items.forEach(invoiceItem => {
        if (invoiceItem.isMisc) {
            // This line is updated to pass the correct unit
            updateMiscItemStock(invoiceItem.name, invoiceItem.qty, invoiceItem.unit);
        } else {
            const itemInDb = appData.items.find(i => i.id === invoiceItem.itemId);
            if (itemInDb) itemInDb.stock += invoiceItem.qty;
        }
    });

    saveData();
    alert('Invoice saved successfully and stock updated!');
    clearDirectInvoiceForm();
    renderAll();
}



    function clearDirectInvoiceForm() {
        document.getElementById('directInvoiceForm').reset();
        const challanContainer = document.getElementById('challanInputsContainer');
        challanContainer.innerHTML = `
            <div class="challan-input-row">
                <input type="text" placeholder="Challan Number" class="challan-number-input">
                <input type="date" class="challan-date-input">
                <button class="btn btn-danger btn-add-remove" onclick="this.parentElement.remove()">-</button>
            </div>
        `;
        tempDirectInvoiceItems = [];
        renderTempDirectInvoiceItems();
        updateDirectInvoiceTotalValue();
    }
    
 // --- VIEW/EDIT SAVED INVOICES ---
 function renderSavedInvoices(invoicesToRender) {
    const listBody = document.getElementById('savedInvoicesBody');
    const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase().trim(); 
    
    if (!listBody) return;
    listBody.innerHTML = ''; 
    
    // 1. Calculate Pagination Slice (This logic handles the paging view)
    const start = (currentInvoicePage - 1) * invoicesPerPage;
    const end = start + invoicesPerPage;
    const paginatedInvoices = invoicesToRender.slice(start, end);

    if (paginatedInvoices.length === 0) {
        listBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No invoices found matching your criteria.</td></tr>';
        return;
    }

    // 2. Render only the invoices for the current page
    paginatedInvoices.forEach(inv => {
        // Apply Highlighting
        const displayInvNo = highlightText(inv.number, searchTerm);
        const displayVendor = highlightText(inv.vendor, searchTerm);

        const itemsSummary = inv.items.map(item => {
            const highlightedName = highlightText(item.name, searchTerm);
            return `${highlightedName} (x${item.qty})`;
        }).join(', ');

        let challanNumbers = 'N/A';
        let challanDates = 'N/A';

        if (inv.challans && inv.challans.length > 0) {
            challanNumbers = inv.challans.map(c => highlightText(c.number, searchTerm)).join('<br>');
            challanDates = inv.challans.map(c => formatDateToDDMMYYYY(c.date)).join('<br>');
        }

        listBody.innerHTML += `
            <tr>
                <td>${displayInvNo}</td>
                <td>${formatDateToDDMMYYYY(inv.date)}</td>
                <td>${displayVendor}</td>
                <td>${challanNumbers}</td>
                <td>${challanDates}</td>
                <td>${itemsSummary}</td>
                <td>${inv.totalAmount.toFixed(2)}</td>
                <td>
                    <button class="btn-link" onclick="viewInvoice(${inv.id})">View</button>
                    <button class="btn-link action-btn" onclick="editInvoice(${inv.id})">Edit</button>
                    <button class="btn-link btn-danger action-btn" onclick="deleteInvoice(${inv.id})">Delete</button>
                </td>
            </tr>
        `;
    });
    reapplyPermissionsOnRender();
}

function changeInvoicePage(page) {
    currentInvoicePage = page;
    filterInvoiceList();
}

function filterInvoiceList() {
    // 1. ALWAYS reset to Page 1 when a filter changes. 
    // This ensures you search the whole data and see the top results.
    currentInvoicePage = 1; 

    // 2. Get values from all filter controls
    const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase().trim();
    const selectedVendor = document.getElementById('invoiceFilterVendor').value;
    const itemType = document.getElementById('invoiceFilterItemType').value;
    const selectedStoreItemId = document.getElementById('invoiceFilterStoreItem').value;
    const startDate = document.getElementById('invoiceFilterStartDate').value;
    const endDate = document.getElementById('invoiceFilterEndDate').value;

    // Start with the WHOLE dataset
    let filteredInvoices = [...appData.invoices];

    // 3. Apply Text Search (Whole Data)
    if (searchTerm) {
        const tokens = searchTerm.split(/\s+/).filter(t => t.length > 0); 
        
        filteredInvoices = filteredInvoices.filter(inv => {
            // Combine all searchable text fields into one string
            const itemNames = inv.items.map(i => i.name).join(' ');
            const challanNumbers = (inv.challans || []).map(c => c.number).join(' ');
            
            const fullSearchableString = `
                ${inv.number} 
                ${inv.vendor} 
                ${itemNames} 
                ${challanNumbers}
            `.toLowerCase();

            // SMART SEARCH: Keep invoice only if ALL search words are found in it
            return tokens.every(token => fullSearchableString.includes(token));
        });
    }
    
    // 4. Apply Dropdown Filters (Whole Data)
    if (selectedVendor) {
        filteredInvoices = filteredInvoices.filter(inv => inv.vendor === selectedVendor);
    }
    if (startDate) {
        filteredInvoices = filteredInvoices.filter(inv => inv.date >= startDate);
    }
    if (endDate) {
        filteredInvoices = filteredInvoices.filter(inv => inv.date <= endDate);
    }
    if (itemType === 'store') {
        if (selectedStoreItemId) {
            const itemId = parseInt(selectedStoreItemId);
            filteredInvoices = filteredInvoices.filter(inv => inv.items.some(item => item.itemId === itemId && !item.isMisc));
        } else {
            filteredInvoices = filteredInvoices.filter(inv => inv.items.some(item => !item.isMisc));
        }
    } else if (itemType === 'misc') {
        filteredInvoices = filteredInvoices.filter(inv => inv.items.some(item => item.isMisc));
    }

    // 5. Sort the filtered list
    const sortedInvoices = filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // 6. Pass the WHOLE filtered/sorted list to the render function.
    // The render function handles the pagination slicing.
    renderSavedInvoices(sortedInvoices);
    
    // 7. Update pagination controls based on the filtered count
    renderPagination(sortedInvoices, 'invoicePaginationControls', changeInvoicePage, invoicesPerPage, currentInvoicePage);
}
    
function deleteInvoice(id) {
    if (!confirm('Are you sure you want to delete this invoice? This WILL revert stock changes and cannot be undone.')) return;
    
    const invoiceIndex = appData.invoices.findIndex(inv => inv.id === id);
    if (invoiceIndex > -1) {
        const invoiceToDelete = appData.invoices[invoiceIndex];

        invoiceToDelete.items.forEach(invItem => {
            if (invItem.isMisc) {
                updateMiscItemStock(invItem.name, -invItem.qty);
            } else {
                const itemInDb = appData.items.find(i => i.id === invItem.itemId);
                if (itemInDb) itemInDb.stock -= invItem.qty;
            }
        });

        if (invoiceToDelete.challanIds) {
            invoiceToDelete.challanIds.forEach(challanId => {
                const challan = appData.challans.find(c => c.id === challanId);
                if (challan) challan.status = 'pending';
            });
        }

        appData.invoices.splice(invoiceIndex, 1);
        saveData();
        renderAll();
        alert('Invoice deleted and stock reverted.');
    }
}

//----EDIT/UPDATE INVOICE----
// This is the only version of editInvoice that should be in your file.
function editInvoice(id) {
    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) return;

    editingInvoiceOriginalState = JSON.parse(JSON.stringify(invoice));
    const modalBody = document.getElementById('editInvoiceModalBody');
    let gstOptions = appData.gsts.map(g => `<option value="${g}">${g}%</option>`).join('');
    
    let challanHtml = '';
    if (invoice.challans && invoice.challans.length > 0) {
        challanHtml = invoice.challans.map(c => `
            <div class="challan-input-row">
                <input type="text" placeholder="Challan Number" class="challan-number-input" value="${c.number}">
                <input type="date" class="challan-date-input" value="${c.date}">
                <button class="btn btn-danger btn-add-remove" onclick="this.parentElement.remove()">-</button>
            </div>
        `).join('');
    }

    // Create the HTML for the modal
    modalBody.innerHTML = `
        <form id="editInvoiceForm" class="form-grid">
            <input type="hidden" id="editingInvoiceId" value="${invoice.id}">
            <div class="form-group"> <label>Invoice Number</label> <input type="text" id="editingInvoiceNumber" required> </div>
            <div class="form-group"> <label>Invoice Date</label> <input type="date" id="editingInvoiceDate" required> </div>
            <div class="form-group"> <label>Vendor</label> <select id="editingInvoiceVendor"></select> </div>
        </form>
        <div class="form-group"><label>Associated Challans</label><ul>${challanHtml}</ul></div>
        <hr>
        <h4>Edit Existing Items</h4>
        <div class="modal-table-container"> <table class="data-table"> <thead><tr><th>Item Name</th><th>Qty</th><th>Unit</th><th>Rate</th><th>GST %</th><th>Value</th><th>Action</th></tr></thead> <tbody id="editingInvoiceItemsTableBody"></tbody> </table> </div>
        <h3 id="editingInvoiceTotalValue" class="mt-20 label-red">Total Value: 0.00</h3>
        <hr>
        <h4>Add New Item to Invoice</h4>
        <div class="d-flex gap-10"> <input type="checkbox" id="editInvoiceMiscCheckbox" onchange="toggleMiscItem('editInvoice', true, 'Invoice')"> <label for="editInvoiceMiscCheckbox">Miscellaneous Item</label> </div>
        <div class="form-grid mt-20">
            <div class="form-group"> <label>SELECT/WRITE ITEM</label> <input type="text" id="editInvoiceItemName" list="itemListData" onchange="showEditInvoiceItemDetails()"> <input type="text" id="editInvoiceMiscItemName" class="hidden mt-20" placeholder="Enter Miscellaneous Item Name" oninput="showEditInvoiceItemDetails()"> </div>
            <div class="form-group"> <label>SUPPLIED QUANTITIES</label> <input type="number" id="editInvoiceSuppliedQty" value="0" oninput="calculateEditInvoiceNewStock(); calculateEditInvoiceItemValue();"> </div>
            <div id="editInvoiceMiscUnitGroup" class="form-group hidden"><label>UNIT MEASURE</label><select id="editInvoiceMiscUnit"></select></div>
            <div class="form-group"> <label>RATE</label> <input type="number" id="editInvoiceRate" value="0" oninput="calculateEditInvoiceItemValue()"> </div>
            <div class="form-group"> <label>GST %</label> <div class="d-flex"> <select id="editInvoiceGst" class="w-100" onchange="calculateEditInvoiceItemValue()">${gstOptions}</select> </div></div>
        </div>
        <div class="item-details-box" style="margin-top:0;">
             <span id="editInvoiceNewStockResult" class="calculated-value"></span>
             <span id="editInvoiceItemValue" class="calculated-value label-green" style="text-align: right;"></span>
        </div>
        <div id="editInvoiceItemDetails" class="item-details-box" style="display:none;"></div>
        <button type="button" class="btn btn-secondary mt-20" onclick="addItemToInvoiceInEdit()">ADD ITEM</button>
        <hr>
        <div class="mt-20"> <button class="btn btn-primary" onclick="updateInvoice()">UPDATE INVOICE</button> <button class="btn btn-clear" onclick="closeModal('editInvoiceModal')">CANCEL</button> </div>
    `;
    
    // Set the values AFTER the HTML has been created.
    document.getElementById('editingInvoiceNumber').value = invoice.number;
    document.getElementById('editingInvoiceDate').value = formatDateToYYYYMMDD(invoice.date);
    
    const vendorDropdown = document.getElementById('editingInvoiceVendor');
    populateDropdown(vendorDropdown, appData.vendors, true);
    vendorDropdown.value = invoice.vendor;
    populateDropdown(document.getElementById('editInvoiceMiscUnit'), appData.measures);
    
    renderEditingInvoiceItems();
    openModal('editInvoiceModal');
}

function renderEditingInvoiceItems() {
    const tableBody = document.getElementById('editingInvoiceItemsTableBody');
    const gstOptions = appData.gsts.map(g => `<option value="${g}">${g}%</option>`).join('');
    
    const rowsHtml = editingInvoiceOriginalState.items.map((item, index) => {
        const value = (item.qty * item.rate * (1 + item.gst / 100)).toFixed(2);
        return `
            <tr data-index="${index}" data-name="${item.name}">
                <td>${item.name}</td>
                <td><input type="number" class="editing-qty" value="${item.qty}" oninput="calculateEditingInvoiceValue(${index})"></td>
                <td>${item.unit}</td> 
                <td><input type="number" class="editing-rate" value="${item.rate}" oninput="calculateEditingInvoiceValue(${index})"></td>
                <td><select class="editing-gst" onchange="calculateEditingInvoiceValue(${index})">${gstOptions}</select></td>
                <td class="editing-value">${value}</td>
                <td><button class="btn-link btn-danger" onclick="removeEditingInvoiceItem(${index})">Remove</button></td>
            </tr>
        `;
    }).join('');

    tableBody.innerHTML = rowsHtml;

    editingInvoiceOriginalState.items.forEach((item, index) => {
        const row = tableBody.querySelector(`tr[data-index="${index}"]`);
        if (row) {
            const gstSelect = row.querySelector('.editing-gst');
            if (gstSelect) {
                gstSelect.value = item.gst;
            }
        }
    });

    calculateEditingInvoiceTotal();
}
    
function calculateEditingInvoiceValue(index) {
    const row = document.querySelector(`#editingInvoiceItemsTableBody tr[data-index="${index}"]`);
    const qty = parseFloat(row.querySelector('.editing-qty').value) || 0;
    const rate = parseFloat(row.querySelector('.editing-rate').value) || 0;
    const gst = parseFloat(row.querySelector('.editing-gst').value) || 0;
    const value = qty * rate * (1 + gst / 100);
    row.querySelector('.editing-value').innerText = value.toFixed(2);
    calculateEditingInvoiceTotal();
}
    
function calculateEditingInvoiceTotal() {
    let total = 0;
    document.querySelectorAll('#editingInvoiceItemsTableBody tr').forEach(row => {
        total += parseFloat(row.querySelector('.editing-value').innerText) || 0;
    });
    document.getElementById('editingInvoiceTotalValue').innerText = `Total Value: ${total.toFixed(2)}`;
}

function removeEditingInvoiceItem(index) {
    editingInvoiceOriginalState.items.splice(index, 1);
    renderEditingInvoiceItems();
}


// This is the only version of updateInvoice that should be in your file.
function updateInvoice() {
    const invoiceId = parseInt(document.getElementById('editingInvoiceId').value);
    const invoiceInDbIndex = appData.invoices.findIndex(inv => inv.id === invoiceId);
    if (invoiceInDbIndex === -1) return;

    const originalInvoiceBeforeEdit = JSON.parse(JSON.stringify(appData.invoices.find(i => i.id === invoiceId)));
    if (!originalInvoiceBeforeEdit) { alert("Error: Could not find original invoice state."); return; }
    
    const originalItems = originalInvoiceBeforeEdit.items;
    const updatedItemsFromModal = [];
    
    editingInvoiceOriginalState.items.forEach((item, index) => {
         const row = document.querySelector(`#editingInvoiceItemsTableBody tr[data-index="${index}"]`);
         if (row) {
            updatedItemsFromModal.push({
                ...item,
                qty: parseFloat(row.querySelector('.editing-qty').value) || 0,
                rate: parseFloat(row.querySelector('.editing-rate').value) || 0,
                gst: parseFloat(row.querySelector('.editing-gst').value) || 0,
            });
         } else { 
            updatedItemsFromModal.push(item);
         }
    });
    
    const originalQtyMap = new Map(originalItems.map(item => [(item.isMisc ? `misc-${item.name}` : `store-${item.itemId}`), item.qty]));
    const updatedQtyMap = new Map(updatedItemsFromModal.map(item => [(item.isMisc ? `misc-${item.name}` : `store-${item.itemId}`), item.qty]));
    const allItemKeys = new Set([...originalQtyMap.keys(), ...updatedQtyMap.keys()]);

    allItemKeys.forEach(key => {
        const difference = (updatedQtyMap.get(key) || 0) - (originalQtyMap.get(key) || 0);
        if (difference === 0) return;
        const isMisc = key.startsWith('misc-');
        if (isMisc) {
            updateMiscItemStock(key.replace('misc-', ''), difference);
        } else {
            const itemInStock = appData.items.find(i => i.id === parseInt(key.replace('store-', '')));
            if (itemInStock) itemInStock.stock += difference;
        }
    });

    const invoiceToUpdate = appData.invoices[invoiceInDbIndex];
    invoiceToUpdate.number = document.getElementById('editingInvoiceNumber').value;
    invoiceToUpdate.date = document.getElementById('editingInvoiceDate').value;
    invoiceToUpdate.vendor = document.getElementById('editingInvoiceVendor').value;
    invoiceToUpdate.items = updatedItemsFromModal.map(item => ({...item, value: item.qty * item.rate * (1 + item.gst / 100)}));
    invoiceToUpdate.totalAmount = invoiceToUpdate.items.reduce((sum, item) => sum + item.value, 0);

    saveData();
    alert('Invoice updated successfully! Stock has been adjusted.');
    closeModal('editInvoiceModal');
    renderAll();
}


//----VIEW INVOICE---
function viewInvoice(id) {
    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) return;
    
    let challanHtml = '';
    if (invoice.challans && invoice.challans.length > 0) {
        // --- FIX IS HERE: Added formatDateToDDMMYYYY() ---
        challanHtml = invoice.challans.map(c => `<li>${c.number} (${formatDateToDDMMYYYY(c.date)})</li>`).join('');
    }

    let itemsHtml = invoice.items.map(item => {
        const value = item.qty * item.rate * (1 + item.gst / 100);
        return `<tr><td>${item.name}</td><td>${item.isMisc ? appData.miscItemDefaults.code : (appData.items.find(i=>i.id === item.itemId)?.code || 'N/A')}</td><td>${item.qty}</td><td>${item.rate.toFixed(2)}</td><td>${item.gst}%</td><td>${value.toFixed(2)}</td></tr>`;
    }).join('');

    document.getElementById('viewInvoiceModalBody').innerHTML = `
        <div class="form-grid">
            <div class="form-group"><label>Invoice Number</label><p><strong>${invoice.number}</strong></p></div>
            <div class="form-group"><label>Invoice Date</label><p><strong>${formatDateToDDMMYYYY(invoice.date)}</strong></p></div>
            <div class="form-group"><label>Vendor</label><p><strong>${invoice.vendor}</strong></p></div>
        </div>
        <div class="form-group"><label>Associated Challans</label><ul>${challanHtml}</ul></div>
        <hr> <h4>Invoice Items</h4>
        <div class="modal-table-container"> <table class="data-table"> <thead><tr><th>Item Name</th><th>Code</th><th>Qty</th><th>Rate</th><th>GST</th><th>Value</th></tr></thead> <tbody>${itemsHtml}</tbody> </table> </div>
        <h3 class="mt-20 label-red">Total Amount: ${invoice.totalAmount.toFixed(2)}</h3>
    `;
    openModal('viewInvoiceModal');
}

function showEditInvoiceItemDetails() {
    const isMisc = document.getElementById('editInvoiceMiscCheckbox').checked;
    const itemName = isMisc ? document.getElementById('editInvoiceMiscItemName').value : document.getElementById('editInvoiceItemName').value;
    const detailsBox = document.getElementById('editInvoiceItemDetails');

    if (!itemName) { detailsBox.style.display = 'none'; return; }

    if (isMisc) {
        const miscItem = appData.miscItems.find(mi => mi.name.toLowerCase() === itemName.toLowerCase());
        detailsBox.innerHTML = `
            <div><span class="label-normal-blue">ITEM CODE:</span> ${appData.miscItemDefaults.code}</div>
            <div><span class="label-red">STOCK PAGE NO:</span> ${appData.miscItemDefaults.stockPage}</div>
            <div><span class="label-violet">PURCH. PAGE NO:</span> ${appData.miscItemDefaults.purchPage}</div>
            <div><span class="label-green">CURRENT STOCK:</span> <span id="editInvoiceCurrentStockValue">${miscItem ? miscItem.stock : 0}</span></div>
        `;
    } else {
        const item = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        if (item) {
            detailsBox.innerHTML = `
                <div><span class="label-normal-blue">ITEM CODE:</span> ${item.code}</div>
                <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage}</div>
                <div><span class="label-violet">PURCH. PAGE NO:</span> ${item.purchPage}</div>
                <div><span class="label-green">CURRENT STOCK:</span> <span id="editInvoiceCurrentStockValue">${item.stock}</span></div>
            `;
        } else { detailsBox.style.display = 'none'; return; }
    }
    detailsBox.style.display = 'grid';
    calculateEditInvoiceNewStock();
}

function calculateEditInvoiceNewStock() {
    const currentStockEl = document.getElementById('editInvoiceCurrentStockValue');
    if (!currentStockEl) return;
    const currentStock = parseInt(currentStockEl.innerText);
    const suppliedQty = parseInt(document.getElementById('editInvoiceSuppliedQty').value) || 0;
    const resultEl = document.getElementById('editInvoiceNewStockResult');
    if(resultEl) {
        resultEl.innerText = `New Stock: ${currentStock + suppliedQty}`;
    }
}

function addItemToInvoiceInEdit() {
    const isMisc = document.getElementById('editInvoiceMiscCheckbox').checked;
    const itemName = (isMisc ? document.getElementById('editInvoiceMiscItemName').value : document.getElementById('editInvoiceItemName').value).trim();
    const qty = parseInt(document.getElementById('editInvoiceSuppliedQty').value);
    const rate = parseFloat(document.getElementById('editInvoiceRate').value);
    const gst = parseFloat(document.getElementById('editInvoiceGst').value);
    
    if (!itemName || qty <= 0 || isNaN(rate) || isNaN(gst)) {
        alert('Please fill item name, quantity, rate, and GST.'); return;
    }
    if (editingInvoiceOriginalState.items.some(i => i.name === itemName)) {
        alert('This item is already in the invoice. Edit the quantity in the table above.'); return;
    }
    
    const itemDetails = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    const unit = isMisc ? document.getElementById('editInvoiceMiscUnit').value : itemDetails?.unit;
    
    if (!itemDetails && !isMisc) {
        alert('Item not found. Please select a valid item.'); return;
    }

    editingInvoiceOriginalState.items.push({
        itemId: itemDetails?.id || null, 
        name: itemName, 
        qty, 
        unit,
        rate, 
        gst, 
        isMisc
    });

    renderEditingInvoiceItems();

    document.getElementById('editInvoiceItemName').value = '';
    document.getElementById('editInvoiceMiscItemName').value = '';
    document.getElementById('editInvoiceSuppliedQty').value = 0;
    document.getElementById('editInvoiceRate').value = 0;
    document.getElementById('editInvoiceGst').value = appData.gsts[0] || 0;
}

    // --- ISSUE REQUISITION (REGULAR) ---
    function formatReqSlipNo(input) {
        const itemType = document.querySelector('input[name="reqItemType"]:checked')?.value;
        if (itemType === 'misc') {
            if (!input.value.startsWith('RD-')) input.value = 'RD-' + input.value.replace(/^R-|^RD-/, '');
        } else {
            let numericPart = input.value.replace('R-', '').replace(/[^0-9]/g, '');
            input.value = numericPart ? 'R-' + numericPart : '';
        }
    }

    function showReqItemDetails() {
        const itemType = document.querySelector('input[name="reqItemType"]:checked').value;
        const isMisc = itemType === 'misc';
        const itemName = document.getElementById('reqItemName').value;
        const detailsBox = document.getElementById('reqItemDetails');
        
        if (!itemName) { detailsBox.style.display = 'none'; return; }

        const itemSource = isMisc ? appData.miscItems : appData.items;
        const item = itemSource.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        
        if (item) {
             if (item.stock <= 0) {
                 alert('This item is out of stock.');
                 document.getElementById('reqItemName').value = '';
                 detailsBox.style.display = 'none'; return;
             }
            detailsBox.innerHTML = isMisc ?
                `<div><span class="label-normal-blue">ITEM CODE:</span> ${appData.miscItemDefaults.code}</div> <div><span class="label-green">CURRENT STOCK:</span> <span id="reqCurrentStockValue">${item.stock}</span></div>` :
                `<div><span class="label-normal-blue">ITEM CODE:</span> ${item.code || 'N/A'}</div> <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage || 'N/A'}</div> <div><span class="label-violet">PURCH. PAGE NO:</span> ${item.purchPage || 'N/A'}</div> <div><span class="label-green">CURRENT STOCK:</span> <span id="reqCurrentStockValue">${item.stock}</span></div>`;
            detailsBox.style.display = 'grid';
            calculateReqNewStock();
        } else {
            detailsBox.style.display = 'none';
        }
    }

    function calculateReqNewStock() {
        const currentStockEl = document.getElementById('reqCurrentStockValue');
        if (!currentStockEl) return;
        const currentStock = parseInt(currentStockEl.innerText);
        const issuedQty = parseInt(document.getElementById('reqIssuedQty').value) || 0;

        if (issuedQty > currentStock) {
            document.getElementById('reqNewStockResult').innerText = `Error: Not enough stock!`;
            document.getElementById('reqNewStockResult').style.color = 'red';
        } else {
            document.getElementById('reqNewStockResult').innerText = `New Stock: ${currentStock - issuedQty}`;
            document.getElementById('reqNewStockResult').style.color = 'var(--text-red)';
        }
    }

    function addItemToRequisition() {
        const isMisc = document.querySelector('input[name="reqItemType"]:checked').value === 'misc';
        const itemName = document.getElementById('reqItemName').value.trim();
        const issuedQty = parseInt(document.getElementById('reqIssuedQty').value);
        
        if (!itemName || !issuedQty || issuedQty <= 0) {
            alert('Please select/enter an item and a valid quantity.'); return;
        }
        
        const itemSource = isMisc ? appData.miscItems : appData.items;
        const itemDetails = itemSource.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        
        if (!itemDetails) { alert('Item not found.'); return; }
        if (issuedQty > itemDetails.stock) { alert('Cannot issue more than the current stock.'); return; }
        
        tempRequisitionItems.push({
            itemId: itemDetails.id, name: itemDetails.name,
            code: itemDetails.code || appData.miscItemDefaults.code, qty: issuedQty, isMisc: isMisc,
            unit: itemDetails.unit || appData.miscItemDefaults.unit
        });

        renderTempRequisitionItems();
        document.getElementById('reqItemName').value = '';
        document.getElementById('reqIssuedQty').value = 0;
        document.getElementById('reqItemDetails').style.display = 'none';
        document.getElementById('reqNewStockResult').innerText = '';
    }


// REPLACE your old renderTempRequisitionItems function with this new one
function renderTempRequisitionItems() {
    const tableBody = document.getElementById('requisitionItemsTableBody');
    tableBody.innerHTML = '';
    tempRequisitionItems.forEach((item, index) => {
        tableBody.innerHTML += `
            <tr>
                <td>${index + 1}</td>
                <td>${item.name}</td>
                <td>${item.code}</td>
                <td>${item.qty}</td>
                <td>${item.unit}</td>
                <td><button class="btn-link" onclick="removeTempRequisitionItem(${index})">Remove</button></td>
            </tr>
        `;
    });
}

    function removeTempRequisitionItem(index) {
        tempRequisitionItems.splice(index, 1);
        renderTempRequisitionItems();
    }

    
// REPLACE THIS ENTIRE FUNCTION
function saveRequisition() {
    console.log("--- Starting saveRequisition ---");
    try {
        // 1. Validate DOM Elements exist
        const reqDateEl = document.getElementById('reqDate');
        const reqSlipNoEl = document.getElementById('reqSlipNo');
        const reqDeptEl = document.getElementById('reqDepartment');

        if (!reqDateEl || !reqSlipNoEl || !reqDeptEl) {
            alert("Error: Form elements not found. Please refresh the page.");
            return;
        }

        const reqDate = reqDateEl.value;
        const reqSlipNoRaw = reqSlipNoEl.value.trim();
        const department = reqDeptEl.value;
        
        // 2. Validate Input Data
        if (!reqDate || !reqSlipNoRaw || !department) {
            alert('Please fill all requisition details (Date, Slip No, Department).');
            return;
        }
        if (!tempRequisitionItems || tempRequisitionItems.length === 0) {
            alert('Please add at least one item to the requisition.');
            return;
        }

        // 3. Safe Duplicate Check (Prevents crash if appData is loading)
        if (appData && appData.requisitions) {
            const isDuplicate = appData.requisitions.some(req => 
                req && req.slipNo && String(req.slipNo).toLowerCase() === reqSlipNoRaw.toLowerCase()
            );

            if (isDuplicate) {
                alert(`⚠️ Error: Requisition Slip Number "${reqSlipNoRaw}" already exists!`);
                return; 
            }
        } else {
            console.warn("appData.requisitions is missing, skipping duplicate check.");
            if(!appData) appData = { requisitions: [], items: [], miscItems: [], nextId: {} };
            if(!appData.requisitions) appData.requisitions = [];
        }
        
        // 4. Create New Object
        const newRequisition = {
            id: getNextId('requisition'),
            slipNo: reqSlipNoRaw,
            date: reqDate,
            department: department,
            items: [...tempRequisitionItems], // Copy array to prevent reference issues
            type: 'Regular'
        };
        
        appData.requisitions.push(newRequisition);

        // 5. Stock Update (Safe Mode)
        newRequisition.items.forEach(reqItem => {
            if (reqItem.isMisc) {
                // Ensure name exists before updating
                if(reqItem.name) {
                    updateMiscItemStock(reqItem.name, -reqItem.qty);
                }
            } else {
                // Find item safely
                const itemInDb = appData.items.find(i => i.id === reqItem.itemId);
                if (itemInDb) {
                    itemInDb.stock -= reqItem.qty;
                } else {
                    console.warn(`Stock update skipped: Item ID ${reqItem.itemId} not found in database.`);
                }
            }
        });

        // 6. Save and Refresh
        saveData();
        
        alert('Requisition saved successfully and stock updated!');
        clearRequisitionForm();
        renderAll();
        
        // Safe UI Update
        if(typeof updateLastReqInfo === "function") {
            updateLastReqInfo(); 
        }

    } catch (error) {
        console.error("Critical Error in saveRequisition:", error);
        // This will now show you the REAL error reason
        alert("Error Details: " + error.message); 
    }
}


function clearRequisitionForm() {
    // 1. Reset the main form inputs (Date, Slip No, Dept)
    document.getElementById('requisitionEntryForm').reset();
    
    // 2. Clear the temporary items array
    tempRequisitionItems = [];
    
    // 3. Refresh the table (it will now be empty)
    renderTempRequisitionItems();
    
    // 4. Hide the stock details box and clear calculated text
    document.getElementById('reqItemDetails').style.display = 'none';
    document.getElementById('reqNewStockResult').innerText = '';
    
    // 5. Reset the "Select Item" dropdown based on the default radio button
    toggleRequisitionItemType('req'); 
}
    // --- LEGACY REQUISITION (SINGLE ITEM) ---
    function initializeLegacySingleItemEntry() {
        const itemDropdown = document.getElementById('legacySingleItemSelect');
        const sortedItems = [...appData.items].sort((a,b) => a.name.localeCompare(b.name));
        populateDropdown(itemDropdown, [{ id: '', name: '-- প্রথমে একটি আইটেম নির্বাচন করুন --' }, ...sortedItems], true, 'name', 'id');
        
        const deptDropdown = document.getElementById('legacySingleReqDepartment');
        populateDropdown(deptDropdown, appData.departments, true);
        
        clearLegacySingleItemForm();
    }
    
    function clearLegacySingleItemForm() {
        tempSingleItemRequisitions = [];
        document.getElementById('legacySingleItemSelect').disabled = false;
        document.getElementById('legacySingleItemSelect').value = '';
        document.getElementById('legacySingleItemDetails').style.display = 'none';
        document.getElementById('legacySingleReqEntryOverlay').style.display = 'block';
        document.getElementById('legacySingleReqDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('legacySingleReqSlipNo').value = '';
        document.getElementById('legacySingleReqIssuedQty').value = 0;
        renderLegacySingleReqTable();
    }
    
    function selectLegacySingleItem() {
        const itemId = parseInt(document.getElementById('legacySingleItemSelect').value);
        const detailsBox = document.getElementById('legacySingleItemDetails');
        if (!itemId) {
            clearLegacySingleItemForm();
            return;
        }
        
        document.getElementById('legacySingleItemSelect').disabled = true;
        document.getElementById('legacySingleReqEntryOverlay').style.display = 'none';
        
        updateLegacySingleItemStockDisplay();
        detailsBox.style.display = 'grid';
    }

    function updateLegacySingleItemStockDisplay() {
        const itemId = parseInt(document.getElementById('legacySingleItemSelect').value);
        if (!itemId) return;
        
        const item = appData.items.find(i => i.id === itemId);
        const totalIssuedInList = tempSingleItemRequisitions.reduce((sum, req) => sum + req.qty, 0);
        const effectiveStock = item.stock - totalIssuedInList;
        
        const detailsBox = document.getElementById('legacySingleItemDetails');
        detailsBox.innerHTML = `
            <div><span class="label-normal-blue">ITEM CODE:</span> ${item.code}</div>
            <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage}</div>
            <div><span class="label-green">CURRENT STOCK:</span> <strong>${effectiveStock}</strong> <span style="font-size:12px;">(Original: ${item.stock})</span></div>
        `;
    }
    
    function formatLegacyReqSlipNo(input) {
        let numericPart = input.value.replace('R-', '').replace(/[^0-9]/g, '');
        input.value = numericPart ? 'R-' + numericPart : '';
    }

    function addLegacySingleReqToList() {
        const itemId = parseInt(document.getElementById('legacySingleItemSelect').value);
        const item = appData.items.find(i => i.id === itemId);
        const date = document.getElementById('legacySingleReqDate').value;
        const slipNo = document.getElementById('legacySingleReqSlipNo').value.trim();
        const department = document.getElementById('legacySingleReqDepartment').value;
        const issuedQty = parseInt(document.getElementById('legacySingleReqIssuedQty').value);
        
        if (!date || !slipNo || !department || !issuedQty || issuedQty <= 0) {
            alert('Please provide Date, Slip No., Quantity, and Department.');
            return;
        }

        const totalIssuedInList = tempSingleItemRequisitions.reduce((sum, req) => sum + req.qty, 0);
        const effectiveStock = item.stock - totalIssuedInList;
        
        if (issuedQty > effectiveStock) {
            alert(`Error: Cannot issue ${issuedQty}. Only ${effectiveStock} available.`);
            return;
        }
        
        tempSingleItemRequisitions.push({
            date, slipNo, department, qty: issuedQty
        });
        
        renderLegacySingleReqTable();
        updateLegacySingleItemStockDisplay();
        
        // Clear for next entry
        document.getElementById('legacySingleReqSlipNo').value = '';
        document.getElementById('legacySingleReqIssuedQty').value = 0;
        document.getElementById('legacySingleReqSlipNo').focus();
    }
    
    function renderLegacySingleReqTable() {
        const tableBody = document.getElementById('legacySingleReqItemsTableBody');
        tableBody.innerHTML = '';
        tempSingleItemRequisitions.forEach((req, index) => {
            tableBody.innerHTML += `
                <tr>
                    <td>${formatDateToDDMMYYYY(req.date)}</td>
                    <td>${req.slipNo}</td>
                    <td>${req.department}</td>
                    <td>${req.qty}</td>
                    <td>
                        <button class="btn-link-icon" onclick="editLegacySingleReqItem(${index})">✏️</button>
                        <button class="btn-link-icon" onclick="removeLegacySingleReqItem(${index})">❌</button>
                    </td>
                </tr>
            `;
        });
    }

    function removeLegacySingleReqItem(index) {
        tempSingleItemRequisitions.splice(index, 1);
        renderLegacySingleReqTable();
        updateLegacySingleItemStockDisplay();
    }
    
    function editLegacySingleReqItem(index) {
        const reqToEdit = tempSingleItemRequisitions[index];
        
        document.getElementById('legacySingleReqDate').value = reqToEdit.date;
        document.getElementById('legacySingleReqSlipNo').value = reqToEdit.slipNo;
        document.getElementById('legacySingleReqDepartment').value = reqToEdit.department;
        document.getElementById('legacySingleReqIssuedQty').value = reqToEdit.qty;
        
        removeLegacySingleReqItem(index);
    }
    
    function saveAllLegacySingleItemReqs() {
        const itemId = parseInt(document.getElementById('legacySingleItemSelect').value);
        if (!itemId || tempSingleItemRequisitions.length === 0) {
            alert('Please select an item and add at least one requisition slip.');
            return;
        }

        if (!confirm(`Save ${tempSingleItemRequisitions.length} requisitions for the selected item? This will update the stock.`)) return;

        const item = appData.items.find(i => i.id === itemId);
        let totalIssued = 0;

        tempSingleItemRequisitions.forEach(req => {
            totalIssued += req.qty;
            appData.requisitions.push({
                id: getNextId('requisition'),
                slipNo: req.slipNo,
                date: req.date,
                department: req.department,
                items: [{
                    itemId: item.id,
                    name: item.name,
                    code: item.code,
                    qty: req.qty,
                    isMisc: false,
                    unit: item.unit
                }],
                type: 'Legacy'
            });
        });

        item.stock -= totalIssued;
        
        saveData();
        alert('All requisitions saved successfully!');
        clearLegacySingleItemForm();
        renderAll();
    }
    
// --- MISSING PAGINATION FUNCTION ---
function changeRequisitionPage(page) {
    currentRequisitionPage = page;
    filterRequisitionList();
}


    function parseExcelDate(excelDate) {
        if (typeof excelDate === 'number') {
            return new Date(Math.round((excelDate - 25569) * 86400 * 1000));
        }
        if (typeof excelDate === 'string') {
            const date = new Date(excelDate);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        return null; // Invalid date
    }

    
    
    function importLegacyRequisitionsFromExcel() {
    const fileInput = document.getElementById('legacyExcelInput');
    const itemId = parseInt(document.getElementById('legacySingleItemSelect').value);
    const item = appData.items.find(i => i.id === itemId);
    if (!itemId) {
        alert('Please select an item before uploading the Excel file.');
        return;
    }
    if (fileInput.files.length === 0) {
        alert('Please select an Excel file to upload.');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);
            let newRequisitionsFromExcel = [];
            let totalImportedQty = 0;
            let errors = [];
            
            json.forEach((row, index) => {
                const dateRaw = row['Date'];
                const slipNoRaw = row['Requisition Slip No.'];
                let slipNo = '';
                if (slipNoRaw !== undefined && slipNoRaw !== null && slipNoRaw !== '') {
                    const slipNoStr = String(slipNoRaw).trim();
                    slipNo = slipNoStr.toLowerCase().startsWith('r-') ? slipNoStr : 'R-' + slipNoStr;
                }
                const departmentName = row['Department'] ? String(row['Department']).trim() : '';
                const qty = parseInt(row['Quantities']);
                const parsedDate = parseExcelDate(dateRaw);
                
                if (!parsedDate || !slipNo || !departmentName || isNaN(qty) || qty <= 0) {
                    errors.push(`Row ${index + 2}: Missing or invalid data.`);
                    return;
                }
                totalImportedQty += qty;
                newRequisitionsFromExcel.push({ date: parsedDate.toISOString().split('T')[0], slipNo, department: departmentName, qty });
            });
            
            if (totalImportedQty > item.stock) {
                alert(`Error: Cannot import. Excel file requests ${totalImportedQty} units, but only ${item.stock} are available.`);
                return;
            }

            const existingDeptNames = new Set(appData.departments.map(d => d.name.toLowerCase()));
            newRequisitionsFromExcel.forEach(req => {
                if (!existingDeptNames.has(req.department.toLowerCase())) {
                    appData.departments.push({ id: getNextId('department'), name: req.department });
                    existingDeptNames.add(req.department.toLowerCase());
                }
            });

            // **** সঠিক সমাধান: ডেটা সরাসরি মূল তালিকায় যোগ করা, স্টক আপডেট করা এবং সেভ করা ****
            let totalIssued = 0;
            newRequisitionsFromExcel.forEach(req => {
                totalIssued += req.qty;
                appData.requisitions.push({
                    id: getNextId('requisition'),
                    slipNo: req.slipNo,
                    date: req.date,
                    department: req.department,
                    items: [{
                        itemId: item.id, name: item.name, code: item.code,
                        qty: req.qty, isMisc: false, unit: item.unit
                    }],
                    type: 'Legacy'
                });
            });

            item.stock -= totalIssued; // একবারে মোট স্টক আপডেট
            saveData(); // সব ডেটা একসাথে স্থায়ীভাবে সেভ

            let successMessage = `${newRequisitionsFromExcel.length} requisition(s) successfully imported and saved from Excel.`;
            if (errors.length > 0) {
                alert(successMessage + `\n\nHowever, some rows had errors:\n- ${errors.join('\n- ')}`);
            } else {
                alert(successMessage);
            }
            
            clearLegacySingleItemForm(); // ফর্ম রিসেট
            renderAll(); // সব ডেটা রিফ্রেশ
            fileInput.value = '';

        } catch (e) {
            console.error("Error processing Excel file:", e);
            alert("An error occurred. Please check the file format and column names: 'Date', 'Requisition Slip No.', 'Department', 'Quantities'.");
        }
    };
    reader.readAsArrayBuffer(file);
}


// Populates the new filter dropdowns for REQUISITIONS
function populateRequisitionFilters() {
    const deptSelect = document.getElementById('requisitionFilterDept');
    const storeItemSelect = document.getElementById('requisitionFilterStoreItem');
    const miscItemSelect = document.getElementById('requisitionFilterMiscItem');

    // Populate departments
    if (deptSelect) {
        const sortedDepts = [...appData.departments].sort((a, b) => a.name.localeCompare(b.name));
        deptSelect.innerHTML = '<option value="">All Departments</option>'; // Default option
        sortedDepts.forEach(dept => {
            deptSelect.innerHTML += `<option value="${dept.name}">${dept.name}</option>`;
        });
    }

    // Populate store items
    if (storeItemSelect) {
        const sortedItems = [...appData.items].sort((a, b) => a.name.localeCompare(b.name));
        storeItemSelect.innerHTML = '<option value="">All Store Items</option>'; // Default option
        sortedItems.forEach(item => {
            storeItemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
        });
    }
    
    // Populate miscellaneous items by finding all unique names used in requisitions
    if (miscItemSelect) {
        const miscItemNames = new Set();
        appData.requisitions.forEach(req => {
            req.items.forEach(item => {
                if (item.isMisc) {
                    miscItemNames.add(item.name);
                }
            });
        });
        const sortedMiscItems = Array.from(miscItemNames).sort();
        miscItemSelect.innerHTML = '<option value="">All Misc. Items</option>';
        sortedMiscItems.forEach(name => {
            miscItemSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });
    }
}

// Manages showing/hiding the item dropdowns for REQUISITIONS
function toggleRequisitionItemFilters() {
    const itemType = document.getElementById('requisitionFilterItemType').value;
    const storeContainer = document.getElementById('requisitionStoreItemContainer');
    const miscContainer = document.getElementById('requisitionMiscItemContainer');

    storeContainer.style.display = 'none';
    miscContainer.style.display = 'none';
    document.getElementById('requisitionFilterStoreItem').value = '';
    document.getElementById('requisitionFilterMiscItem').value = '';

    if (itemType === 'store') {
        storeContainer.style.display = 'block';
    } else if (itemType === 'misc') {
        miscContainer.style.display = 'block';
    }
}

// Resets all REQUISITION filters
function clearRequisitionFilters() {
    document.getElementById('requisitionSearch').value = '';
    document.getElementById('requisitionFilterDept').value = '';
    document.getElementById('requisitionFilterItemType').value = 'all';
    document.getElementById('requisitionFilterStartDate').value = '';
    document.getElementById('requisitionFilterEndDate').value = '';
    
    toggleRequisitionItemFilters(); // Hides and resets the item dropdowns
    filterRequisitionList(); // Reruns the filter
}

// এই ফাংশনটি স্লিপ নম্বরের ভেতরের সংখ্যা বের করে সঠিক ক্রমে সাজাবে
function customRequisitionSort(a, b) {
    // স্লিপ নম্বর থেকে অক্ষর বাদ দিয়ে শুধু সংখ্যা বের করা হচ্ছে
    const numA = parseInt(String(a.slipNo || '').replace(/[^0-9]/g, ''), 10) || 0;
    const numB = parseInt(String(b.slipNo || '').replace(/[^0-9]/g, ''), 10) || 0;

    // সংখ্যা অনুযায়ী বড় থেকে ছোট (Descending) সাজানো
    // আপনি যদি ছোট থেকে বড় (Ascending) চান, তাহলে return numA - numB; লিখবেন
    return numB - numA; 
}

// এই ফাংশনটি লিস্ট ফিল্টার এবং সর্ট করে টেবিলে দেখায়
// --- SAVED REQUISITION VIEW LOGIC ---

// 1. Custom Sort: Sorts slip numbers numerically (e.g., R-2, R-10 correctly)
function customRequisitionSort(a, b) {
    const numA = parseInt(String(a.slipNo || '').replace(/[^0-9]/g, ''), 10) || 0;
    const numB = parseInt(String(b.slipNo || '').replace(/[^0-9]/g, ''), 10) || 0;
    return numB - numA; // Descending order (Newest/Highest ID first)
}

// 2. Filter List: Handles Search, Date, Dept, and Type filters
function filterRequisitionList() {
    // Reset to page 1 when filtering to ensure results are seen
    // Note: Only reset if called by a filter change, not by pagination. 
    // However, for simplicity in this setup, usually filter calls reset it manually
    // or we check if the function was triggered by pagination.
    // For this system, we usually let changeRequisitionPage handle the page number.
    
    // If this function is called directly (not via pagination), you might want to reset page:
    // currentRequisitionPage = 1; (Enable this if filters break pagination flow)

    const searchTerm = document.getElementById('requisitionSearch').value.toLowerCase();
    const filterDept = document.getElementById('requisitionFilterDept').value;
    const filterType = document.getElementById('requisitionFilterItemType').value;
    const filterStoreItem = document.getElementById('requisitionFilterStoreItem').value;
    const filterMiscItem = document.getElementById('requisitionFilterMiscItem').value;
    const startDate = document.getElementById('requisitionFilterStartDate').value;
    const endDate = document.getElementById('requisitionFilterEndDate').value;
    
    let filteredRequisitions = appData.requisitions.filter(req => {
        // 1. Text Search
        const slipNoMatch = String(req.slipNo || '').toLowerCase().includes(searchTerm);
        const deptMatch = (req.department || '').toLowerCase().includes(searchTerm);
        const itemsMatch = req.items.some(item => (item.name || '').toLowerCase().includes(searchTerm));
        const textSearchMatch = slipNoMatch || deptMatch || itemsMatch;

        // 2. Department Filter
        const deptFilterMatch = !filterDept || req.department === filterDept;

        // 3. Date Range Filter
        let dateMatch = true;
        if (startDate) dateMatch = dateMatch && req.date >= startDate;
        if (endDate) dateMatch = dateMatch && req.date <= endDate;

        // 4. Item Type & Specific Item Filter
        let typeMatch = true;
        if (filterType === 'store') {
            // Must contain at least one Store item
            const hasStoreItem = req.items.some(i => !i.isMisc);
            if (!hasStoreItem) typeMatch = false;
            else if (filterStoreItem) {
                // If specific store item selected
                typeMatch = req.items.some(i => !i.isMisc && String(i.itemId) === filterStoreItem);
            }
        } else if (filterType === 'misc') {
            // Must contain at least one Misc item
            const hasMiscItem = req.items.some(i => i.isMisc);
            if (!hasMiscItem) typeMatch = false;
            else if (filterMiscItem) {
                 // If specific misc item selected
                typeMatch = req.items.some(i => i.isMisc && i.name === filterMiscItem);
            }
        }

        return textSearchMatch && deptFilterMatch && dateMatch && typeMatch;
    });

    // Sort the filtered results
    filteredRequisitions.sort(customRequisitionSort);
    
    // Render the table and pagination controls
    renderSavedRequisitions(filteredRequisitions);
    renderPagination(filteredRequisitions, 'requisitionPaginationControls', changeRequisitionPage, requisitionsPerPage, currentRequisitionPage);
}

// 3. Change Page (The Missing Ignition Key)
function changeRequisitionPage(page) {
    currentRequisitionPage = page;
    // We call render directly or filter again. 
    // Calling filter is safer to keep search results active.
    // However, to prevent resetting page to 1 inside filter, ensure filter logic handles it.
    // In this specific app architecture, we usually just re-run the filter logic:
    
    const searchTerm = document.getElementById('requisitionSearch').value.toLowerCase();
    // ... (Re-run filter logic to get the full list, then slice for page)
    // Simplified: Just call filter, but ensure filter function doesn't force Page 1
    // OR: Manually slice here if you have the full sorted list stored globally.
    // STANDARD APPROACH FOR THIS APP:
    
    // Re-run filter but keep the current page
    // Note: Ensure filterRequisitionList DOES NOT have "currentRequisitionPage = 1;" at the top
    // UNLESS it is triggered by an `onchange` event from an input.
    
    // For safety in this specific file structure, simply call:
    filterRequisitionList(); 
}

// 4. Render Table
function renderSavedRequisitions(requisitionsToRender) {
    const body = document.getElementById('savedRequisitionsBody');
    body.innerHTML = '';

    const start = (currentRequisitionPage - 1) * requisitionsPerPage;
    const end = start + requisitionsPerPage;
    const paginatedRequisitions = requisitionsToRender.slice(start, end);

    if (paginatedRequisitions.length === 0) {
        body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No requisitions found matching your search.</td></tr>';
        return;
    }

    paginatedRequisitions.forEach(r => {
        const itemsSummary = r.items.map(i => `${i.name} (x${i.qty} ${i.unit || ''})`).join(', ');
        body.innerHTML += `
        <tr>
            <td>${ /^[0-9]+$/.test(String(r.slipNo)) ? 'R-' + r.slipNo : r.slipNo }</td>
            <td>${formatDateToDDMMYYYY(r.date)}</td>
            <td>${r.department}</td>
            <td>${itemsSummary}</td>
            <td>
                <button class="btn-link" onclick="viewRequisition(${r.id})">View</button>
                <button class="btn-link action-btn" onclick="editRequisition(${r.id})">Edit</button>
                <button class="btn-link btn-danger action-btn" onclick="deleteRequisition(${r.id})">Delete</button>
            </td>
        </tr>`;
    });
    reapplyPermissionsOnRender();
}


    
    function deleteRequisition(id) {
        if (!confirm('Are you sure? This WILL revert stock changes and cannot be undone.')) return;
        
        const reqIndex = appData.requisitions.findIndex(r => r.id === id);
        if (reqIndex > -1) {
            const reqToDelete = appData.requisitions[reqIndex];
            reqToDelete.items.forEach(reqItem => {
                 if (reqItem.isMisc) {
                    updateMiscItemStock(reqItem.name, reqItem.qty);
                } else {
                    const itemInDb = appData.items.find(i => i.id === reqItem.itemId);
                    if (itemInDb) itemInDb.stock += reqItem.qty;
                }
            });
            appData.requisitions.splice(reqIndex, 1);
            saveData();
            renderAll();
            alert('Requisition deleted and stock reverted.');
        }
    }
    

// REPLACE your old function with this new one
function viewRequisition(id) {
    const req = appData.requisitions.find(r => r.id === id);
    if (!req) return;
    
    // This line is updated to include the unit
    let itemsHtml = req.items.map(item => `<tr><td>${item.name}</td><td>${item.code}</td><td>${item.qty}</td><td>${item.unit}</td></tr>`).join('');

    document.getElementById('viewRequisitionModalBody').innerHTML = `
        <div class="form-grid">
            <div class="form-group"><label>Requisition Slip/No.</label><p><strong>${req.slipNo}</strong></p></div>
            <div class="form-group"><label>Requisition Date</label><p><strong>${formatDateToDDMMYYYY(req.date)}</strong></p></div>
            <div class="form-group"><label>Department</label><p><strong>${req.department}</strong></p></div>
        </div><hr><h4>Requisition Items</h4>
        <div class="modal-table-container">
            <table class="data-table">
               
                <thead><tr><th>Item Name</th><th>Code</th><th>Issued Qty</th><th>Unit</th></tr></thead>
                <tbody>${itemsHtml}</tbody>
            </table>
        </div>
    `;
    openModal('viewRequisitionModal');
}



   //-----FUNCTION EDIT REQUISITION-----------
   function editRequisition(id) {
    try {
        const req = appData.requisitions.find(r => r.id === id);
        if (!req) {
            alert("Requisition not found!");
            return;
        }

        // অরিজিনাল ডেটা কপি করা
        editingRequisitionOriginalState = JSON.parse(JSON.stringify(req));
        
        // স্টোর না মিসলেনিয়াস আইটেম, তা চেক করা
        // যদি items অ্যারে না থাকে বা খালি থাকে, তবুও কোড ক্র্যাশ করবে না
        const items = req.items || [];
        const isStoreReq = !items.some(i => i.isMisc);
        const itemType = isStoreReq ? 'store' : 'misc';

        // আইটেম সিলেকশন ড্রপডাউন HTML
        let addItemInputHtml = `<label>SELECT ITEM</label><select id="editReqItemName" onchange="showEditReqItemDetails('${itemType}')"></select>`;
        
        // মডালের বডি তৈরি
        const modalBody = document.getElementById('editRequisitionModalBody');
        if (!modalBody) return;

        modalBody.innerHTML = `
            <form id="editRequisitionForm" class="form-grid">
                <input type="hidden" id="editingRequisitionId" value="${req.id}">
                <div class="form-group"><label>Req. Slip/No.</label><input type="text" id="editingReqSlipNo" required></div>
                <div class="form-group"><label>Req. Date</label><input type="date" id="editingReqDate" required></div>
                <div class="form-group"><label>Department</label><select id="editingReqDept"></select></div>
            </form><hr><h4>Edit Items</h4>
            <div class="modal-table-container">
                <table class="data-table">
                    <thead><tr><th>Item Name</th><th>Issued Qty</th><th>Unit</th><th>Action</th></tr></thead>
                    <tbody id="editingRequisitionItemsTableBody"></tbody>
                </table>
            </div><hr>
            <h4>Add New Item</h4> 
            <div class="form-grid mt-20"> 
                <div class="form-group">${addItemInputHtml}</div> 
                <div class="form-group"><label>ISSUED QTY</label><input type="number" id="editReqIssuedQty" value="0" oninput="calculateEditReqNewStock()">
                <span id="editReqNewStockResult" class="calculated-value"></span></div>
            </div>
            <div id="editReqItemDetails" class="item-details-box" style="display:none;"></div>
            <button type="button" class="btn btn-secondary mt-20" onclick="addItemToRequisitionInEdit('${itemType}')">ADD ITEM</button><hr>
            <div class="mt-20"><button class="btn btn-primary" onclick="updateRequisition()">UPDATE REQUISITION</button><button class="btn btn-clear" onclick="closeModal('editRequisitionModal')">CANCEL</button></div>
        `;

        // ভ্যালু সেট করা
        document.getElementById('editingReqSlipNo').value = req.slipNo;
        document.getElementById('editingReqDate').value = formatDateToYYYYMMDD(req.date);

        // ডিপার্টমেন্ট ড্রপডাউন
        const deptDropdown = document.getElementById('editingReqDept');
        populateDropdown(deptDropdown, appData.departments, true);
        deptDropdown.value = req.department;

        // আইটেম ড্রপডাউন (স্টক > ০ চেক সহ)
        const newItemDropdown = document.getElementById('editReqItemName');
        const sourceData = ((isStoreReq ? appData.items : appData.miscItems) || []).filter(i => i.stock > 0);
        
        populateDropdown(newItemDropdown, 
            [{name: '-- Select an Item --', id: ''}, ...sourceData.sort((a,b)=>a.name.localeCompare(b.name))], 
            true, 'name', 'name'
        );

        // টেবিল রেন্ডার এবং মডাল ওপেন
        renderEditingRequisitionItems();
        openModal('editRequisitionModal');

    } catch (error) {
        console.error("Error in editRequisition:", error);
        alert("Something went wrong while opening the edit window. Check console for details.");
    }
}
    
    
    
// এই ফাংশনটিও আপডেট করুন
function addItemToRequisitionInEdit(itemType) {
    const isMisc = itemType === 'misc';
    const itemName = document.getElementById('editReqItemName').value.trim();
    const issuedQty = parseInt(document.getElementById('editReqIssuedQty').value);
    
    if (!itemName || isNaN(issuedQty) || issuedQty <= 0) { 
        alert('Please select an item and enter a valid quantity.'); return; 
    }

    // ডুপ্লিকেট চেক
    if (editingRequisitionOriginalState.items.some(i => i.name === itemName)) { 
        alert('Item already in list!'); return; 
    }

    const itemSource = isMisc ? appData.miscItems : appData.items;
    const itemDetails = itemSource.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    
    if (!itemDetails) { alert('Item not found.'); return; }
    
    if (issuedQty > itemDetails.stock) {
        alert(`Insufficient stock! Available: ${itemDetails.stock}`); return;
    }
    
    const unitMeasure = itemDetails.unit || (isMisc ? appData.miscItemDefaults.unit : 'Pcs');

    // নতুন আইটেমটি লিস্টে পুশ করা হচ্ছে
    editingRequisitionOriginalState.items.push({
        itemId: itemDetails.id, 
        name: itemDetails.name,
        code: itemDetails.code || appData.miscItemDefaults.code, 
        qty: issuedQty, 
        unit: unitMeasure,
        isMisc: isMisc
    });

    // *** এই লাইনটি টেবিল রিফ্রেশ করে এবং পুরনো+নতুন সব আইটেম দেখায় ***
    renderEditingRequisitionItems(); 

    // ইনপুট রিসেট
    document.getElementById('editReqItemName').value = '';
    document.getElementById('editReqIssuedQty').value = 0;
    document.getElementById('editReqItemDetails').style.display = 'none';
    document.getElementById('editReqNewStockResult').innerText = '';
}
    function removeEditingRequisitionItem(itemName) {
        editingRequisitionOriginalState.items = editingRequisitionOriginalState.items.filter(i => i.name !== itemName);
        renderEditingRequisitionItems();
    }



 // এই ফাংশনটি কপি করে আপনার পুরনো renderEditingRequisitionItems এর বদলে বসান
function renderEditingRequisitionItems() {
    const tableBody = document.getElementById('editingRequisitionItemsTableBody');
    
    // ১. সেফটি চেক: যদি টেবিল বা ডেটা না থাকে, তবে ফাংশন থামবে (ক্র্যাশ করবে না)
    if (!tableBody || !editingRequisitionOriginalState) return;
    
    // যদি items অ্যারে না থাকে, তবে একটি খালি অ্যারে তৈরি করে নেব
    if (!editingRequisitionOriginalState.items) {
        editingRequisitionOriginalState.items = [];
    }

    // ২. টেবিল ক্লিয়ার করা
    tableBody.innerHTML = ''; 
    
    // ৩. লুপ চালিয়ে আইটেম বসানো
    editingRequisitionOriginalState.items.forEach((item, index) => {
        // ইউনিট সেফটি চেক: যদি ইউনিট না থাকে, ডিফল্ট 'Pcs' বা 'Unit' বসবে
        let displayUnit = item.unit || 'Unit';
        if (!displayUnit || displayUnit === 'undefined') {
             if (appData.miscItemDefaults && appData.miscItemDefaults.unit) {
                 displayUnit = appData.miscItemDefaults.unit;
             }
        }

        // নামের মধ্যে single quote (') থাকলে যাতে কোড না ভাঙ্গে, তার জন্য escape করা হলো
        const safeItemName = item.name.replace(/'/g, "\\'");

        const row = `
            <tr data-index="${index}" data-name="${item.name}">
                <td>${item.name}</td>
                <td>
                    <input type="number" class="editing-req-qty" value="${item.qty}" style="padding: 5px; width: 80px;">
                </td>
                <td>${displayUnit}</td> 
                <td>
                    <button type="button" class="btn-link btn-danger" onclick="removeEditingRequisitionItem('${safeItemName}')">Remove</button>
                </td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    }); 
}
   // এই ফাংশনটি কপি করে আপনার পুরনো updateRequisition ফাংশনের বদলে বসিয়ে দিন
function updateRequisition() {
    const reqId = parseInt(document.getElementById('editingRequisitionId').value);
    const reqIndex = appData.requisitions.findIndex(r => r.id === reqId);
    
    if (reqIndex === -1) {
        alert("Requisition not found!");
        return;
    }

    const originalReq = appData.requisitions[reqIndex];

    // ১. আগের স্টক ফিরিয়ে দেওয়া (Revert Old Stock)
    originalReq.items.forEach(item => {
        if (item.isMisc) {
            updateMiscItemStock(item.name, item.qty); // ফেরত দেওয়া হলো
        } else {
            let storeItem = appData.items.find(i => i.id === item.itemId);
            if (storeItem) storeItem.stock += item.qty; // ফেরত দেওয়া হলো
        }
    });

    // ২. নতুন ডেটা প্রসেস করা (DOM থেকে লেটেস্ট Qty নেওয়া)
    // আমরা editingRequisitionOriginalState থেকে বেসিক ডেটা নেব, আর ইনপুট ফিল্ড থেকে Qty নেব
    const updatedItems = editingRequisitionOriginalState.items.map((item, index) => {
        const row = document.querySelector(`#editingRequisitionItemsTableBody tr[data-index="${index}"]`);
        let newQty = item.qty;
        
        if (row) {
            const qtyInput = row.querySelector('.editing-req-qty');
            if (qtyInput) {
                newQty = parseInt(qtyInput.value) || 0;
            }
        }

        // এখানে আমরা নিশ্চিত করছি যে 'unit' এবং অন্যান্য তথ্য যেন হারিয়ে না যায়
        return {
            ...item, 
            qty: newQty
        };
    });

    // ৩. নতুন স্টক অ্যাপ্লাই করা (Apply New Stock)
    updatedItems.forEach(item => {
        if (item.isMisc) {
            updateMiscItemStock(item.name, -item.qty); // নতুন করে কমানো হলো
        } else {
            let storeItem = appData.items.find(i => i.id === item.itemId);
            if (storeItem) storeItem.stock -= item.qty; // নতুন করে কমানো হলো
        }
    });

    // ৪. মেইন ডেটাবেসে আপডেট করা
    const reqToUpdate = appData.requisitions[reqIndex];
    reqToUpdate.slipNo = document.getElementById('editingReqSlipNo').value;
    reqToUpdate.date = document.getElementById('editingReqDate').value;
    reqToUpdate.department = document.getElementById('editingReqDept').value;
    reqToUpdate.items = updatedItems;

    saveData();
    alert('Requisition updated successfully! Stock adjusted.');
    closeModal('editRequisitionModal');
    renderAll();
}
    
    function showEditReqItemDetails(itemType) {
        const isMisc = itemType === 'misc';
        const itemName = document.getElementById('editReqItemName').value;
        const detailsBox = document.getElementById('editReqItemDetails');
        if (!itemName) { detailsBox.style.display = 'none'; return; }

        const itemSource = isMisc ? appData.miscItems : appData.items;
        const item = itemSource.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        
        if (item) {
            detailsBox.innerHTML = isMisc ?
                `<div><span class="label-green">CURRENT STOCK:</span> <span id="editReqCurrentStockValue">${item.stock}</span></div>` :
                `<div><span class="label-normal-blue">ITEM CODE:</span> ${item.code || 'N/A'}</div> <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage || 'N/A'}</div> <div><span class="label-violet">PURCH. PAGE NO:</span> ${item.purchPage || 'N/A'}</div> <div><span class="label-green">CURRENT STOCK:</span> <span id="editReqCurrentStockValue">${item.stock}</span></div>`;
            detailsBox.style.display = 'grid';
            calculateEditReqNewStock();
        } else {
            detailsBox.style.display = 'none';
        }
    }

    function calculateEditReqNewStock() {
        const currentStockEl = document.getElementById('editReqCurrentStockValue');
        if (!currentStockEl) return;
        const currentStock = parseInt(currentStockEl.innerText);
        const issuedQty = parseInt(document.getElementById('editReqIssuedQty').value) || 0;
        const resultEl = document.getElementById('editReqNewStockResult');

        if (issuedQty > currentStock) {
            resultEl.innerText = `Error: Not enough stock!`;
            resultEl.style.color = 'red';
        } else {
            resultEl.innerText = `New Stock: ${currentStock - issuedQty}`;
            resultEl.style.color = 'var(--text-red)';
        }
    }
// এই ফাংশনটি কপি করে আপনার পুরনো addItemToRequisitionInEdit এর বদলে বসান
function addItemToRequisitionInEdit(itemType) {
    try {
        const isMisc = itemType === 'misc';
        const itemNameInput = document.getElementById('editReqItemName');
        const qtyInput = document.getElementById('editReqIssuedQty');
        
        const itemName = itemNameInput.value.trim();
        const issuedQty = parseInt(qtyInput.value);
        
        // ১. ভ্যালিডেশন
        if (!itemName) { 
            alert('Please select an item.'); return; 
        }
        if (isNaN(issuedQty) || issuedQty <= 0) {
            alert('Please enter a valid quantity.'); return;
        }

        // ২. অ্যারে ইনিশিয়ালাইজেশন চেক
        if (!editingRequisitionOriginalState.items) {
            editingRequisitionOriginalState.items = [];
        }

        // ৩. ডুপ্লিকেট চেক
        if (editingRequisitionOriginalState.items.some(i => i.name === itemName)) { 
            alert('Item already in list! Please verify in the table above.'); 
            return; 
        }

        // ৪. আইটেম খোঁজা
        const itemSource = isMisc ? appData.miscItems : appData.items;
        const itemDetails = itemSource.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        
        if (!itemDetails) { 
            alert('Item not found in database.'); return; 
        }
        
        // ৫. স্টক চেক
        if (issuedQty > itemDetails.stock) {
            alert(`Insufficient stock! Available: ${itemDetails.stock}`);
            return;
        }
        
        // ৬. ইউনিট নির্ধারণ (সেফটি সহ)
        let unitMeasure = itemDetails.unit;
        if (!unitMeasure && isMisc && appData.miscItemDefaults) {
            unitMeasure = appData.miscItemDefaults.unit;
        }
        if (!unitMeasure) unitMeasure = 'Pcs'; // একদম না পেলে ডিফল্ট

        // ৭. লিস্টে যোগ করা
        editingRequisitionOriginalState.items.push({
            itemId: itemDetails.id, 
            name: itemDetails.name,
            code: itemDetails.code || (appData.miscItemDefaults ? appData.miscItemDefaults.code : ''), 
            qty: issuedQty, 
            unit: unitMeasure,
            isMisc: isMisc
        });

        // ৮. টেবিল রিফ্রেশ (সবচেয়ে গুরুত্বপূর্ণ ধাপ)
        renderEditingRequisitionItems(); 

        // ৯. ইনপুট ফিল্ড রিসেট
        itemNameInput.value = '';
        qtyInput.value = 0;
        document.getElementById('editReqItemDetails').style.display = 'none';
        document.getElementById('editReqNewStockResult').innerText = '';

    } catch (error) {
        console.error("Error adding item:", error);
        alert("An error occurred while adding the item. Please check the console.");
    }
}
    function viewChallan(id) {
        const challan = appData.challans.find(c => c.id === id);
        if (!challan) return;
        let itemsHtml = challan.items.map(item => `<tr><td>${item.name}</td><td>${item.code}</td><td>${item.qty}</td></tr>`).join('');
        document.getElementById('viewChallanModalBody').innerHTML = `
             <div class="form-grid">
                <div class="form-group"><label>Challan Number</label><p><strong>${challan.number}</strong></p></div>
                <div class="form-group"><label>Challan Date</label><p><strong>${formatDateToDDMMYYYY(challan.date)}</strong></p></div>
                <div class="form-group"><label>Vendor</label><p><strong>${challan.vendor}</strong></p></div>
            </div><hr><h4>Challan Items</h4>
            <div class="modal-table-container"><table class="data-table"><thead><tr><th>Item Name</th><th>Code</th><th>Supplied Qty</th></tr></thead><tbody>${itemsHtml}</tbody></table></div>
        `;
        openModal('viewChallanModal');
    }

// ----FUNCTION EDIT CHALLAN------
function editChallan(id) {
    const challan = appData.challans.find(c => c.id === id);
    if (!challan) return;
    editingChallanOriginalState = JSON.parse(JSON.stringify(challan));
    
    // Step 1: Create the HTML for the modal. Note the date and number inputs have no 'value' attribute.
    document.getElementById('editChallanModalBody').innerHTML = `
        <form id="editChallanForm" class="form-grid">
            <input type="hidden" id="editingChallanId" value="${challan.id}">
            <div class="form-group"><label>Challan Number</label><input type="text" id="editingChallanNumber" required></div>
            <div class="form-group"><label>Challan Date</label><input type="date" id="editingChallanDate" required></div>
            <div class="form-group"><label>Vendor</label><select id="editingChallanVendor"></select></div>
        </form><hr><h4>Edit Existing Items</h4>
        <div class="modal-table-container"><table class="data-table"><thead><tr><th>Item Name</th><th>Supplied Qty</th><th>Unit</th><th>Action</th></tr></thead><tbody id="editingChallanItemsTableBody"></tbody></table></div><hr>
        <h4>Add New Item to Challan</h4>
        <div class="d-flex gap-10"><input type="checkbox" id="editChallanMiscCheckbox" onchange="toggleMiscItem('editChallan', true, 'Challan')"><label for="editChallanMiscCheckbox">Miscellaneous Item</label></div>
        <div class="form-grid mt-20">
            <div class="form-group"><label>SELECT/WRITE ITEM</label><input type="text" id="editChallanItemName" list="itemListData" onchange="showEditChallanItemDetails()"><input type="text" id="editChallanMiscItemName" class="hidden mt-20" placeholder="Enter Miscellaneous Item Name" oninput="showEditChallanItemDetails()"></div>
            <div class="form-group"><label>SUPPLIED QTY</label><input type="number" id="editChallanSuppliedQty" value="0" oninput="calculateEditChallanNewStock()"></div>
            <div id="editChallanMiscUnitGroup" class="form-group hidden"><label>UNIT MEASURE</label><select id="editChallanMiscUnit"></select></div>
        </div>
        <div class="item-details-box" style="margin-top: 0;">
             <span id="editChallanNewStockResult" class="calculated-value"></span>
        </div>
        <div id="editChallanItemDetails" class="item-details-box" style="display:none;"></div>
        <button type="button" class="btn btn-secondary mt-20" onclick="addItemToChallanInEdit()">ADD ITEM</button><hr>
        <div class="mt-20"><button class="btn btn-primary" onclick="updateChallan()">UPDATE CHALLAN</button><button class="btn btn-clear" onclick="closeModal('editChallanModal')">CANCEL</button></div>
    `;

    // Step 2: Set the values AFTER the HTML has been created. THIS IS THE FIX.
    document.getElementById('editingChallanNumber').value = challan.number;
    document.getElementById('editingChallanDate').value = formatDateToYYYYMMDD(challan.date);

    // Step 3: Populate dropdowns and render the item table.
    const vendorDropdown = document.getElementById('editingChallanVendor');
    populateDropdown(vendorDropdown, appData.vendors, true);
    vendorDropdown.value = challan.vendor;
    populateDropdown(document.getElementById('editChallanMiscUnit'), appData.measures);

    renderEditingChallanItems();
    openModal('editChallanModal');
}

    function renderEditingChallanItems() {
        const tableBody = document.getElementById('editingChallanItemsTableBody');
        tableBody.innerHTML = '';
        editingChallanOriginalState.items.forEach((item, index) => {
             tableBody.innerHTML += `<tr data-index="${index}" data-name="${item.name}"><td>${item.name}</td><td><input type="number" class="editing-challan-qty" value="${item.qty}" style="padding: 5px; width: 80px;"></td><td>${item.unit}</td><td><button class="btn-link btn-danger" onclick="removeEditingChallanItem('${item.name}')">Remove</button></td></tr>`;
        });
    }
    
    function removeEditingChallanItem(itemName) {
        editingChallanOriginalState.items = editingChallanOriginalState.items.filter(i => i.name !== itemName);
        renderEditingChallanItems();
    }

    function updateChallan() {
    const challanId = parseInt(document.getElementById('editingChallanId').value);
    const challanInDbIndex = appData.challans.findIndex(c => c.id === challanId);
    if (challanInDbIndex === -1) return;

    // মডাল থেকে আপডেটেড আইটেমগুলো নেওয়া হচ্ছে
    const updatedItemsFromModal = editingChallanOriginalState.items.map(item => {
        const row = document.querySelector(`#editingChallanItemsTableBody tr[data-name="${item.name}"]`);
        return row ? { ...item, qty: parseInt(row.querySelector('.editing-challan-qty').value) || 0 } : item;
    });

    // --- স্টক ক্যালকুলেশন লজিকটি এখানে বন্ধ (OFF) করে দেওয়া হয়েছে ---
    /*
    const originalChallan = JSON.parse(JSON.stringify(appData.challans.find(c => c.id === challanId)));
    const originalQtyMap = new Map(originalChallan.items.map(item => [(item.isMisc ? `misc-${item.name}` : `store-${item.itemId}`), item.qty]));
    const updatedQtyMap = new Map(updatedItemsFromModal.map(item => [(item.isMisc ? `misc-${item.name}` : `store-${item.itemId}`), item.qty]));
    const allItemKeys = new Set([...originalQtyMap.keys(), ...updatedQtyMap.keys()]);

    allItemKeys.forEach(key => {
        const difference = (updatedQtyMap.get(key) || 0) - (originalQtyMap.get(key) || 0);
        if (difference === 0) return;
        const isMisc = key.startsWith('misc-');
        if (isMisc) {
            updateMiscItemStock(key.replace('misc-', ''), difference);
        } else {
            const itemInStock = appData.items.find(i => i.id === parseInt(key.replace('store-', '')));
            if (itemInStock) itemInStock.stock += difference;
        }
    });
    */
    // -------------------------------------------------------------

    // ডাটাবেসে শুধুমাত্র চালান আপডেট হবে, স্টক নয়
    const challanToUpdate = appData.challans[challanInDbIndex];
    challanToUpdate.number = document.getElementById('editingChallanNumber').value;
    challanToUpdate.date = document.getElementById('editingChallanDate').value;
    challanToUpdate.vendor = document.getElementById('editingChallanVendor').value;
    challanToUpdate.items = updatedItemsFromModal;

    saveData();
    alert('Challan updated. Stock quantity remained unchanged.');
    closeModal('editChallanModal');
    renderAll();
}

    function showEditChallanItemDetails() {
        const isMisc = document.getElementById('editChallanMiscCheckbox').checked;
        const itemName = isMisc ? document.getElementById('editChallanMiscItemName').value : document.getElementById('editChallanItemName').value;
        const detailsBox = document.getElementById('editChallanItemDetails');
        if (!itemName) { detailsBox.style.display = 'none'; return; }
        
        if (isMisc) {
            const miscItem = appData.miscItems.find(mi => mi.name.toLowerCase() === itemName.toLowerCase());
            detailsBox.innerHTML = `
                <div><span class="label-normal-blue">ITEM CODE:</span> ${appData.miscItemDefaults.code}</div>
                <div><span class="label-red">STOCK PAGE NO:</span> ${appData.miscItemDefaults.stockPage}</div>
                <div><span class="label-violet">PURCH. PAGE NO:</span> ${appData.miscItemDefaults.purchPage}</div>
                <div><span class="label-green">CURRENT STOCK:</span> <span id="editChallanCurrentStockValue">${miscItem ? miscItem.stock : 0}</span></div>
            `;
        } else {
            const item = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
            if (item) {
                 detailsBox.innerHTML = `
                    <div><span class="label-normal-blue">ITEM CODE:</span> ${item.code}</div>
                    <div><span class="label-red">STOCK PAGE NO:</span> ${item.stockPage}</div>
                    <div><span class="label-violet">PURCH. PAGE NO:</span> ${item.purchPage}</div>
                    <div><span class="label-green">CURRENT STOCK:</span> <span id="editChallanCurrentStockValue">${item.stock}</span></div>
                `;
            } else { detailsBox.style.display = 'none'; return; }
        }
        detailsBox.style.display = 'grid';
        calculateEditChallanNewStock();
    }
    
    function calculateEditChallanNewStock() {
        const currentStockEl = document.getElementById('editChallanCurrentStockValue');
        if (!currentStockEl) return;
        const currentStock = parseInt(currentStockEl.innerText);
        const suppliedQty = parseInt(document.getElementById('editChallanSuppliedQty').value) || 0;
        const resultEl = document.getElementById('editChallanNewStockResult');
        if(resultEl) {
            resultEl.innerText = `New Stock: ${currentStock + suppliedQty}`;
        }
    }

    function addItemToChallanInEdit() {
        const isMisc = document.getElementById('editChallanMiscCheckbox').checked;
        const itemName = (isMisc ? document.getElementById('editChallanMiscItemName').value : document.getElementById('editChallanItemName').value).trim();
        const suppliedQty = parseInt(document.getElementById('editChallanSuppliedQty').value);
        
        if (!itemName || suppliedQty <= 0) { alert('Please enter item and valid quantity.'); return; }
        if (editingChallanOriginalState.items.some(i => i.name === itemName)) { alert('Item already in challan.'); return; }

        const itemDetails = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        const unit = isMisc ? document.getElementById('editChallanMiscUnit').value : itemDetails.unit;
        const item = itemDetails ? {...itemDetails} : { id: null, name: itemName, code: appData.miscItemDefaults.code };

        editingChallanOriginalState.items.push({
            itemId: item.id, name: item.name, code: item.code, qty: suppliedQty, unit: unit, isMisc: !itemDetails
        });

        renderEditingChallanItems();
        document.getElementById('editChallanItemName').value = '';
        document.getElementById('editChallanMiscItemName').value = '';
        document.getElementById('editChallanSuppliedQty').value = 0;
    }

    // --- REPORT GENERATION ---
    function getFormattedDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function formatDateToDDMMYYYY(dateString) {
    if (!dateString) return '';
    
    // Check if the dateString is already in YYYY-MM-DD format
    if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }
    
    // Try to parse the date using the Date object
    const dateObj = new Date(dateString);
    
    // Check if the date object is valid
    if (!isNaN(dateObj.getTime())) {
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    // If parsing fails, try to handle the specific format from the screenshot
    const match = dateString.match(/(\d{2})T\d{2}:\d{2}:\d{2}\.\d{3}Z\/(\d{2})\/(\d{4})/);
    if (match) {
        const day = match[1];
        const month = match[2];
        const year = match[3];
        return `${day}/${month}/${year}`;
    }

    // Return the original string if all attempts fail
    return dateString;
}
  
// --- NEW HELPER: HIGHLIGHT TEXT ---
function highlightText(text, searchTerm) {
    if (!text) return '';
    const safeText = String(text); 
    if (!searchTerm) return safeText;

    // Split search input into words and remove empty spaces
    const tokens = searchTerm.split(/\s+/).filter(token => token.length > 0);
    
    let highlightedText = safeText;
    tokens.forEach(token => {
        // Create a regex for case-insensitive matching
        const regex = new RegExp(`(${token})`, 'gi');
        // Wrap matching text in a yellow highlight
        highlightedText = highlightedText.replace(regex, '<mark style="background-color: yellow; color: black; font-weight: bold; padding: 0;">$1</mark>');
    });
    
    return highlightedText;
}

    /**
 * Finds the most recent purchase price for a store item from any invoice, regardless of date.
 * @param {number} itemId The ID of the item to find.
 * @returns {number} The calculated price including GST, or 0 if never purchased.
 */
function getMostRecentPurchasePrice(itemId) {
    const sortedInvoices = [...appData.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
    for (const invoice of sortedInvoices) {
        const foundItem = invoice.items.find(i => i.itemId === itemId && !i.isMisc);
        if (foundItem) {
            return foundItem.rate * (1 + foundItem.gst / 100); // Return price immediately
        }
    }
    return 0; // Return 0 if no purchase record ever exists
}

/**
 * Finds the most recent purchase price for a miscellaneous item from any invoice.
 * @param {string} itemName The name of the misc item to find.
 * @returns {number} The calculated price including GST, or 0 if never purchased.
 */
function getMostRecentMiscPurchasePrice(itemName) {
    const sortedInvoices = [...appData.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
    for (const invoice of sortedInvoices) {
        const foundItem = invoice.items.find(i => i.name === itemName && i.isMisc);
        if (foundItem) {
            return foundItem.rate * (1 + foundItem.gst / 100); // Return price immediately
        }
    }
    return 0; // Return 0 if no purchase record ever exists
}

function getLastPurchasePrice(itemId, beforeDate) {
    const sortedInvoices = [...appData.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
    for (const invoice of sortedInvoices) {
        if (invoice.date <= beforeDate) {
            const foundItem = invoice.items.find(i => i.itemId === itemId && !i.isMisc);
            if (foundItem) {
                // Found a historical price, return it immediately.
                return foundItem.rate * (1 + foundItem.gst / 100);
            }
        }
    }
    // If the loop finishes without finding a historical price,
    // fallback to the most recent price available from any date.
    return getMostRecentPurchasePrice(itemId);
}

function getLastMiscPurchasePrice(itemName, beforeDate) {
    const sortedInvoices = [...appData.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
    for (const invoice of sortedInvoices) {
        if (invoice.date <= beforeDate) {
            const foundItem = invoice.items.find(i => i.name === itemName && i.isMisc);
            if (foundItem) {
                // Found a historical price, return it immediately.
                return foundItem.rate * (1 + foundItem.gst / 100);
            }
        }
    }
    // If the loop finishes, fallback to the most recent price for the misc item.
    return getMostRecentMiscPurchasePrice(itemName);
}
    
    function generateReport(title, headers, data, totalRow, format) {
        const { jsPDF } = window.jspdf;
        if (format === 'pdf') {
            const doc = new jsPDF();
            doc.text(title, 14, 15);
            doc.autoTable({
                head: [headers], body: data, startY: 20,
                didDrawPage: (data) => {
                    if (totalRow.length > 0) {
                        doc.autoTable({ body: [totalRow], startY: data.cursor.y, theme: 'grid', styles: { fontStyle: 'bold' } });
                    }
                }
            });
            doc.save(`${title.replace(/ /g, '_')}_${getFormattedDate()}.pdf`);
        } else if (format === 'excel') {
            const excelData = [headers, ...data];
            if (totalRow.length > 0) excelData.push(totalRow);
            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Report");
            XLSX.writeFile(workbook, `${title.replace(/ /g, '_')}_${getFormattedDate()}.xlsx`);
        }
    }
    
    function generateStockReport(format) {
        const data = appData.items.map(item => [item.name, item.stock, item.unit]);
        if (data.length === 0) { alert('No item data found.'); return; }
        generateReport("Current Stock Report", ["Item Name", "Current Stock", "Unit"], data, [], format);
    }
    
    function generateStorePurchaseReport(format) {
        const startDate = document.getElementById('storePurchaseReportStartDate').value;
        const endDate = document.getElementById('storePurchaseReportEndDate').value;
        if (!startDate || !endDate) { alert('Please select a start and end date.'); return; }

        let data = [];
        let grandTotalValue = 0;

        // Get all store items and sort them by stock page number
        const sortedItems = [...appData.items].sort((a, b) => parseInt(a.stockPage) - parseInt(b.stockPage));

        sortedItems.forEach(item => {
            let totalQty = 0;
            let totalValue = 0;

            // Find all purchases for this item within the date range
            appData.invoices.filter(inv => inv.date >= startDate && inv.date <= endDate).forEach(inv => {
                inv.items.forEach(invItem => {
                    if (invItem.itemId === item.id && !invItem.isMisc) {
                        const itemValue = invItem.qty * invItem.rate * (1 + invItem.gst / 100);
                        totalQty += invItem.qty;
                        totalValue += itemValue;
                    }
                });
            });
            
            grandTotalValue += totalValue;
            data.push([item.stockPage, item.name, `${totalQty} ${item.unit}`, totalValue.toFixed(2)]);
        });

        if (data.length === 0) { alert('No item data found.'); return; }
        const totalRow = ['', '', { content: 'GRAND TOTAL', styles: { halign: 'right' } }, grandTotalValue.toFixed(2)];
        generateReport(`Purchase Report (${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)})`,
            ["Stock Page", "Item Name", "Total Qty Purchased", "Total Value"], data, totalRow, format);
    }
    
// --- NEW REPORT: CURRENT STOCK VALUE ---
function generateCurrentStockValueReport(format) {
    let data = [];
    let grandTotalValue = 0;

    // 1. Sort items alphabetically
    const sortedItems = [...appData.items].sort((a, b) => a.name.localeCompare(b.name));

    sortedItems.forEach(item => {
        // 2. Get the most recent purchase price (Incl. GST) using your existing helper function
        // If the item has never been purchased, this returns 0
        const rate = getMostRecentPurchasePrice(item.id);
        
        // 3. Calculate Stock Value
        const stockValue = item.stock * rate;
        
        // 4. Add to Grand Total
        grandTotalValue += stockValue;

        // 5. Push row data
        data.push([
            item.name,
            item.code,
            item.stock,      // Raw number for Excel calculation if needed
            item.unit,
            rate > 0 ? rate.toFixed(2) : "0.00",  // Show rate
            stockValue.toFixed(2)                 // Show row value
        ]);
    });

    if (data.length === 0) {
        alert('No store items found.');
        return;
    }

    // 6. Create the Total Row for the bottom of the report
    const totalRow = [
        '', 
        '', 
        '', 
        { content: 'GRAND TOTAL VALUE:', styles: { halign: 'right', fontStyle: 'bold' } }, 
        '', // Empty column for Rate
        { content: grandTotalValue.toFixed(2), styles: { fontStyle: 'bold', fillColor: '#d4edda' } } // Highlighted Total
    ];

    // 7. Generate using your existing report engine
    generateReport(
        "Current Store Stock Value Report", 
        ["Item Name", "Item Code", "Current Qty", "Unit", "Latest Rate (Incl. GST)", "Total Value"], 
        data, 
        totalRow, 
        format
    );
}

function viewCurrentStockValueReport() {
    const tableBody = document.getElementById('currentStockValueBody');
    tableBody.innerHTML = ''; // Clear previous data
    let grandTotal = 0;

    // 1. Get Today's Date formatted as DD/MM/YYYY
    const today = new Date();
    const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

    // 2. Sort items alphabetically
    const sortedItems = [...appData.items].sort((a, b) => a.name.localeCompare(b.name));

    if (sortedItems.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No store items found.</td></tr>';
    } else {
        sortedItems.forEach(item => {
            // 3. Get Price and Calculate Value
            const rate = getMostRecentPurchasePrice(item.id);
            const value = item.stock * rate;
            grandTotal += value;

            // 4. Create Table Row
            // Highlight row red if rate is 0 (item never purchased)
            const rowStyle = rate === 0 && item.stock > 0 ? 'background-color: #fff0f0;' : '';
            const rateDisplay = rate > 0 ? rate.toFixed(2) : '<span style="color:red; font-size:0.9em;">(No Purchase Record)</span>';

            tableBody.innerHTML += `
                <tr style="${rowStyle}">
                    <td>${item.name}</td>
                    <td>${item.code}</td>
                    <td><strong>${item.stock}</strong></td>
                    <td>${item.unit}</td>
                    <td>${rateDisplay}</td>
                    <td style="font-weight:bold;">${value.toFixed(2)}</td>
                </tr>
            `;
        });
    }

    // 5. Update Totals and Title with Date
    document.getElementById('currentStockValueGrandTotal').innerText = grandTotal.toFixed(2);
    document.getElementById('currentStockValueTitle').innerText = `Current Stock Value Report (As On: ${formattedDate})`;

    // 6. Open the Modal
    openModal('currentStockValueModal');
}


    function generateValuedIssueReport(format) {
        const startDate = document.getElementById('valuedIssueReportStartDate').value;
        const endDate = document.getElementById('valuedIssueReportEndDate').value;
        if (!startDate || !endDate) { alert('Please select a start and end date.'); return; }

        let data = [], grandTotalValue = 0;
        let requisitionsByDept = {};
        appData.requisitions.filter(req => req.date >= startDate && req.date <= endDate).forEach(req => {
            if (!requisitionsByDept[req.department]) requisitionsByDept[req.department] = [];
            requisitionsByDept[req.department].push(req);
        });
        
        Object.keys(requisitionsByDept).sort().forEach(deptName => {
            let deptTotal = 0;
            const reqDataForDept = [];
            requisitionsByDept[deptName].forEach(req => {
                let reqTotalValue = req.items.reduce((sum, item) => {
                    return sum + (item.qty * (item.isMisc ? getLastMiscPurchasePrice(item.name, req.date) : getLastPurchasePrice(item.itemId, req.date)));
                }, 0);
                deptTotal += reqTotalValue;
                reqDataForDept.push([formatDateToDDMMYYYY(req.date), req.slipNo, reqTotalValue.toFixed(2), '', '']);
                req.items.forEach(item => { reqDataForDept.push(['', '', '', item.name, item.qty]); });
            });
            data.push([{ content: `DEPT: ${deptName}`, colSpan: 3, styles: { fontStyle: 'bold', fillColor: '#d3d3d3' } }, { content: `TOTAL: ${deptTotal.toFixed(2)}`, colSpan: 2, styles: { fontStyle: 'bold', fillColor: '#d3d3d3', halign: 'right' } }]);
            data.push(...reqDataForDept);
            grandTotalValue += deptTotal;
        });

        if (data.length === 0) { alert('No issue data found.'); return; }
        const totalRow = ['', '', { content: 'GRAND TOTAL', styles: { halign: 'right' } }, grandTotalValue.toFixed(2), ''];
        generateReport(`Issued Requisition Report (${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)})`,
            ["DATE", "REQ. SLIP NO.", "REQ. TOTAL VALUE", "ITEM NAME", "ISSUED QTY"], data, totalRow, format);
    }
    
    function generateMiscPurchaseReport(format) {
        const startDate = document.getElementById('miscReportStartDate').value;
        const endDate = document.getElementById('miscReportEndDate').value;
        if (!startDate || !endDate) { alert('Please select a start and end date.'); return; }

        let data = [], totalValue = 0;
        appData.invoices.filter(inv => inv.date >= startDate && inv.date <= endDate).forEach(inv => {
            inv.items.forEach(item => {
                if (item.isMisc) {
                    const itemValue = item.qty * item.rate * (1 + item.gst / 100);
                    data.push([formatDateToDDMMYYYY(inv.date), item.name, item.qty, item.rate.toFixed(2), itemValue.toFixed(2), inv.vendor, inv.totalAmount.toFixed(2)]);
                    totalValue += itemValue;
                }
            });
        });
        if (data.length === 0) { alert('No miscellaneous purchase data found.'); return; }
        const totalRow = ['', '', '', '', { content: 'TOTAL', styles: { halign: 'right' } }, totalValue.toFixed(2), ''];
        generateReport(`Misc Purchase Report (${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)})`,
            ["Date", "Item Name", "Qty", "Rate (excl. GST)", "Value (incl. GST)", "Vendor", "Bill Amt"], data, totalRow, format);
    }
    
    function generateMiscIssuedReport(format) {
        const startDate = document.getElementById('miscReportStartDate').value;
        const endDate = document.getElementById('miscReportEndDate').value;
        if (!startDate || !endDate) { alert('Please select a start and end date.'); return; }

        let data = [], grandTotalValue = 0, requisitionsByDept = {};
        appData.requisitions.filter(req => req.date >= startDate && req.date <= endDate).forEach(req => {
            req.items.forEach(item => {
                if (item.isMisc) {
                    const itemValue = item.qty * getLastMiscPurchasePrice(item.name, req.date);
                    if (!requisitionsByDept[req.department]) requisitionsByDept[req.department] = { items: [], total: 0 };
                    requisitionsByDept[req.department].items.push([formatDateToDDMMYYYY(req.date), item.name, item.qty, itemValue.toFixed(2), formatDateToDDMMYYYY(req.date), req.slipNo]);
                    requisitionsByDept[req.department].total += itemValue;
                    grandTotalValue += itemValue;
                }
            });
        });
        
        Object.keys(requisitionsByDept).sort().forEach(deptName => {
            data.push([{ content: `DEPT: ${deptName}`, colSpan: 6, styles: { fontStyle: 'bold', fillColor: '#d3d3d3' } }]);
            data.push(...requisitionsByDept[deptName].items);
            data.push(['', '', { content: 'Total:', styles: { halign: 'right' } }, { content: requisitionsByDept[deptName].total.toFixed(2), styles: { fontStyle: 'bold' } }, '', '']);
        });

        if (data.length === 0) { alert('No miscellaneous issue data found.'); return; }
        const totalRow = ['', '', { content: 'Grand Total:', styles: { halign: 'right' } }, { content: grandTotalValue.toFixed(2), styles: { fontStyle: 'bold' } }, '', ''];
        generateReport(`Misc Issued Report (${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)})`,
            ["Date", "Item Name", "Qty", "Value Consumed", "Req. Date", "Req. No."], data, totalRow, format);
    }
    
   // NEW FUNCTION: 1. Builds the ledger data and shows it in the modal
// REPLACE THIS ENTIRE FUNCTION
function previewItemLedgerReport() {
    const itemId = parseInt(document.getElementById('ledgerItemSelect').value);
    const startDate = document.getElementById('ledgerReportStartDate').value;
    const endDate = document.getElementById('ledgerReportEndDate').value;

    if (!itemId || !startDate || !endDate) {
        alert('Please select an item and a date range.');
        return;
    }
    const item = appData.items.find(i => i.id === itemId);
    if (!item) {
        alert('Item not found.');
        return;
    }

    // --- 1. Calculate Opening Stock ---
    let openingStock = item.stock;
    const today = new Date().toISOString().split('T')[0];
    
    // Filter active challans (not invoiced)
    const activeChallans = appData.challans.filter(c => c.status !== 'invoiced');
    const txs = [...appData.invoices, ...activeChallans, ...appData.requisitions];

    // Reverse calculation for Opening Stock
    txs.filter(tx => new Date(tx.date) >= new Date(startDate) && new Date(tx.date) <= new Date(today))
       .forEach(tx => {
            tx.items.forEach(txItem => {
                if (txItem.itemId === itemId && !txItem.isMisc) {
                    if (tx.vendor) openingStock -= txItem.qty; 
                    if (tx.department) openingStock += txItem.qty; 
                }
            });
       });

    // --- 2. Collect Transactions ---
    let transactions = [];
    txs.filter(tx => new Date(tx.date) >= new Date(startDate) && new Date(tx.date) <= new Date(endDate))
       .forEach(tx => {
            tx.items.forEach(txItem => {
                if (txItem.itemId === itemId && !txItem.isMisc) {
                    // Purchase Side
                    if (tx.vendor) {
                        let typeLabel = '';
                        let subText = '';
                        let refNo = '';

                        if (tx.status) { 
                            // It is a Challan
                            typeLabel = 'CHALLAN';
                            refNo = tx.number;
                            subText = '<span style="color: #e67e22; font-size: 11px;">(Pending Invoice)</span>';
                        } else {
                            // It is an Invoice
                            typeLabel = 'PURCHASE';
                            refNo = tx.number;
                            // Get Associated Challan Numbers
                            if (tx.challans && tx.challans.length > 0) {
                                const chNumbers = tx.challans.map(c => c.number).join(', ');
                                subText = `<span style="color: #555; font-size: 11px;">(Ref Ch: ${chNumbers})</span>`;
                            }
                        }

                        transactions.push({ 
                            date: tx.date, 
                            type: typeLabel, 
                            refNo: refNo, 
                            subText: subText, // New Property for extra info
                            details: `${tx.vendor}`, 
                            qtyIn: txItem.qty, 
                            qtyOut: 0 
                        });
                    }
                    // Issue Side
                    if (tx.department) {
                        transactions.push({ 
                            date: tx.date, 
                            type: 'ISSUE', 
                            refNo: `${tx.slipNo}`, 
                            subText: '',
                            details: `${tx.department}`, 
                            qtyIn: 0, 
                            qtyOut: txItem.qty 
                        });
                    }
                }
            });
       });

    // --- 3. Sort ---
   // --- 3. Sort (Updated Logic) ---
   transactions.sort((a, b) => {
        // ধাপ ১: তারিখ তুলনা (পুরানো তারিখ উপরে, নতুন তারিখ নিচে)
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        
        // যদি তারিখ আলাদা হয়, তবে তারিখ অনুযায়ী সাজাবে
        if (dateA - dateB !== 0) {
            return dateA - dateB; 
        }

        // ধাপ ২: যদি তারিখ একই হয় (যেমন ১০ তারিখ), তবে Purchase/Challan আগে থাকবে
        const isInputA = (a.type === 'PURCHASE' || a.type === 'CHALLAN');
        const isInputB = (b.type === 'PURCHASE' || b.type === 'CHALLAN');

        if (isInputA && !isInputB) return -1; // Purchase উপরে
        if (!isInputA && isInputB) return 1;  // Issue নিচে

        // ধাপ ৩: যদি তারিখ এবং টাইপ (Issue) একই হয়, তবে স্লিপ নম্বর অনুযায়ী সাজাবে
        // এখানে ডিপার্টমেন্ট নাম দেখা হবে না, শুধু স্লিপের সংখ্যা দেখা হবে
        const numA = parseInt(String(a.refNo || '').replace(/[^0-9]/g, ''), 10) || 0;
        const numB = parseInt(String(b.refNo || '').replace(/[^0-9]/g, ''), 10) || 0;

        // ছোট নম্বর (যেমন R-98) উপরে, বড় নম্বর (যেমন R-100) নিচে
        return numA - numB; 
    });
    
    // --- 4. Render Header ---
    const headerEl = document.getElementById('itemLedgerReportHeader');
    headerEl.innerHTML = `
        <h3 style="color: var(--primary-color); margin: 0;">${item.name}</h3>
        <div style="margin-top:5px; font-size: 14px;">
            <strong>Code:</strong> ${item.code} | 
            <strong>Stock Page No:</strong> <span style="color: red; font-weight: bold;">${item.stockPage}</span> | 
            <strong>Current Stock:</strong> <span style="color: var(--text-red);">${item.stock} ${item.unit}</span>
        </div>
    `;

    // --- 5. Render Table ---
    const tableBody = document.getElementById('itemLedgerReportBody');
    tableBody.innerHTML = ''; 
    
    let balance = openingStock;
    
    // Opening Row
    tableBody.innerHTML += `
        <tr style="background-color: #f8f9fa; font-weight: bold;">
            <td>${formatDateToDDMMYYYY(startDate)}</td>
            <td>OPENING</td>
            <td colspan="3">Opening Balance</td>
            <td>${balance}</td>
        </tr>
    `;

    transactions.forEach(t => {
        balance = balance + t.qtyIn - t.qtyOut;
        const rowClass = (t.type === 'PURCHASE' || t.type === 'CHALLAN') ? 'ledger-row-purchase' : 'ledger-row-issue';
        
        // Combine Ref No and SubText (Challan No / Pending Status)
        const description = `<strong>${t.refNo}</strong> <br> ${t.subText} <br> <span style="font-size:12px; color:#666;">(${t.details})</span>`;

        tableBody.innerHTML += `
            <tr class="${rowClass}">
                <td>${formatDateToDDMMYYYY(t.date)}</td>
                <td>${t.type}</td>
                <td>${description}</td>
                <td style="color: green; font-weight:bold;">${t.qtyIn > 0 ? t.qtyIn : '-'}</td>
                <td style="color: red; font-weight:bold;">${t.qtyOut > 0 ? t.qtyOut : '-'}</td>
                <td style="font-weight: bold;">${balance}</td>
            </tr>
        `;
    });
    
    if (transactions.length === 0) {
         tableBody.innerHTML += `<tr><td colspan="6" style="text-align:center;">No transactions found for this period.</td></tr>`;
    }

    document.getElementById('itemLedgerReportTitle').textContent = `Item Ledger: ${item.name}`;
    openModal('itemLedgerReportModal');
}

// NEW FUNCTION: 2. Handles the export buttons inside the new modal
// REPLACE THIS ENTIRE FUNCTION
function exportItemLedgerReport(format) {
    const itemId = parseInt(document.getElementById('ledgerItemSelect').value);
    const startDate = document.getElementById('ledgerReportStartDate').value;
    const endDate = document.getElementById('ledgerReportEndDate').value;
    const item = appData.items.find(i => i.id === itemId);
    
    if (!item) { alert("Item not found."); return; }

    // --- 1. Opening Stock ---
    let openingStock = item.stock;
    const today = new Date().toISOString().split('T')[0];
    
    const activeChallans = appData.challans.filter(c => c.status !== 'invoiced');
    const txs = [...appData.invoices, ...activeChallans, ...appData.requisitions];
    
    txs.filter(tx => new Date(tx.date) >= new Date(startDate) && new Date(tx.date) <= new Date(today))
       .forEach(tx => {
            tx.items.forEach(txItem => {
                if (txItem.itemId === itemId && !txItem.isMisc) {
                    if (tx.vendor) openingStock -= txItem.qty; 
                    if (tx.department) openingStock += txItem.qty;
                }
            });
       });

    // --- 2. Build Data ---
    let transactions = [];
    txs.filter(tx => new Date(tx.date) >= new Date(startDate) && new Date(tx.date) <= new Date(endDate))
       .forEach(tx => {
            tx.items.forEach(txItem => {
                if (txItem.itemId === itemId && !txItem.isMisc) {
                    // Purchase Side
                    if (tx.vendor) {
                        let typeLabel = '';
                        let refText = '';

                        if (tx.status) {
                            // Challan
                            typeLabel = 'CHALLAN';
                            refText = `${tx.number}\n(Pending Invoice)`;
                        } else {
                            // Invoice
                            typeLabel = 'PURCHASE';
                            refText = tx.number;
                            if (tx.challans && tx.challans.length > 0) {
                                const chNumbers = tx.challans.map(c => c.number).join(', ');
                                refText += `\n(Ch: ${chNumbers})`; // Add line break for PDF/Excel
                            }
                        }

                        transactions.push({ 
                            date: tx.date, type: typeLabel, 
                            ref: refText, party: tx.vendor,
                            qtyIn: txItem.qty, qtyOut: 0 
                        });
                    }
                    // Issue Side
                    if (tx.department) {
                        transactions.push({ 
                            date: tx.date, type: 'ISSUE', 
                            ref: tx.slipNo, party: tx.department,
                            qtyIn: 0, qtyOut: txItem.qty 
                        });
                    }
                }
            });
       });
    
    transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

    // --- 3. Format Export ---
    const headers = ["Date", "Type", "Ref No / Details", "Party / Dept", "Qty In", "Qty Out", "Balance"];
    let data = [], balance = openingStock;
    
    data.push([formatDateToDDMMYYYY(startDate), 'OPENING', '-', 'Opening Balance', '-', '-', openingStock]);

    transactions.forEach(t => {
        balance = balance + t.qtyIn - t.qtyOut;
        data.push([
            formatDateToDDMMYYYY(t.date), 
            t.type, 
            t.ref, 
            t.party, 
            t.qtyIn > 0 ? t.qtyIn : '', 
            t.qtyOut > 0 ? t.qtyOut : '', 
            balance
        ]);
    });
    
    const title = `Ledger_${item.name.replace(/ /g, '_')}`;

    if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Item Ledger: ${item.name}`, 14, 15);
        doc.autoTable({
            head: [headers],
            body: data,
            startY: 25,
            didParseCell: function (data) {
                if (data.section === 'body' && (data.row.raw[1] === 'PURCHASE' || data.row.raw[1] === 'CHALLAN')) {
                    data.cell.styles.fillColor = [212, 237, 218];
                }
            }
        });
        doc.save(`${title}.pdf`);
    } else if (format === 'excel') {
        const excelData = [
            [`Item Name:`, item.name],
            [`Current Stock:`, `${item.stock} ${item.unit}`],
            [], 
            headers,
            ...data
        ];
        const worksheet = XLSX.utils.aoa_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Ledger");
        XLSX.writeFile(workbook, `${title}.xlsx`);
    }
}

    // --- MODAL MANAGEMENT & MERGE ---
    function toSafeId(value) {
        return String(value).replace(/[^a-zA-Z0-9]/g, '');
    }

    function toggleEditMode(type, originalId) {
        const safeId = toSafeId(originalId);
        document.getElementById(`name-${type}-${safeId}`).classList.add('hidden');
        document.getElementById(`input-${type}-${safeId}`).classList.remove('hidden');
        document.getElementById(`edit-btn-${type}-${safeId}`).classList.add('hidden');
        document.getElementById(`save-btn-${type}-${safeId}`).classList.remove('hidden');
    }

    function updateEntity(type, originalId) {
        const safeId = toSafeId(originalId);
        const inputElement = document.getElementById(`input-${type}-${safeId}`);
        const newValueRaw = inputElement.value.trim();

        if (!newValueRaw) {
            alert('Value cannot be empty.');
            return;
        }

        let success = false;
        switch (type) {
            case 'vendor':
                success = updateVendor(originalId, newValueRaw);
                break;
            case 'department':
                success = updateDepartment(originalId, newValueRaw);
                break;
            case 'measure':
                success = updateMeasure(originalId, newValueRaw);
                break;
            case 'gst':
                const newGst = parseFloat(newValueRaw);
                if (isNaN(newGst)) {
                    alert('GST must be a valid number.');
                    return;
                }
                success = updateGst(originalId, newGst);
                break;
        }

        if (success) {
            saveData();
            renderAll();
        }
    }
// --- MANAGE MISCELLANEOUS ITEMS FUNCTIONS ---

function renderMiscItemListForEditing() {
    const listBody = document.getElementById('manageMiscItemsBody');
    if (!listBody) return;

    const searchInput = document.getElementById('manageMiscSearch');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

    let itemsToRender = [...appData.miscItems];
    if (searchTerm) {
        itemsToRender = itemsToRender.filter(item => 
            item.name.toLowerCase().includes(searchTerm)
        );
    }
    
    const start = (currentManageMiscPage - 1) * manageMiscItemsPerPage;
    const end = start + manageMiscItemsPerPage;
    const paginatedItems = itemsToRender.slice(start, end);

    listBody.innerHTML = '';
    
    paginatedItems.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
        const row = `
            <tr>
                <td>${item.name}</td>
                <td>${item.stock}</td>
                <td>${item.unit}</td>
                <td>
                    <button class="btn-link" onclick="openEditMiscItemModal(${item.id})">Edit</button>
                </td>
            </tr>
        `;
        listBody.innerHTML += row;
    });

    renderPagination(itemsToRender, 'manageMiscPaginationControls', changeManageMiscPage, manageMiscItemsPerPage, currentManageMiscPage);
}

function openEditMiscItemModal(id) {
    const item = appData.miscItems.find(i => i.id === id);
    if (item) {
        document.getElementById('editMiscItemId').value = item.id;
        document.getElementById('editMiscItemName').value = item.name;
        
        const unitDropdown = document.getElementById('editMiscItemUnit');
        populateDropdown(unitDropdown, appData.measures);
        unitDropdown.value = item.unit;
        
        openModal('editMiscItemModal');
    }
}

function updateMiscItem() {
    const itemId = parseInt(document.getElementById('editMiscItemId').value);
    const newName = document.getElementById('editMiscItemName').value.trim();
    const newUnit = document.getElementById('editMiscItemUnit').value;

    if (!newName) {
        alert('Item name cannot be empty.');
        return;
    }

    const itemToUpdate = appData.miscItems.find(i => i.id === itemId);
    if (!itemToUpdate) return;
    
    const oldName = itemToUpdate.name;

    const nameExists = appData.miscItems.some(i => i.name.toLowerCase() === newName.toLowerCase() && i.id !== itemId);
    const storeItemNameExists = appData.items.some(i => i.name.toLowerCase() === newName.toLowerCase());
    
    if (nameExists || storeItemNameExists) {
        alert(`An item named "${newName}" already exists. Please choose a unique name.`);
        return;
    }

    if (!confirm(`Are you sure you want to rename "${oldName}" to "${newName}"? This will update ALL past invoices, challans, and requisitions.`)) {
        return;
    }

    itemToUpdate.name = newName;
    itemToUpdate.unit = newUnit;

    const transactions = [...appData.invoices, ...appData.challans, ...appData.requisitions];
    transactions.forEach(tx => {
        tx.items.forEach(item => {
            if (item.isMisc && item.name === oldName) {
                item.name = newName;
                item.unit = newUnit;
            }
        });
    });

    saveData();
    closeModal('editMiscItemModal');
    renderAll();
    alert('Miscellaneous item updated successfully across all records!');
}

function changeManageMiscPage(page) {
    currentManageMiscPage = page;
    renderMiscItemListForEditing();
}



    function updateVendor(id, newName) {
        const vendor = appData.vendors.find(v => v.id === id);
        if (!vendor) return false;
        if (appData.vendors.some(v => v.name.toLowerCase() === newName.toLowerCase() && v.id !== id)) {
            alert(`Vendor name "${newName}" already exists.`);
            return false;
        }
        const oldName = vendor.name;
        if (oldName === newName) {
            renderVendorList();
            return false;
        }
        if (!confirm(`Are you sure you want to rename vendor "${oldName}" to "${newName}"? This will update all related invoices and challans.`)) {
            renderVendorList();
            return false;
        }
        vendor.name = newName;
        appData.invoices.forEach(inv => { if (inv.vendor === oldName) inv.vendor = newName; });
        appData.challans.forEach(cha => { if (cha.vendor === oldName) cha.vendor = newName; });
        return true;
    }

    function updateDepartment(id, newName) {
        const department = appData.departments.find(d => d.id === id);
        if (!department) return false;
        if (appData.departments.some(d => d.name.toLowerCase() === newName.toLowerCase() && d.id !== id)) {
            alert(`Department name "${newName}" already exists.`);
            return false;
        }
        const oldName = department.name;
        if (oldName === newName) {
            renderDepartmentList();
            return false;
        }
        if (!confirm(`Are you sure you want to rename department "${oldName}" to "${newName}"? This will update all related requisitions.`)) {
            renderDepartmentList();
            return false;
        }
        department.name = newName;
        appData.requisitions.forEach(req => { if (req.department === oldName) req.department = newName; });
        return true;
    }

    function updateMeasure(oldName, newName) {
        const measureIndex = appData.measures.findIndex(m => m === oldName);
        if (measureIndex === -1) return false;
        if (appData.measures.some(m => m.toLowerCase() === newName.toLowerCase() && m.toLowerCase() !== oldName.toLowerCase())) {
            alert(`Measure unit "${newName}" already exists.`);
            return false;
        }
        if (oldName === newName) {
            renderMeasureList();
            return false;
        }
        if (!confirm(`Are you sure you want to rename measure "${oldName}" to "${newName}"? This will update all items using this unit.`)) {
            renderMeasureList();
            return false;
        }
        appData.measures[measureIndex] = newName;
        appData.items.forEach(item => { if (item.unit === oldName) item.unit = newName; });
        if (appData.miscItemDefaults.unit === oldName) appData.miscItemDefaults.unit = newName;
        [...appData.invoices, ...appData.challans, ...appData.requisitions].forEach(tx => {
            tx.items.forEach(item => { if (item.isMisc && item.unit === oldName) item.unit = newName; });
        });
        return true;
    }

    function updateGst(oldValue, newValue) {
        const gstIndex = appData.gsts.findIndex(g => g === oldValue);
        if (gstIndex === -1) return false;
        if (appData.gsts.some(g => g === newValue && g !== oldValue)) {
            alert(`GST value "${newValue}%" already exists.`);
            return false;
        }
        if (oldValue === newValue) {
            renderGstList();
            return false;
        }
        if (!confirm(`Are you sure you want to change GST from ${oldValue}% to ${newValue}%? This will update all invoice items using this rate.`)) {
            renderGstList();
            return false;
        }
        appData.gsts[gstIndex] = newValue;
        appData.invoices.forEach(inv => {
            inv.items.forEach(item => { if (item.gst === oldValue) item.gst = newValue; });
        });
        return true;
    }

    function renderMeasureList() {
        const listElement = document.getElementById('measureList');
        listElement.innerHTML = '';
        if (appData.measures.length === 0) { listElement.innerHTML = '<p>No items found.</p>'; }
        
        [...appData.measures].sort().forEach(measure => {
            const safeId = toSafeId(measure);
            listElement.innerHTML += `
                <div class="modal-list-item">
                    <span id="name-measure-${safeId}">${measure}</span>
                    <input type="text" id="input-measure-${safeId}" value="${measure}" class="hidden" style="flex-grow: 1; margin: 0 10px;">
                    <div>
                        <button id="edit-btn-measure-${safeId}" class="btn-link" onclick="toggleEditMode('measure', '${measure}')">Edit</button>
                        <button id="save-btn-measure-${safeId}" class="btn-link btn-success hidden" onclick="updateEntity('measure', '${measure}')">Save</button>
                        <button class="btn-link btn-danger" onclick="deleteMeasure('${measure}')">Delete</button>
                    </div>
                </div>`;
        });
        renderMeasureMergeUI();
    }
    
    function addMeasure() {
        const newMeasureName = document.getElementById('newMeasureName').value.trim();
        if (newMeasureName && !appData.measures.some(m => m.toLowerCase() === newMeasureName.toLowerCase())) {
            appData.measures.push(newMeasureName);
            saveData();
            renderAll();
            document.getElementById('newMeasureName').value = '';
        }
    }

    function deleteMeasure(measureToDelete) {
        appData.measures = appData.measures.filter(measure => measure !== measureToDelete);
        saveData();
        renderAll();
    }

    function renderVendorList() {
        const listElement = document.getElementById('vendorList');
        listElement.innerHTML = '';
        if (appData.vendors.length === 0) { listElement.innerHTML = '<p>No items found.</p>'; return; }

        [...appData.vendors].sort((a, b) => a.name.localeCompare(b.name)).forEach(vendor => {
            const safeId = toSafeId(vendor.id);
            listElement.innerHTML += `
                <div class="modal-list-item">
                    <span id="name-vendor-${safeId}">${vendor.name}</span>
                    <input type="text" id="input-vendor-${safeId}" value="${vendor.name}" class="hidden" style="flex-grow: 1; margin: 0 10px;">
                    <div>
                        <button id="edit-btn-vendor-${safeId}" class="btn-link" onclick="toggleEditMode('vendor', ${vendor.id})">Edit</button>
                        <button id="save-btn-vendor-${safeId}" class="btn-link btn-success hidden" onclick="updateEntity('vendor', ${vendor.id})">Save</button>
                        <button class="btn-link btn-danger" onclick="deleteVendor(${vendor.id})">Delete</button>
                    </div>
                </div>`;
        });
    }
    
    function addVendor() {
        const newVendorName = document.getElementById('newVendorName').value.trim();
        if (newVendorName && !appData.vendors.some(v => v.name.toLowerCase() === newVendorName.toLowerCase())) {
            appData.vendors.push({ id: getNextId('vendor'), name: newVendorName });
            saveData();
            renderAll();
            document.getElementById('newVendorName').value = '';
        }
    }
    
    function deleteVendor(id) {
        appData.vendors = appData.vendors.filter(vendor => vendor.id !== id);
        saveData();
        renderAll();
    }

    function renderDepartmentList() {
        const listElement = document.getElementById('departmentList');
        listElement.innerHTML = '';
        if (appData.departments.length === 0) { listElement.innerHTML = '<p>No items found.</p>'; }

        [...appData.departments].sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
            const safeId = toSafeId(dept.id);
            listElement.innerHTML += `
                <div class="modal-list-item">
                    <span id="name-department-${safeId}">${dept.name}</span>
                    <input type="text" id="input-department-${safeId}" value="${dept.name}" class="hidden" style="flex-grow: 1; margin: 0 10px;">
                    <div>
                        <button id="edit-btn-department-${safeId}" class="btn-link" onclick="toggleEditMode('department', ${dept.id})">Edit</button>
                        <button id="save-btn-department-${safeId}" class="btn-link btn-success hidden" onclick="updateEntity('department', ${dept.id})">Save</button>
                        <button class="btn-link btn-danger" onclick="deleteDepartment(${dept.id})">Delete</button>
                    </div>
                </div>`;
        });
        renderDepartmentMergeUI();
    }

    function addDepartment() {
        const newDepartmentName = document.getElementById('newDepartmentName').value.trim();
        if (newDepartmentName && !appData.departments.some(d => d.name.toLowerCase() === newDepartmentName.toLowerCase())) {
            appData.departments.push({ id: getNextId('department'), name: newDepartmentName });
            saveData();
            renderAll();
            document.getElementById('newDepartmentName').value = '';
        }
    }

    function deleteDepartment(id) {
        appData.departments = appData.departments.filter(dept => dept.id !== id);
        saveData();
        renderAll();
    }

    function renderGstList() {
        const listElement = document.getElementById('gstList');
        listElement.innerHTML = '';
        if (appData.gsts.length === 0) { listElement.innerHTML = '<p>No items found.</p>'; return; }

        [...appData.gsts].sort((a, b) => a - b).forEach(gstValue => {
            const safeId = toSafeId(gstValue);
            listElement.innerHTML += `
                <div class="modal-list-item">
                    <span id="name-gst-${safeId}">${gstValue}%</span>
                    <input type="number" id="input-gst-${safeId}" value="${gstValue}" class="hidden" style="flex-grow: 1; margin: 0 10px;">
                    <div>
                        <button id="edit-btn-gst-${safeId}" class="btn-link" onclick="toggleEditMode('gst', ${gstValue})">Edit</button>
                        <button id="save-btn-gst-${safeId}" class="btn-link btn-success hidden" onclick="updateEntity('gst', ${gstValue})">Save</button>
                        <button class="btn-link btn-danger" onclick="deleteGst(${gstValue})">Delete</button>
                    </div>
                </div>`;
        });
    }

    function addGst() {
        const newGstValue = parseFloat(document.getElementById('newGstValue').value);
        if (!isNaN(newGstValue) && !appData.gsts.includes(newGstValue)) {
            appData.gsts.push(newGstValue);
            saveData();
            renderAll();
            document.getElementById('newGstValue').value = '';
        }
    }

    function deleteGst(valueToDelete) {
        appData.gsts = appData.gsts.filter(gst => gst !== valueToDelete);
        saveData();
        renderAll();
    }
    function calculateEditInvoiceItemValue() {
        const qty = parseFloat(document.getElementById('editInvoiceSuppliedQty').value) || 0;
        const rate = parseFloat(document.getElementById('editInvoiceRate').value) || 0;
        const gst = parseFloat(document.getElementById('editInvoiceGst').value) || 0;
        const resultEl = document.getElementById('editInvoiceItemValue');
        if(resultEl) {
            const value = qty * rate * (1 + gst / 100);
            resultEl.innerText = `Item Value: ${value.toFixed(2)}`;
        }
    }

    // --- MERGE FUNCTIONALITY ---
    function renderDepartmentMergeUI() {
        const container = document.getElementById('departmentMergeSection');
        container.innerHTML = `
            <div class="form-grid">
                <div class="form-group">
                    <label>Merge From (Incorrect)</label>
                    <select id="deptMergeFrom"></select>
                </div>
                <div class="form-group">
                    <label>Merge Into (Correct)</label>
                    <select id="deptMergeTo"></select>
                </div>
            </div>
            <button class="btn btn-danger mt-20" onclick="mergeDepartments()">Merge Departments</button>
        `;
        const depts = [...appData.departments].sort((a, b) => a.name.localeCompare(b.name));
        populateDropdown(document.getElementById('deptMergeFrom'), depts, true, 'name', 'id');
        populateDropdown(document.getElementById('deptMergeTo'), depts, true, 'name', 'id');
    }

    function mergeDepartments() {
        const fromId = parseInt(document.getElementById('deptMergeFrom').value);
        const toId = parseInt(document.getElementById('deptMergeTo').value);

        if (!fromId || !toId || fromId === toId) {
            alert('Please select two different departments to merge.');
            return;
        }

        const fromDept = appData.departments.find(d => d.id === fromId);
        const toDept = appData.departments.find(d => d.id === toId);

        if (!confirm(`Are you sure you want to merge ALL records from "${fromDept.name}" into "${toDept.name}"? The "${fromDept.name}" department will be permanently deleted.`)) {
            return;
        }

        appData.requisitions.forEach(req => {
            if (req.department === fromDept.name) {
                req.department = toDept.name;
            }
        });

        appData.departments = appData.departments.filter(d => d.id !== fromId);
        saveData();
        alert('Departments merged successfully.');
        renderAll();
        closeModal('departmentModal');
    }

    function renderMeasureMergeUI() {
        const container = document.getElementById('measureMergeSection');
        container.innerHTML = `
            <div class="form-grid">
                <div class="form-group">
                    <label>Merge From (Incorrect)</label>
                    <select id="measureMergeFrom"></select>
                </div>
                <div class="form-group">
                    <label>Merge Into (Correct)</label>
                    <select id="measureMergeTo"></select>
                </div>
            </div>
            <button class="btn btn-danger mt-20" onclick="mergeMeasures()">Merge Units</button>
        `;
        const measures = [...appData.measures].sort();
        populateDropdown(document.getElementById('measureMergeFrom'), measures);
        populateDropdown(document.getElementById('measureMergeTo'), measures);
    }

    function mergeMeasures() {
        const fromName = document.getElementById('measureMergeFrom').value;
        const toName = document.getElementById('measureMergeTo').value;

        if (!fromName || !toName || fromName === toName) {
            alert('Please select two different units to merge.');
            return;
        }

        if (!confirm(`Are you sure you want to merge ALL items from unit "${fromName}" into "${toName}"? The "${fromName}" unit will be permanently deleted.`)) {
            return;
        }
        
        // Update all items and transactions
        updateMeasure(fromName, toName);
        // Delete the old measure
        appData.measures = appData.measures.filter(m => m !== fromName);

        saveData();
        alert('Units merged successfully.');
        renderAll();
        closeModal('measureModal');
    }
    
    function findAndMergeDuplicateRequisitions() {
        const requisitionsBySlipNo = {};
        appData.requisitions.forEach(req => {
            // Ensure slipNo is a string and handle potential undefined cases
            const slipNo = String(req.slipNo || '').trim().toLowerCase();
            if (slipNo) { // Only process requisitions with a valid slip number
                if (!requisitionsBySlipNo[slipNo]) {
                    requisitionsBySlipNo[slipNo] = [];
                }
                requisitionsBySlipNo[slipNo].push(req);
            }
        });

        const duplicates = Object.values(requisitionsBySlipNo).filter(group => group.length > 1);

        if (duplicates.length === 0) {
            alert('No duplicate requisition slip numbers found.');
            return;
        }

        const modalBody = document.getElementById('requisitionMergeModalBody');
        let html = '<p>The following duplicate requisition slips were found. Please review each group and click "Merge This Group" to combine them into a single entry.</p>';
        
        duplicates.forEach((group) => {
            const slipNo = group[0].slipNo;
            const totalItems = group.reduce((sum, req) => sum + req.items.length, 0);
            // Correctly stringify the array of IDs for the onclick function
            const reqIdsString = JSON.stringify(group.map(g => g.id));

            html += `
                <div style="border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4>Slip No: ${slipNo} (${group.length} entries, ${totalItems} total items)</h4>
                    <p><strong>Date:</strong> ${formatDateToDDMMYYYY(group[0].date)}, <strong>Department:</strong> ${group[0].department}</p>
                    <button class="btn btn-primary" onclick='confirmRequisitionMerge(${reqIdsString})'>Merge This Group</button>
                    <hr>
                    <small><strong>Details of entries to be merged:</strong><ul>
                        ${group.map(req => `<li>ID ${req.id}: ${req.items.map(i => `${i.name} (x${i.qty})`).join(', ')}</li>`).join('')}
                    </ul></small>
                </div>
            `;
        });
        
        modalBody.innerHTML = html;
        openModal('requisitionMergeModal');
    }

    function confirmRequisitionMerge(reqIds) {
        const requisitionsToMerge = appData.requisitions.filter(req => reqIds.includes(req.id));
        if (requisitionsToMerge.length < 2) {
            alert('Error: Not enough requisitions to merge.');
            return;
        }

        const firstReq = requisitionsToMerge[0];
        const slipNo = firstReq.slipNo;

        if (!confirm(`Are you sure you want to merge ${requisitionsToMerge.length} requisitions with Slip No. "${slipNo}" into a single entry? This action cannot be undone.`)) {
            return;
        }

        const allItems = requisitionsToMerge.flatMap(req => req.items);
        const mergedItemsMap = new Map();

        allItems.forEach(item => {
            // Use a composite key to uniquely identify an item (ID for store items, name for misc)
            const key = item.isMisc ? `misc-${item.name}` : `store-${item.itemId}`;
            if (mergedItemsMap.has(key)) {
                mergedItemsMap.get(key).qty += item.qty;
            } else {
                // Store a copy of the item to avoid mutation issues
                mergedItemsMap.set(key, { ...item });
            }
        });

        const newRequisition = {
            id: getNextId('requisition'),
            slipNo: slipNo,
            date: firstReq.date,
            department: firstReq.department,
            items: Array.from(mergedItemsMap.values()),
            type: firstReq.type
        };

        // Remove old requisitions by filtering them out
        appData.requisitions = appData.requisitions.filter(req => !reqIds.includes(req.id));
        // Add the new merged one
        appData.requisitions.push(newRequisition);

        saveData();
        alert(`Requisitions for slip number "${slipNo}" have been successfully merged.`);
        closeModal('requisitionMergeModal');
        filterRequisitionList(); // Refresh the view
    }
    function autoMergeAllDuplicateRequisitions() {
    // ধাপ ১: একটি ইউনিক 'কী' ব্যবহার করে সমস্ত রিকুইজিশনকে গ্রুপ করা
    const requisitionGroups = new Map();

    appData.requisitions.forEach(req => {
        // একটি নিরাপদ ইউনিক কী তৈরি করা হচ্ছে (slipNo-date-department)
        const uniqueKey = `${String(req.slipNo).trim()}-${req.date}-${req.department}`;
        
        if (!requisitionGroups.has(uniqueKey)) {
            requisitionGroups.set(uniqueKey, []);
        }
        requisitionGroups.get(uniqueKey).push(req);
    });
    // ধাপ ২: যেসব গ্রুপে একাধিক রিকুইজিশন আছে, সেগুলোকে খুঁজে বের করা
    const duplicatesFound = [];
    for (const group of requisitionGroups.values()) {
        if (group.length > 1) {
            duplicatesFound.push(group);
        }
    }

    if (duplicatesFound.length === 0) {
        alert('কোনো ডুপ্লিকেট রিকুইজিশন খুঁজে পাওয়া যায়নি।');
        return;
    }

    // ধাপ ৩: ব্যবহারকারীর থেকে চূড়ান্ত অনুমতি নেওয়া
    const confirmation = confirm(
        `${duplicatesFound.length} টি ডুপ্লিকেট গ্রুপ পাওয়া গেছে।\n` +
        `আপনি কি সবগুলি স্বয়ংক্রিয়ভাবে মার্জ করতে চান? এই কাজটি আর ফেরানো যাবে না।`
    );

    if (!confirmation) {
        alert('মার্জ বাতিল করা হয়েছে।');
        return;
    }

    let mergedGroupCount = 0;
    let oldReqsToDeleteIds = [];

    // ধাপ ৪: প্রতিটি ডুপ্লিকেট গ্রুপের উপর মার্জ অপারেশন চালানো
    duplicatesFound.forEach(group => {
        const firstReq = group[0];
        const allItemsFromGroup = group.flatMap(req => req.items);
        
        const mergedItemsMap = new Map();
        allItemsFromGroup.forEach(item => {
            const itemKey = item.isMisc ? `misc-${item.name}` : `store-${item.itemId}`;
            if (mergedItemsMap.has(itemKey)) {
                mergedItemsMap.get(itemKey).qty += item.qty;
            } else {
                mergedItemsMap.set(itemKey, { ...item });
            }
        });

        // নতুন মার্জ করা রিকুইজিশন তৈরি
        const newMergedRequisition = {
            id: getNextId('requisition'),
            slipNo: firstReq.slipNo,
            date: firstReq.date,
            department: firstReq.department,
            items: Array.from(mergedItemsMap.values()),
            type: firstReq.type 
        };
        
        // পুরোনো রিকুইজিশনগুলোর আইডি সংগ্রহ করা
        group.forEach(req => oldReqsToDeleteIds.push(req.id));
        
        // নতুন রিকুইজিশনটি মূল ডেটাতে যোগ করা
        appData.requisitions.push(newMergedRequisition);
        mergedGroupCount++;
    });

    // ধাপ ৫: সমস্ত পুরোনো ডুপ্লিকেট রিকুইজিশন একসাথে ডিলিট করা
    appData.requisitions = appData.requisitions.filter(req => !oldReqsToDeleteIds.includes(req.id));

    // সবশেষে ডেটা সেভ এবং পেজ রিফ্রেশ
    saveData();
    filterRequisitionList(); // লিস্টটি রিফ্রেশ করার জন্য
    
    alert(`${mergedGroupCount} টি গ্রুপের ডুপ্লিকেট এন্ট্রি সফলভাবে মার্জ করা হয়েছে।`);
}

function populateYearDropdown() {
    const yearSelect = document.getElementById('supplyReportYear');
    const currentYear = new Date().getFullYear();
    const startYear = 2024; // You can change this to an earlier year if needed
    for (let year = currentYear; year >= startYear; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
}

function generateMonthlySupplyReport() {
    const month = parseInt(document.getElementById('supplyReportMonth').value);
    const year = parseInt(document.getElementById('supplyReportYear').value);

    if (!month || !year) {
        alert("Please select a month and a year.");
        return;
    }

    // Step 1: Initialize a map with ALL store items, setting their total quantity to 0.
    // This ensures every item appears in the report.
    const reportData = new Map();
    appData.items.forEach(item => {
        reportData.set(item.id, {
            name: item.name,
            code: item.code,
            unit: item.unit,
            totalQty: 0
        });
    });

    // Step 2: Add quantities from Challans for the selected month and year.
    appData.challans.forEach(challan => {
        const challanDate = new Date(challan.date);
        if (challanDate.getFullYear() === year && (challanDate.getMonth() + 1) === month) {
            challan.items.forEach(item => {
                if (!item.isMisc && reportData.has(item.itemId)) {
                    reportData.get(item.itemId).totalQty += item.qty;
                }
            });
        }
    });

    // Step 3: Add quantities from Invoices for the selected month and year.
    appData.invoices.forEach(invoice => {
        const invoiceDate = new Date(invoice.date);
        if (invoiceDate.getFullYear() === year && (invoiceDate.getMonth() + 1) === month) {
            invoice.items.forEach(item => {
                if (!item.isMisc && reportData.has(item.itemId)) {
                    reportData.get(item.itemId).totalQty += item.qty;
                }
            });
        }
    });

    // Step 4: Prepare and render the data in the modal's table.
    const finalData = Array.from(reportData.values()).sort((a, b) => a.name.localeCompare(b.name));
    const tableBody = document.getElementById('monthlySupplyReportBody');
    tableBody.innerHTML = ''; // Clear previous results

    if (finalData.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4">No store items found.</td></tr>`;
    } else {
        finalData.forEach(item => {
            const row = `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.code}</td>
                    <td><strong>${item.totalQty}</strong></td>
                    <td>${item.unit}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // Update modal title and open it
    const monthName = document.getElementById('supplyReportMonth').options[month - 1].text;
    document.getElementById('monthlySupplyReportTitle').textContent = `Monthly Supply Report - ${monthName} ${year}`;
    openModal('monthlySupplyReportModal');
}

function exportMonthlySupplyReport(format) {
    const monthName = document.getElementById('supplyReportMonth').options[document.getElementById('supplyReportMonth').value - 1].text;
    const year = document.getElementById('supplyReportYear').value;
    const title = `Monthly_Supply_Report_${monthName}_${year}`;
    const table = document.getElementById('monthlySupplyReportTable');
    
    if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Monthly Supply Report - ${monthName} ${year}`, 14, 15);
        doc.autoTable({ html: table, startY: 20 });
        doc.save(`${title}.pdf`);
    } else if (format === 'excel') {
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `${title}.xlsx`);
    }
}

//----PURCHSE VS ISSE REPORT----+REPORT----
// REPLACE THIS ENTIRE FUNCTION
function generateStockMovementReport() {
    const startDate = document.getElementById('stockMovementStartDate').value;
    const endDate = document.getElementById('stockMovementEndDate').value;

    if (!startDate || !endDate) {
        alert("Please select a Start and End date.");
        return;
    }

    // Step 1: Initialize a map for every store item.
    const reportData = new Map();
    appData.items.forEach(item => {
        reportData.set(item.id, {
            id: item.id,
            name: item.name,
            code: item.code,
            openingStock: 0,
            supplied: 0,
            issued: 0,
            closingStock: 0,
            suppliedValue: 0, 
            issuedValue: 0
        });
    });

    // Step 2: Calculate Opening Stock, Supplied Qty/Value, and Issued Qty/Value.
    reportData.forEach((data, itemId) => {
        let item = appData.items.find(i => i.id === itemId);
        let currentStock = item.stock;

        // FIX: Filter out invoiced challans to prevent double counting
        const activeChallans = appData.challans.filter(c => c.status !== 'invoiced');
        
        // Combine Invoices, Active Challans, and Requisitions
        const allTransactions = [...activeChallans, ...appData.invoices, ...appData.requisitions];

        allTransactions.forEach(tx => {
            const txDate = new Date(tx.date);
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);

            // Calculate supplied and issued within the date range
            if (txDate >= startDateObj && txDate <= endDateObj) {
                tx.items.forEach(txItem => {
                    if (txItem.itemId === itemId) {
                        if (tx.vendor) { 
                            data.supplied += txItem.qty;
                            if (txItem.rate !== undefined) {
                                // Purchase Value Calculation
                                data.suppliedValue += txItem.qty * txItem.rate * (1 + txItem.gst / 100);
                            }
                        } else if (tx.department) {
                            data.issued += txItem.qty;
                            // Issue Value Calculation (Using historical price helper)
                            data.issuedValue += txItem.qty * getLastPurchasePrice(itemId, tx.date);
                        }
                    }
                });
            }

            // Reverse transactions after the start date to calculate opening stock
            // This logic works backward from "Current Stock"
            if (txDate >= startDateObj) {
                 tx.items.forEach(txItem => {
                    if (txItem.itemId === itemId) {
                        if (tx.vendor) {
                            // If it was supplied, subtract it to go back in time
                            currentStock -= txItem.qty;
                        } else if (tx.department) {
                            // If it was issued, add it back to go back in time
                            currentStock += txItem.qty;
                        }
                    }
                });
            }
        });

        data.openingStock = currentStock;
        data.closingStock = data.openingStock + data.supplied - data.issued;
    });

    // Step 3: Render the report in the modal.
    const finalData = Array.from(reportData.values()).sort((a, b) => a.name.localeCompare(b.name));
    const tableBody = document.getElementById('stockMovementReportBody');
    tableBody.innerHTML = '';

    finalData.forEach(item => {
        const currentStockValue = item.closingStock * getMostRecentPurchasePrice(item.id);

        const row = `
            <tr>
                <td>${item.name}</td>
                <td>${item.code}</td>
                <td>${item.openingStock}</td>
                <td>${item.supplied > 0 ? `<strong>${item.supplied}</strong>` : 0}</td>
                <td>${item.suppliedValue > 0 ? item.suppliedValue.toFixed(2) : '0.00'}</td>
                <td>${item.issued > 0 ? `<strong>${item.issued}</strong>` : 0}</td>
                <td>${item.issuedValue > 0 ? item.issuedValue.toFixed(2) : '0.00'}</td>
                <td><strong>${item.closingStock}</strong></td>
                <td><strong>${currentStockValue > 0 ? currentStockValue.toFixed(2) : '0.00'}</strong></td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });

    document.getElementById('stockMovementReportTitle').textContent = `Stock Movement Report (${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)})`;
    openModal('stockMovementReportModal');
}


function exportStockMovementReport(format) {
    const startDate = document.getElementById('stockMovementStartDate').value;
    const endDate = document.getElementById('stockMovementEndDate').value;
    const title = `Stock_Movement_Report_${startDate}_to_${endDate}`;
    const table = document.getElementById('stockMovementReportTable');
    
    if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        doc.text(`Stock Movement Report (${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)})`, 14, 15);
        doc.autoTable({ html: table, startY: 20 });
        doc.save(`${title}.pdf`);
    } else if (format === 'excel') {
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `${title}.xlsx`);
    }

}

// Populates the new vendor and store item filter dropdowns
function populateInvoiceFilters() {
    const vendorSelect = document.getElementById('invoiceFilterVendor');
    const storeItemSelect = document.getElementById('invoiceFilterStoreItem');

    // Populate vendors
    if (vendorSelect) {
        const sortedVendors = [...appData.vendors].sort((a, b) => a.name.localeCompare(b.name));
        vendorSelect.innerHTML = '<option value="">All Vendors</option>'; // Default option
        sortedVendors.forEach(vendor => {
            vendorSelect.innerHTML += `<option value="${vendor.name}">${vendor.name}</option>`;
        });
    }

    // Populate store items
    if (storeItemSelect) {
        const sortedItems = [...appData.items].sort((a, b) => a.name.localeCompare(b.name));
        storeItemSelect.innerHTML = '<option value="">All Store Items</option>'; // Default option
        sortedItems.forEach(item => {
            // Use item.id as the value for a more reliable check
            storeItemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
        });
    }
}

// Shows or hides the store item dropdown based on the item type selection
function toggleStoreItemFilter() {
    const itemType = document.getElementById('invoiceFilterItemType').value;
    const storeItemContainer = document.getElementById('invoiceStoreItemFilterContainer');
    if (itemType === 'store') {
        storeItemContainer.style.display = 'block';
    } else {
        storeItemContainer.style.display = 'none';
        // Reset the selection when hiding to avoid it being part of the filter
        document.getElementById('invoiceFilterStoreItem').value = '';
    }
}

// Resets all filter fields to their default state
function clearInvoiceFilters() {
    document.getElementById('invoiceSearch').value = '';
    document.getElementById('invoiceFilterVendor').value = '';
    document.getElementById('invoiceFilterItemType').value = 'all';
    document.getElementById('invoiceFilterStoreItem').value = '';
    document.getElementById('invoiceFilterStartDate').value = '';
    document.getElementById('invoiceFilterEndDate').value = '';
    
    toggleStoreItemFilter(); // Hide the store item filter
    filterInvoiceList(); // Rerun the filter to show all results
}

// --- Login, Logout, and Permissions Functions ---

/**
 * Handle user login attempt.
 * এই ফাংশনটি লগইন বোতামে ক্লিক করলে কাজ করবে।
 */
function handleLogin(event) {
    event.preventDefault(); // ফর্ম সাবমিট হওয়া আটকায়
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    // ব্যবহারকারীর নাম এবং পাসওয়ার্ড চেক করা
    if (users[username] && users[username] === password) {
        currentUserRole = username; // ব্যবহারকারীর ভূমিকা সেভ করা
        
        loginError.textContent = '';
        loginContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        
        // সফল লগইনের পরে ডেটা লোড এবং অ্যাপ রেন্ডার করা
        loadData().then(() => {
            applyPermissions();
        });

    } else {
        loginError.textContent = 'Incorrect username or password.';
    }
}

/**
 * Handle user logout.
 * এই ফাংশনটি লগআউট বোতামে ক্লিক করলে কাজ করবে।
 */
function handleLogout() {
    if (confirm('Are you sure you want to log out?')) {
        currentUserRole = null;
        appContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
        document.getElementById('password').value = ''; // পাসওয়ার্ড ফিল্ড খালি করা
    }
}

/**
 * Apply UI restrictions based on the current user's role.
 * ব্যবহারকারীর ভূমিকার উপর ভিত্তি করে বোতাম সক্রিয় বা নিষ্ক্রিয় করবে।
 */
function applyPermissions() {
    const actionButtons = document.querySelectorAll('.action-btn');
    
    if (currentUserRole === 'Admin' || currentUserRole === 'Viewer') {
        // Admin বা Viewer হলে, সব অ্যাকশন বোতাম নিষ্ক্রিয় করা হবে
        console.log(`User role: ${currentUserRole}. Disabling action buttons.`);
        actionButtons.forEach(button => {
            button.classList.add('disabled-action');
        });
    } else if (currentUserRole === 'Data Entry') {
        // Data Entry ব্যবহারকারী হলে, সব অ্যাকশন বোতাম সক্রিয় করা হবে
        console.log(`User role: ${currentUserRole}. Enabling all functions.`);
        actionButtons.forEach(button => {
            button.classList.remove('disabled-action');
        });
    }
}
/**
 * Handle user logout.
 * This function is called when the "Logout" button is clicked.
 */
function handleLogout() {
    if (confirm('Are you sure you want to log out?')) {
        currentUserRole = null; // Clear the current user's role
        
        // Hide the main application container
        appContainer.classList.add('hidden');
        
        // Show the login screen again
        loginContainer.classList.remove('hidden');
        
        // Optional: Clear the password field for security
        document.getElementById('password').value = ''; 
    }
}

/**
 * Re-apply permissions every time a list is rendered.
 * যখনই কোনো তালিকা (যেমন আইটেম লিস্ট, ইনভয়েস লিস্ট) নতুন করে দেখানো হয়,
 * এই ফাংশনটি আবার পারমিশন চেক করে বোতাম নিষ্ক্রিয় করবে।
 */
function reapplyPermissionsOnRender() {
    // একটি ছোট ডিলে দেওয়া হয় যাতে DOM আপডেট হতে পারে
    setTimeout(applyPermissions, 100);
}

// --- ORDER MANAGEMENT FUNCTIONS (FIXED) ---

// ১. রেডিও বাটন পাল্টালে লিস্ট বদলানোর ফাংশন
function toggleOrderItemType() {
    const type = document.querySelector('input[name="orderItemType"]:checked').value;
    const searchInput = document.getElementById('orderItemSearch');
    const note = document.getElementById('orderNewItemNote');
    
    searchInput.value = '';
    document.getElementById('purchaseHistorySection').style.display = 'none';
    
    if (type === 'misc') {
        searchInput.setAttribute('list', 'miscListData'); 
        searchInput.placeholder = "Search or Type New Miscellaneous Item Name...";
        if(note) {
            note.style.display = 'block';
            note.innerText = "* If name doesn't match, it will be added as a New Misc Item.";
            note.style.color = "blue";
        }
    } else {
        searchInput.setAttribute('list', 'itemListData');
        searchInput.placeholder = "Type Character, Alphabet, Number...";
        if(note) note.style.display = 'none';
    }
}

// ২. পারচেজ হিস্ট্রি (আগের মতোই রাখা 
function fetchPurchaseHistory() {
    const itemName = document.getElementById('orderItemSearch').value.trim();
    const historyBody = document.getElementById('purchaseHistoryBody');
    const historySection = document.getElementById('purchaseHistorySection');
    const note = document.getElementById('orderNewItemNote');

    if (!itemName) {
        historySection.style.display = 'none';
        return;
    }

    const type = document.querySelector('input[name="orderItemType"]:checked').value;

    // Unit Auto-Select Logic
    let foundUnit = '';
    const storeItem = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    if (storeItem) { foundUnit = storeItem.unit; } 
    else {
        const miscItem = appData.miscItems.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        if (miscItem) { foundUnit = miscItem.unit; }
    }

    if (foundUnit) {
        const unitDropdown = document.getElementById('orderUnit');
        let isMatched = false;
        for (let i = 0; i < unitDropdown.options.length; i++) {
            if (unitDropdown.options[i].value.toLowerCase() === foundUnit.toLowerCase()) {
                unitDropdown.selectedIndex = i;
                isMatched = true;
                break;
            }
        }
        if (!isMatched) {
            const newOption = document.createElement('option');
            newOption.value = foundUnit; newOption.text = foundUnit;
            unitDropdown.add(newOption); unitDropdown.value = foundUnit;
        }
    }

    // --- FIX: Miscellaneous Item হলেও ইনভয়েস চেক করবে ---
    const isStoreItem = appData.items.some(i => i.name.toLowerCase() === itemName.toLowerCase());
    
    if (type === 'misc' && !isStoreItem) {
        if(note) {
            note.style.display = 'block';
            note.innerText = "* New Misc Item (If no history found below)";
        }
    } else {
        if(note) note.style.display = 'none';
    }

    // Fetch History form Invoices
    let history = [];
    if (appData.invoices) {
        appData.invoices.forEach(inv => {
            if (inv.items) {
                inv.items.forEach(item => {
                    if (item.name.toLowerCase() === itemName.toLowerCase()) {
                        const rate = parseFloat(item.rate) || 0;
                        const gst = parseFloat(item.gst) || 0;
                        const rateWithGst = rate * (1 + gst / 100);
                        
                        history.push({
                            date: inv.date,
                            vendor: inv.vendor,
                            rate: rate,
                            gst: gst,
                            totalRate: rateWithGst
                        });
                    }
                });
            }
        });
    }

    // SORTING: Lowest to Highest Rate
    history.sort((a, b) => a.totalRate - b.totalRate);

    historyBody.innerHTML = '';
    
    if (history.length > 0) {
        historySection.style.display = 'block';
        history.forEach(h => {
            historyBody.innerHTML += `
                <tr>
                    <td><button class="btn-link" onclick="selectHistoryItem('${h.vendor}', ${h.rate}, ${h.gst})">Select</button></td>
                    <td>${formatDateToDDMMYYYY(h.date)}</td>
                    <td>${h.vendor}</td>
                    <td>
                        <span style="font-weight:bold; color:#2c3e50; font-size:1.1em;">${h.totalRate.toFixed(2)}</span>
                        <br><small style="color:#777;">(Base: ${h.rate.toFixed(2)} + ${h.gst}%)</small>
                    </td>
                </tr>`;
        });
    } else {
        historySection.style.display = 'none';
    }
}
    
    

function selectHistoryItem(vendor, rate, gst) {
    document.getElementById('orderVendor').value = vendor;
    document.getElementById('orderRate').value = rate;
    
    const gstDropdown = document.getElementById('orderGst');
    let optionFound = false;

    for(let i = 0; i < gstDropdown.options.length; i++) {
        if(parseFloat(gstDropdown.options[i].value) === gst) {
            gstDropdown.selectedIndex = i;
            optionFound = true;
            break;
        }
    }

    if(!optionFound) {
         const option = document.createElement('option');
         option.value = gst;
         option.text = gst + "%";
         gstDropdown.add(option);
         gstDropdown.value = gst;
    }

    calcOrderTotal();
}

function calcOrderTotal() {
    const qty = parseFloat(document.getElementById('orderQty').value) || 0;
    const rate = parseFloat(document.getElementById('orderRate').value) || 0;
    const gst = parseFloat(document.getElementById('orderGst').value) || 0;
    
    const total = qty * rate * (1 + gst / 100);
    document.getElementById('orderTotalPrice').value = total.toFixed(2);
}

// ৩. অর্ডার কার্টে আইটেম যোগ করা
function addToOrderCart() {
    const itemName = document.getElementById('orderItemSearch').value.trim();
    const type = document.querySelector('input[name="orderItemType"]:checked').value;
    const vendor = document.getElementById('orderVendor').value.trim();
    const rate = parseFloat(document.getElementById('orderRate').value);
    const gst = parseFloat(document.getElementById('orderGst').value);
    const qty = parseFloat(document.getElementById('orderQty').value);
    const unit = document.getElementById('orderUnit').value;

    if(!itemName || !vendor || isNaN(rate) || isNaN(qty)) {
        alert("Please fill all fields."); return;
    }

    if(orderCart.some(i => i.name.toLowerCase() === itemName.toLowerCase())) {
        alert("Repeat Item Order is not allowed in one Order Sheet.");
        return;
    }

    const amount = qty * rate * (1 + gst / 100);

    orderCart.push({
        name: itemName,
        type: type === 'store' ? 'STORE ITEM' : 'MISC. ITEM',
        vendor: vendor,
        rate: rate,
        gst: gst,
        qty: qty,
        unit: unit,
        amount: amount
    });

    renderOrderCart();
    
    // Reset Inputs
    document.getElementById('orderItemSearch').value = '';
    document.getElementById('orderQty').value = '';
    document.getElementById('orderRate').value = '';
    document.getElementById('orderTotalPrice').value = '';
}

function removeFromOrderCart(index) {
    orderCart.splice(index, 1);
    renderOrderCart();
}

function clearOrderCart() {
    orderCart = [];
    renderOrderCart();
}

// ৪. রেন্ডার অর্ডার কার্ট (Vendor-wise Breakdown সহ)
function renderOrderCart() {
    const tbody = document.getElementById('orderCartBody');
    tbody.innerHTML = '';
    let grandTotal = 0;
    const vendorTotals = {}; 

    orderCart.forEach((item, index) => {
        grandTotal += item.amount;
        
        if (!vendorTotals[item.vendor]) {
            vendorTotals[item.vendor] = 0;
        }
        vendorTotals[item.vendor] += item.amount;

        tbody.innerHTML += `
            <tr>
                <td>
                    ${item.name}
                    <br><small style="color: #666; font-size: 0.85em;">(${item.type || 'STORE ITEM'})</small>
                </td>
                <td>${item.vendor}</td>
                <td>${item.rate.toFixed(2)}</td>
                <td>${item.gst}%</td>
                <td>${item.qty} ${item.unit}</td>
                <td>${item.amount.toFixed(2)}</td>
                <td>
                    <button class="btn-link btn-danger" onclick="removeFromOrderCart(${index})">Remove</button>
                </td>
            </tr>`;
    });

    document.getElementById('orderGrandTotal').innerText = grandTotal.toFixed(2);

    let breakdownHtml = '<div style="margin-top:15px; padding:10px; background:#f0f8ff; border: 1px solid #d1e7dd; border-radius:6px;"><strong>Live Vendor Wise Totals:</strong><div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:5px;">';
    
    for (const [vendor, total] of Object.entries(vendorTotals)) {
        const color = total > 9990 ? '#dc3545' : '#198754'; 
        const warningIcon = total > 9990 ? '⚠️ ' : '✅ ';
        
        breakdownHtml += `<span style="color:${color}; font-weight:500; border:1px solid ${color}; padding: 2px 8px; border-radius: 4px;">
            ${warningIcon}${vendor}: ${total.toFixed(2)}
        </span>`;
    }
    breakdownHtml += '</div></div>';

    const existingBreakdown = document.getElementById('vendorBreakdownDisplay');
    const table = document.querySelector('#makeOrder .data-table');

    if (existingBreakdown) {
        existingBreakdown.innerHTML = breakdownHtml;
    } else {
        const div = document.createElement('div');
        div.id = 'vendorBreakdownDisplay';
        div.innerHTML = breakdownHtml;
        if(table) {
            table.after(div);
        }
    }
}

// --- EDIT ORDER FUNCTIONS (FIXED & NEW FEATURE) ---
// --- UPDATED EDIT ORDER FUNCTIONS WITH HISTORY ---

function editOrder(id) {
    const order = appData.orders.find(o => o.id === id);
    if (!order) return;

    editingOrderOriginalState = JSON.parse(JSON.stringify(order));
    const unitOptions = appData.measures.map(u => `<option value="${u}">${u}</option>`).join('');

    const modalBody = document.getElementById('editOrderModalBody');
    modalBody.innerHTML = `
        <div class="form-grid">
            <div class="form-group"><label>Reference No</label><input type="text" id="editOrderRef" value="${order.refNo}" readonly></div>
            <div class="form-group"><label>Date</label><input type="date" id="editOrderDate" value="${formatDateToYYYYMMDD(order.date)}"></div>
        </div>
        <hr>
        <h4>Current Items in Order</h4>
        <div class="modal-table-container" style="max-height: 200px; overflow-y: auto;">
            <table class="data-table">
                <thead><tr><th>Item Name</th><th>Vendor</th><th>Qty</th><th>Rate</th><th>GST</th><th>Total</th><th>Act</th></tr></thead>
                <tbody id="editOrderItemsBody"></tbody>
            </table>
        </div>

        <div id="editOrderVendorBreakdown" style="margin-top: 15px;"></div>

        <h3 style="text-align:right;">New Total: <span id="editOrderGrandTotal">${order.totalAmount.toFixed(2)}</span></h3>
        
        <hr>
        <h4 style="color:var(--primary-color);">Add New Item to This Order</h4>
        <div class="form-group" style="margin-bottom:10px;">
            <div class="d-flex gap-10">
                <input type="radio" id="editOrderStoreRadio" name="editOrderType" value="store" checked onchange="toggleEditOrderItemType()"> 
                <label for="editOrderStoreRadio">Store Item</label>
                
                <input type="radio" id="editOrderMiscRadio" name="editOrderType" value="misc" onchange="toggleEditOrderItemType()"> 
                <label for="editOrderMiscRadio">Misc. Item</label>
            </div>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="editOrderNewItemName" list="itemListData" placeholder="Search Store Item..." oninput="fetchEditOrderHistory()">
            </div>
             <div class="form-group">
                <label>Vendor</label>
                <input type="text" id="editOrderNewVendor" placeholder="Vendor Name">
            </div>
            <div class="form-group"><label>Rate</label><input type="number" id="editOrderNewRate" placeholder="0.00"></div>
            <div class="form-group"><label>GST %</label><select id="editOrderNewGst"><option value="0">0%</option><option value="5">5%</option><option value="12">12%</option><option value="18">18%</option><option value="28">28%</option></select></div>
            <div class="form-group"><label>Qty</label><input type="number" id="editOrderNewQty" placeholder="0"></div>
            <div class="form-group"><label>Unit</label><select id="editOrderNewUnit">${unitOptions}</select></div>
        </div>

        <div id="editOrderHistorySection" style="display:none; margin-top:10px; border:1px solid #ddd; padding:10px; background:#fffbe6;">
            <h4>Purchase History (Lowest to Highest)</h4>
            <div style="max-height: 150px; overflow-y: auto;">
                <table class="data-table" style="font-size: 0.9em;">
                    <thead>
                        <tr><th>Select</th><th>Date</th><th>Vendor</th><th>Rate (Incl. GST)</th></tr>
                    </thead>
                    <tbody id="editOrderHistoryBody"></tbody>
                </table>
            </div>
        </div>

        <button class="btn btn-secondary mt-20" onclick="addItemToEditOrder()">➕ Add Item to List</button>

        <hr>
        <div class="mt-20">
            <button class="btn btn-primary" onclick="updateOrderSave()">SAVE ALL CHANGES</button>
            <button class="btn btn-clear" onclick="closeModal('editOrderModal')">CANCEL</button>
        </div>
    `;
    
    refreshEditOrderTable();
    openModal('editOrderModal');
}

// --- MISSING FUNCTIONS ADDED BELOW ---

function fetchEditOrderHistory() {
    const itemName = document.getElementById('editOrderNewItemName').value.trim();
    const historyBody = document.getElementById('editOrderHistoryBody');
    const historySection = document.getElementById('editOrderHistorySection');

    if (!itemName) {
        historySection.style.display = 'none';
        return;
    }

    // Auto-select Unit if found
    let foundUnit = '';
    const storeItem = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    const miscItem = appData.miscItems.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    
    if (storeItem) foundUnit = storeItem.unit;
    else if (miscItem) foundUnit = miscItem.unit;

    if (foundUnit) {
        document.getElementById('editOrderNewUnit').value = foundUnit;
    }

    // Fetch History Logic
    let history = [];
    if (appData.invoices) {
        appData.invoices.forEach(inv => {
            if (inv.items) {
                inv.items.forEach(item => {
                    if (item.name.toLowerCase() === itemName.toLowerCase()) {
                        const rate = parseFloat(item.rate) || 0;
                        const gst = parseFloat(item.gst) || 0;
                        const rateWithGst = rate * (1 + gst / 100);
                        
                        history.push({
                            date: inv.date,
                            vendor: inv.vendor,
                            rate: rate,
                            gst: gst,
                            totalRate: rateWithGst
                        });
                    }
                });
            }
        });
    }

    // Sort Lowest to Highest
    history.sort((a, b) => a.totalRate - b.totalRate);
    historyBody.innerHTML = '';

    if (history.length > 0) {
        historySection.style.display = 'block';
        history.forEach(h => {
            historyBody.innerHTML += `
                <tr>
                    <td><button class="btn-link" onclick="selectEditOrderHistoryItem('${h.vendor}', ${h.rate}, ${h.gst})">Select</button></td>
                    <td>${formatDateToDDMMYYYY(h.date)}</td>
                    <td>${h.vendor}</td>
                    <td>
                        <span style="font-weight:bold; color:#2c3e50;">${h.totalRate.toFixed(2)}</span>
                        <br><small>(Base: ${h.rate.toFixed(2)} + ${h.gst}%)</small>
                    </td>
                </tr>`;
        });
    } else {
        historySection.style.display = 'none';
    }
}

function selectEditOrderHistoryItem(vendor, rate, gst) {
    document.getElementById('editOrderNewVendor').value = vendor;
    document.getElementById('editOrderNewRate').value = rate;
    
    const gstDropdown = document.getElementById('editOrderNewGst');
    let optionFound = false;
    for(let i = 0; i < gstDropdown.options.length; i++) {
        if(parseFloat(gstDropdown.options[i].value) === gst) {
            gstDropdown.selectedIndex = i;
            optionFound = true;
            break;
        }
    }
    if(!optionFound) {
         const option = document.createElement('option');
         option.value = gst;
         option.text = gst + "%";
         gstDropdown.add(option);
         gstDropdown.value = gst;
    }
}

function toggleEditOrderItemType() {
    const type = document.querySelector('input[name="editOrderType"]:checked').value;
    const input = document.getElementById('editOrderNewItemName');
    
    input.value = ''; 
    if (type === 'misc') {
        input.setAttribute('list', 'miscListData');
        input.placeholder = "Search or Type New Misc Item Name...";
    } else {
        input.setAttribute('list', 'itemListData');
        input.placeholder = "Search Store Item...";
    }
}

function addItemToEditOrder() {
    const name = document.getElementById('editOrderNewItemName').value.trim();
    const vendor = document.getElementById('editOrderNewVendor').value.trim();
    const rate = parseFloat(document.getElementById('editOrderNewRate').value);
    const gst = parseFloat(document.getElementById('editOrderNewGst').value);
    const qty = parseFloat(document.getElementById('editOrderNewQty').value);
    const unit = document.getElementById('editOrderNewUnit').value;
    const type = document.querySelector('input[name="editOrderType"]:checked').value;

    if (!name || !vendor || isNaN(rate) || isNaN(qty) || qty <= 0) {
        alert("Please fill all fields (Name, Vendor, Rate, Qty) correctly.");
        return;
    }

    const amount = qty * rate * (1 + gst/100);

    editingOrderOriginalState.items.push({
        name: name,
        vendor: vendor,
        rate: rate,
        gst: gst,
        qty: qty,
        unit: unit,
        amount: amount,
        type: type === 'store' ? 'STORE ITEM' : 'MISC. ITEM'
    });

    refreshEditOrderTable();
    
    document.getElementById('editOrderNewItemName').value = '';
    document.getElementById('editOrderNewRate').value = '';
    document.getElementById('editOrderNewQty').value = '';
}

function refreshEditOrderTable() {
    const tbody = document.getElementById('editOrderItemsBody');
    tbody.innerHTML = '';
    let grandTotal = 0;
    const vendorTotals = {}; // ভেন্ডর টোটাল ট্র্যাক করার জন্য

    editingOrderOriginalState.items.forEach((item, index) => {
        const gstVal = item.gst || 0;
        const total = item.qty * item.rate * (1 + gstVal/100);
        item.amount = total; 
        grandTotal += total;

        // Vendor Wise Calculation
        if (!vendorTotals[item.vendor]) {
            vendorTotals[item.vendor] = 0;
        }
        vendorTotals[item.vendor] += total;

        tbody.innerHTML += `
            <tr id="editOrderRow-${index}">
                <td>${item.name}<br><small style="color:grey; font-size:0.8em;">(${item.type || 'STORE ITEM'})</small></td>
                <td>${item.vendor}</td>
                <td><input type="number" class="editing-qty" style="width:60px; padding:5px;" value="${item.qty}" onchange="recalcEditOrderRow(${index})"></td>
                <td><input type="number" class="editing-rate" style="width:70px; padding:5px;" value="${item.rate}" onchange="recalcEditOrderRow(${index})"></td>
                <td><input type="number" class="editing-rate" style="width:40px; padding:5px;" value="${gstVal}" onchange="recalcEditOrderRow(${index})">%</td>
                <td id="editOrderRowTotal-${index}" style="font-weight:bold;">${total.toFixed(2)}</td>
                <td><button class="btn-link btn-danger" onclick="removeEditOrderItem(${index})">X</button></td>
            </tr>
        `;
    });
    
    document.getElementById('editOrderGrandTotal').innerText = grandTotal.toFixed(2);

    // --- Vendor Breakdown Display Logic (NEW) ---
    const breakdownContainer = document.getElementById('editOrderVendorBreakdown');
    if (breakdownContainer) {
        let breakdownHtml = '<div style="padding:10px; background:#f0f8ff; border: 1px solid #d1e7dd; border-radius:6px;"><strong>Live Vendor Wise Totals:</strong><div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:5px;">';
        
        for (const [vendor, total] of Object.entries(vendorTotals)) {
            // ৯৯৯০ টাকার বেশি হলে লাল রঙে দেখাবে
            const color = total > 9990 ? '#dc3545' : '#198754'; 
            const warningIcon = total > 9990 ? '⚠️ ' : '✅ ';
            
            breakdownHtml += `<span style="color:${color}; font-weight:500; border:1px solid ${color}; padding: 2px 8px; border-radius: 4px;">
                ${warningIcon}${vendor}: ${total.toFixed(2)}
            </span>`;
        }
        breakdownHtml += '</div></div>';
        breakdownContainer.innerHTML = breakdownHtml;
    }
}

function recalcEditOrderRow(index) {
    const row = document.getElementById(`editOrderRow-${index}`);
    const inputs = row.getElementsByTagName('input');
    
    editingOrderOriginalState.items[index].qty = parseFloat(inputs[0].value) || 0;
    editingOrderOriginalState.items[index].rate = parseFloat(inputs[1].value) || 0;
    editingOrderOriginalState.items[index].gst = parseFloat(inputs[2].value) || 0;
    
    refreshEditOrderTable();
}

function removeEditOrderItem(index) {
    editingOrderOriginalState.items.splice(index, 1);
    refreshEditOrderTable();
}

function updateOrderSave() {
    const index = appData.orders.findIndex(o => o.id === editingOrderOriginalState.id);
    if(index > -1) {
        appData.orders[index].items = editingOrderOriginalState.items;
        appData.orders[index].date = document.getElementById('editOrderDate').value;
        appData.orders[index].totalAmount = editingOrderOriginalState.items.reduce((sum, i) => sum + i.amount, 0);
        saveData();
        alert("Order Updated Successfully!");
        closeModal('editOrderModal');
        filterSavedOrders();
    }
}


// --- MISSING SAVED ORDER & FINALIZE FUNCTIONS ---

// ১. অর্ডার ফাইনালাইজ করা (লিমিট চেক সহ)
function finalizeOrder() {
    if (orderCart.length === 0) {
        alert("Order cart is empty!"); return;
    }

    // Vendor Limit Check (9990 Tk)
    const vendorTotals = {};
    let limitExceeded = false;
    let exceededVendor = '';
    let exceededAmount = 0;

    orderCart.forEach(item => {
        if (!vendorTotals[item.vendor]) vendorTotals[item.vendor] = 0;
        vendorTotals[item.vendor] += item.amount;
    });

    for (const [vendor, total] of Object.entries(vendorTotals)) {
        if (total > 9990) {
            limitExceeded = true;
            exceededVendor = vendor;
            exceededAmount = total;
            break;
        }
    }

    if (limitExceeded) {
        document.getElementById('alertVendorName').innerText = exceededVendor;
        document.getElementById('alertVendorTotal').innerText = exceededAmount.toFixed(2);
        openModal('limitAlertModal');
        return;
    }

    saveFinalOrder();
}

function splitAndSaveOrder() {
    alert("System suggests making separate orders. Please remove some items to bring the total below 9990/-");
    closeModal('limitAlertModal');
}

// ২. অর্ডার সেভ করা
function saveFinalOrder() {
    const refNo = `ORD-${new Date().getFullYear()}-${getNextId('order')}`;
    const totalAmount = orderCart.reduce((sum, item) => sum + item.amount, 0);
    
    const newOrder = {
        id: getNextId('order'),
        date: new Date().toISOString().split('T')[0], // Today's date
        refNo: refNo,
        items: [...orderCart],
        totalAmount: totalAmount
    };

    appData.orders.push(newOrder);
    saveData();
    
    alert(`Order Saved Successfully! Ref: ${refNo}`);
    clearOrderCart();
    
    // সেভ হওয়ার পর Saved Order ট্যাবে নিয়ে যাবে
    filterSavedOrders(); // লিস্ট রিফ্রেশ করবে
    
    // ট্যাব পরিবর্তন করা (অপশনাল)
    const savedTabBtn = document.querySelector('button[onclick*="viewSavedOrders"]');
    if(savedTabBtn) savedTabBtn.click();
}

// ৩. সেভ করা অর্ডার ফিল্টার ও পেজিনেশন
function changeSavedOrderPage(page) {
    currentSavedOrderPage = page;
    filterSavedOrders();
}

function filterSavedOrders() {
    const searchTerm = document.getElementById('savedOrderSearch').value.toLowerCase();
    
    let filteredOrders = [];
    if(appData.orders) {
        filteredOrders = appData.orders.filter(o => {
            const refMatch = o.refNo.toLowerCase().includes(searchTerm);
            const vendorMatch = o.items.some(i => i.vendor.toLowerCase().includes(searchTerm));
            const itemMatch = o.items.some(i => i.name.toLowerCase().includes(searchTerm));
            return refMatch || vendorMatch || itemMatch;
        });
    }

    // Sort by Date (Newest First)
    filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

    renderSavedOrders(filteredOrders);
    renderPagination(filteredOrders, 'savedOrderPagination', changeSavedOrderPage, ordersPerPage, currentSavedOrderPage);
}

// ৪. সেভ করা অর্ডার টেবিলে দেখানো (বোল্ড ভেন্ডর নাম ও কোয়ান্টিটি সহ)
function renderSavedOrders(ordersToRender) {
    const tbody = document.getElementById('savedOrdersBody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const start = (currentSavedOrderPage - 1) * ordersPerPage;
    const end = start + ordersPerPage;
    const paginatedOrders = ordersToRender.slice(start, end);

    if (paginatedOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No saved orders found.</td></tr>';
        return;
    }

    paginatedOrders.forEach(order => {
        const vendors = [...new Set(order.items.map(i => i.vendor))].join(', ');
        const itemsCount = order.items.length;
        // আইটেমের নাম এবং কোয়ান্টিটি বোল্ড করে দেখানো
        const itemNames = order.items.map(i => `${i.name} <b>(${i.qty} ${i.unit})</b>`).slice(0, 3).join(', ') + (itemsCount > 3 ? '...' : '');

        tbody.innerHTML += `
            <tr>
                <td>${formatDateToDDMMYYYY(order.date)}</td>
                <td style="font-weight:bold; color:var(--primary-color);">${order.refNo}</td>
                <td>
                    <strong>Vendors:</strong> <span style="font-weight:bold; color:#000;">${vendors}</span><br>
                    <small>Items: ${itemNames}</small>
                </td>
                <td>${order.totalAmount.toFixed(2)}</td>
                <td>
                    <button class="btn-link" onclick="printOrderPDF(${order.id})">🖨️ Print</button>
                    <button class="btn-link" onclick="downloadOrderWord(${order.id})">📝 Word</button>
                    <button class="btn-link" onclick="editOrder(${order.id})">✏️ Edit</button>
                    <button class="btn-link btn-danger" onclick="deleteOrder(${order.id})">🗑️ Delete</button>
                </td>
            </tr>
        `;
    });
    reapplyPermissionsOnRender();
}

// NEW: Edit Modal এর ভেতরে হিস্ট্রি দেখানোর ফাংশন
function fetchEditOrderHistory() {
    const itemName = document.getElementById('editOrderNewItemName').value.trim();
    const historyBody = document.getElementById('editOrderHistoryBody');
    const historySection = document.getElementById('editOrderHistorySection');

    if (!itemName) {
        historySection.style.display = 'none';
        return;
    }

    // Auto-select Unit if found
    let foundUnit = '';
    const storeItem = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    const miscItem = appData.miscItems.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    
    if (storeItem) foundUnit = storeItem.unit;
    else if (miscItem) foundUnit = miscItem.unit;

    if (foundUnit) {
        document.getElementById('editOrderNewUnit').value = foundUnit;
    }

    // Fetch History Logic
    let history = [];
    if (appData.invoices) {
        appData.invoices.forEach(inv => {
            if (inv.items) {
                inv.items.forEach(item => {
                    if (item.name.toLowerCase() === itemName.toLowerCase()) {
                        const rate = parseFloat(item.rate) || 0;
                        const gst = parseFloat(item.gst) || 0;
                        const rateWithGst = rate * (1 + gst / 100);
                        
                        history.push({
                            date: inv.date,
                            vendor: inv.vendor,
                            rate: rate,
                            gst: gst,
                            totalRate: rateWithGst
                        });
                    }
                });
            }
        });
    }

    history.sort((a, b) => a.totalRate - b.totalRate);
    historyBody.innerHTML = '';

    if (history.length > 0) {
        historySection.style.display = 'block';
        history.forEach(h => {
            historyBody.innerHTML += `
                <tr>
                    <td><button class="btn-link" onclick="selectEditOrderHistoryItem('${h.vendor}', ${h.rate}, ${h.gst})">Select</button></td>
                    <td>${formatDateToDDMMYYYY(h.date)}</td>
                    <td>${h.vendor}</td>
                    <td>
                        <span style="font-weight:bold; color:#2c3e50;">${h.totalRate.toFixed(2)}</span>
                        <br><small>(Base: ${h.rate} + ${h.gst}%)</small>
                    </td>
                </tr>`;
        });
    } else {
        historySection.style.display = 'none';
    }
}

// NEW: Edit Modal এর হিস্ট্রি থেকে সিলেক্ট করার ফাংশন
function selectEditOrderHistoryItem(vendor, rate, gst) {
    document.getElementById('editOrderNewVendor').value = vendor;
    document.getElementById('editOrderNewRate').value = rate;
    
    const gstDropdown = document.getElementById('editOrderNewGst');
    // GST সিলেক্ট করার লজিক
    let optionFound = false;
    for(let i = 0; i < gstDropdown.options.length; i++) {
        if(parseFloat(gstDropdown.options[i].value) === gst) {
            gstDropdown.selectedIndex = i;
            optionFound = true;
            break;
        }
    }
    if(!optionFound) {
         const option = document.createElement('option');
         option.value = gst;
         option.text = gst + "%";
         gstDropdown.add(option);
         gstDropdown.value = gst;
    }
}

function toggleEditOrderItemType() {
    const type = document.querySelector('input[name="editOrderType"]:checked').value;
    const input = document.getElementById('editOrderNewItemName');
    
    input.value = ''; 
    if (type === 'misc') {
        input.setAttribute('list', 'miscListData');
        input.placeholder = "Search or Type New Misc Item Name...";
    } else {
        input.setAttribute('list', 'itemListData');
        input.placeholder = "Search Store Item...";
    }
}

function addItemToEditOrder() {
    const name = document.getElementById('editOrderNewItemName').value.trim();
    const vendor = document.getElementById('editOrderNewVendor').value.trim();
    const rate = parseFloat(document.getElementById('editOrderNewRate').value);
    const gst = parseFloat(document.getElementById('editOrderNewGst').value);
    const qty = parseFloat(document.getElementById('editOrderNewQty').value);
    const unit = document.getElementById('editOrderNewUnit').value;
    const type = document.querySelector('input[name="editOrderType"]:checked').value;

    if (!name || !vendor || isNaN(rate) || isNaN(qty) || qty <= 0) {
        alert("Please fill all fields (Name, Vendor, Rate, Qty) correctly.");
        return;
    }

    const amount = qty * rate * (1 + gst/100);

    editingOrderOriginalState.items.push({
        name: name,
        vendor: vendor,
        rate: rate,
        gst: gst,
        qty: qty,
        unit: unit,
        amount: amount,
        type: type === 'store' ? 'STORE ITEM' : 'MISC. ITEM'
    });

    refreshEditOrderTable();
    
    document.getElementById('editOrderNewItemName').value = '';
    document.getElementById('editOrderNewRate').value = '';
    document.getElementById('editOrderNewQty').value = '';
}


function recalcEditOrderRow(index) {
    const row = document.getElementById(`editOrderRow-${index}`);
    const inputs = row.getElementsByTagName('input');
    
    editingOrderOriginalState.items[index].qty = parseFloat(inputs[0].value) || 0;
    editingOrderOriginalState.items[index].rate = parseFloat(inputs[1].value) || 0;
    editingOrderOriginalState.items[index].gst = parseFloat(inputs[2].value) || 0;
    
    refreshEditOrderTable();
}

function removeEditOrderItem(index) {
    editingOrderOriginalState.items.splice(index, 1);
    refreshEditOrderTable();
}




// --- UPDATED PRINT FUNCTION ---
function printOrderPDF(id) {
    const order = appData.orders.find(o => o.id === id);
    if (!order) return;

    // --- Page 1: Note Sheet Content [cite: 3] ---
    const page1Rows = order.items.map((item, idx) => `
        <tr>
            <td style="text-align:center;">${idx + 1}.</td>
            <td>${item.name}</td>
            <td style="text-align:center;">${item.qty} ${item.unit}</td>
        </tr>
    `).join('');

    const page1 = `
    <div class="print-page">
        <div class="webel-header">
            <div class="webel-logo-text">Webel</div> <div class="webel-subtext">opportunities infinITe</div>
            <div style="font-size:12px; margin-top:5px;">
                West Bengal Electronics Industry Development Corporation Ltd.<br>
                Webel Bhavan, Block: EP & GP, Sector V, Salt Lake, Kolkata: 700 009 </div>
        </div>
        
        <h3 style="text-align:center; text-decoration: underline;">NOTESHEET</h3> <h4 style="text-align:center; margin-top:0;">PRINTING & STATIONARY ORDERSHEET</h4> <div class="print-header-row" style="margin-top:20px;">
            <div><strong>Date:</strong> ${formatDateToDDMMYYYY(order.date)}</div> <div><strong>Order Reference Number:</strong> ${order.refNo}</div> </div>

        <div style="margin-top:20px;">
            To,<br>
            The Vice-President<br>
            Admin, WEBEL Bhavan <br><br>
            <strong>Through:</strong> Deputy Manager, Admin, WEBEL </div>

        <p>Dear Sir,</p>
        <p>The following items are not available in the stores as it fully utilized by the employee of the Webel. It is required for day to day office support service. Kindly take necessary action from your end.</p> <p>Required Item is given below;</p> <table class="print-table">
            <thead>
                <tr>
                    <th style="width:10%;">Sl No</th>
                    <th style="width:60%;">Items</th>
                    <th style="width:30%;">Quantity Req.</th>
                </tr>
            </thead>
            <tbody>${page1Rows}</tbody>
        </table>

        <div style="margin-top: 20px;">Thanking You,</div> <div class="signature-section">
            <div style="text-align:center;">_______________________<br>Signature Associate</div> <div style="text-align:center;">_______________________<br>Signature Store Keeper</div> </div>
    </div>
    <div class="page-break"></div> `;

    // --- Page 2: Information Sheet Content [cite: 22] ---
    
    // Vendor Totals Calculation [cite: 24, 25, 26]
    const vendorTotals = {};
    order.items.forEach(i => {
        if (!vendorTotals[i.vendor]) vendorTotals[i.vendor] = 0;
        vendorTotals[i.vendor] += i.amount;
    });

    const page2Rows = order.items.map((item, idx) => `
        <tr>
            <td style="text-align:center;">${idx + 1}.</td>
            <td>${item.name}</td>
            <td style="text-align:center;">${item.qty} ${item.unit}</td>
            <td style="text-align:right;">${item.rate.toFixed(2)}</td>
            <td style="text-align:right;">${item.amount.toFixed(2)}</td>
            <td style="text-align:center;">${item.vendor}</td>
        </tr>
    `).join('');

    let vendorSummaryHtml = '';
    for (const [v, total] of Object.entries(vendorTotals)) {
        vendorSummaryHtml += `<div style="text-align:right;"><strong>${v} Amount:</strong> ${total.toFixed(2)}</div>`;
    }

    const page2 = `
    <div class="print-page">
        <div class="print-header-row">
            <div><strong>Date:</strong> ${formatDateToDDMMYYYY(order.date)}</div> <div><strong>Order Reference Number:</strong> ${order.refNo}</div> </div>

        <h3 style="text-decoration: underline;">Information Sheet:</h3> <table class="print-table">
            <thead>
                <tr>
                    <th>Sl No</th>
                    <th>Items</th>
                    <th>Quantity Req.</th>
                    <th>L1 Rate</th>
                    <th>Total Item Amount</th>
                    <th>Vendor</th>
                </tr>
            </thead>
            <tbody>${page2Rows}</tbody> </table>

        <div style="margin-top: 20px; border-top: 1px solid black; padding-top:10px;">
            ${vendorSummaryHtml}
            <div style="text-align:right; font-size:1.1em; margin-top:5px;">
                <strong>Total Order Amount: ${order.totalAmount.toFixed(2)}</strong> </div>
        </div>

        <div class="signature-section">
            <div style="text-align:center;">_______________________<br>Signature Associate</div> <div style="text-align:center;">_______________________<br>Signature Store Keeper</div> </div>
    </div>
    `;

    document.getElementById('printPreviewBody').innerHTML = page1 + page2;
    openModal('printPreviewModal');
}

function executePrint() {
    // Copy content from modal to the hidden print container
    const previewContent = document.getElementById('printPreviewBody').innerHTML;
    document.getElementById('printContainer').innerHTML = previewContent;
    window.print();
}

// --- HELPER: NUMBER TO WORDS FUNCTION ---
function numberToWords(price) {
    var sglDigit = ["Zero", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"],
        dblDigit = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"],
        tensPlace = ["", "Ten", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"],
        handle_tens = function(dgt, prevDgt) {
            return 0 == dgt ? "" : " " + (1 == dgt ? dblDigit[prevDgt] : tensPlace[dgt])
        },
        handle_utlc = function(dgt, nxtDgt, denom) {
            return (0 != dgt && 1 != nxtDgt ? " " + sglDigit[dgt] : "") + (0 != nxtDgt || dgt > 0 ? " " + denom : "")
        };

    var str = "",
        digitIdx = 0,
        digit = 0,
        nxtDigit = 0,
        words = [];
    if (price += "", isNaN(parseInt(price))) str = "";
    else if (parseInt(price) > 0 && price.length <= 10) {
        for (digitIdx = price.length - 1; digitIdx >= 0; digitIdx--) switch (digit = price[digitIdx] - 0, nxtDigit = digitIdx > 0 ? price[digitIdx - 1] - 0 : 0, price.length - digitIdx - 1) {
            case 0:
                words.push(handle_utlc(digit, nxtDigit, ""));
                break;
            case 1:
                words.push(handle_tens(digit, price[digitIdx + 1]));
                break;
            case 2:
                words.push(0 != digit ? " " + sglDigit[digit] + " Hundred" : "");
                break;
            case 3:
                words.push(handle_utlc(digit, nxtDigit, "Thousand"));
                break;
            case 4:
                words.push(handle_tens(digit, price[digitIdx + 1]));
                break;
            case 5:
                words.push(handle_utlc(digit, nxtDigit, "Lakh"));
                break;
            case 6:
                words.push(handle_tens(digit, price[digitIdx + 1]));
                break;
            case 7:
                words.push(handle_utlc(digit, nxtDigit, "Crore"));
                break;
            case 8:
                words.push(handle_tens(digit, price[digitIdx + 1]));
                break;
            case 9:
                words.push(0 != digit ? " " + sglDigit[digit] + " Hundred" : "")
        }
        str = words.reverse().join("")
    } else str = "";
    return str + " Rupees";
}


function downloadOrderWord(id) {
    const order = appData.orders.find(o => o.id === id);
    if (!order) return;

    // --- Prepare Data for Page 1 ---
    const page1Rows = order.items.map((item, idx) => `
        <tr>
            <td style="border:1px solid black; text-align:center;">${idx + 1}.</td>
            <td style="border:1px solid black;">${item.name}</td>
            <td style="border:1px solid black; text-align:center;">${item.qty} ${item.unit}</td>
        </tr>
    `).join('');

    // --- Prepare Data for Page 2 ---
    const vendorTotals = {};
    order.items.forEach(i => {
        if (!vendorTotals[i.vendor]) vendorTotals[i.vendor] = 0;
        vendorTotals[i.vendor] += i.amount;
    });

    const page2Rows = order.items.map((item, idx) => `
        <tr>
            <td style="border:1px solid black; text-align:center;">${idx + 1}.</td>
            <td style="border:1px solid black;">${item.name}</td>
            <td style="border:1px solid black; text-align:center;">${item.qty} ${item.unit}</td>
            <td style="border:1px solid black; text-align:right;">${item.rate.toFixed(2)}</td>
            <td style="border:1px solid black; text-align:right;">${item.amount.toFixed(2)}</td>
            <td style="border:1px solid black; text-align:center;">${item.vendor}</td>
        </tr>
    `).join('');

    let vendorSummaryHtml = '';
    for (const [v, total] of Object.entries(vendorTotals)) {
        vendorSummaryHtml += `<div style="text-align:right;"><strong>${v} Amount:</strong> ${total.toFixed(2)}</div>`;
    }

    const totalInWords = numberToWords(Math.round(order.totalAmount));

    // --- Construct Full HTML Content for Word ---
    const htmlContent = `
    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
    <head><meta charset='utf-8'><title>Order Document</title>
    <style>
        body { font-family: 'Times New Roman', serif; font-size: 12pt; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 5px; }
        .header { text-align: center; color: #0056b3; }
        .page-break { page-break-after: always; }
    </style>
    </head><body>
    
    <div class="header">
        <h1 style="font-size:36pt; margin:0;">Webel</h1>
        <p style="font-size:10pt; margin:0;">opportunities infinITe</p>
        <p style="font-size:10pt;">West Bengal Electronics Industry Development Corporation Ltd.<br>Webel Bhavan, Block: EP & GP, Sector V, Salt Lake, Kolkata: 700 009</p>
    </div>
    <br>
    <h3 style="text-align:center; text-decoration:underline;">NOTESHEET</h3>
    <h4 style="text-align:center;">PRINTING & STATIONARY ORDERSHEET</h4>
    
    <p><strong>Date:</strong> ${formatDateToDDMMYYYY(order.date)} &nbsp;&nbsp;&nbsp; <strong>Order Ref:</strong> ${order.refNo}</p>
    
    <p>To,<br>The Vice-President<br>Admin, WEBEL Bhavan<br><br>Through: Deputy Manager, Admin, WEBEL</p>
    <p>Dear Sir,</p>
    <p>The following items are not available in the stores as it fully utilized by the employee of the Webel. It is required for day to day office support service. Kindly take necessary action from your end.</p>
    <p>Required Item is given below;</p>
    
    <table>
        <thead><tr style="background:#f0f0f0;"><th>Sl No</th><th>Items</th><th>Quantity Req.</th></tr></thead>
        <tbody>${page1Rows}</tbody>
    </table>
    <br><br>
    <p>Thanking You,</p>
    <br><br>
    <table style="border:none;">
        <tr style="border:none;">
            <td style="border:none; text-align:left;">_______________________<br>Signature Associate</td>
            <td style="border:none; text-align:right;">_______________________<br>Signature Store Keeper</td>
        </tr>
    </table>
    
    <br class="page-break">
    
    <p><strong>Date:</strong> ${formatDateToDDMMYYYY(order.date)} &nbsp;&nbsp;&nbsp; <strong>Order Ref:</strong> ${order.refNo}</p>
    <h3 style="text-decoration:underline;">Information Sheet:</h3>
    
    <table>
        <thead><tr style="background:#f0f0f0;"><th>Sl No</th><th>Items</th><th>Qty Req.</th><th>L1 Rate</th><th>Total Amount</th><th>Vendor</th></tr></thead>
        <tbody>${page2Rows}</tbody>
    </table>
    
    <br>
    ${vendorSummaryHtml}
    <div style="text-align:right; font-size:14pt; font-weight:bold; margin-top:10px; border-top:1px solid black;">
        Total Order Amount: ${order.totalAmount.toFixed(2)}
    </div>
    <p style="text-align:right; font-style:italic;">(In Words: ${totalInWords} Only)</p>
    
    <br><br>
    <table style="border:none;">
        <tr style="border:none;">
            <td style="border:none; text-align:left;">_______________________<br>Signature Associate</td>
            <td style="border:none; text-align:right;">_______________________<br>Signature Store Keeper</td>
        </tr>
    </table>
    
    </body></html>`;

    // Convert HTML string to Blob
    const blob = new Blob(['\ufeff', htmlContent], {
        type: 'application/msword'
    });

    // Create Download Link
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Order_${order.refNo.replace(/\//g, '-')}.doc`; // File name
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// --- HELPER: CALCULATE REMAINING ORDER QUANTITY ---
function getRemainingOrderQty(orderId, itemName, originalQty) {
    let supplied = 0;

    // 1. Check all Challans for this Order ID
    appData.challans.forEach(c => {
        c.items.forEach(i => {
            // Check if item is linked to this order
            if (i.orderRefId == orderId && i.name.toLowerCase() === itemName.toLowerCase()) {
                supplied += (parseInt(i.qty) || 0);
            }
        });
    });

    // 2. Check all Direct Invoices for this Order ID
    appData.invoices.forEach(inv => {
        inv.items.forEach(i => {
            // Check if item is linked to this order
            if (i.orderRefId == orderId && i.name.toLowerCase() === itemName.toLowerCase()) {
                supplied += (parseInt(i.qty) || 0);
            }
        });
    });

    return originalQty - supplied;
}
// --- NEW ORDER REFERENCE VALIDATION HELPER FUNCTIONS ---

function populateOrderRefDropdown(prefix) {
    const itemName = document.getElementById(`${prefix}ItemName`).value.trim();
    const dropdown = document.getElementById(`${prefix}OrderRef`);
    const group = document.getElementById(`${prefix}OrderRefGroup`);
    const msg = document.getElementById(`${prefix}OrderLimitMsg`);

    // Reset dropdown
    dropdown.innerHTML = '<option value="">-- Select Order (Optional) --</option>';
    msg.style.display = 'none';

    if (!itemName) {
        group.style.display = 'none';
        return;
    }

    // Find all orders that contain this item
    let foundOrders = [];
    if(appData.orders) {
        appData.orders.forEach(order => {
            const orderItem = order.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
            if (orderItem) {
                // Calculate Remaining
                const remaining = getRemainingOrderQty(order.id, orderItem.name, orderItem.qty);
                
                if (remaining > 0) { // Only show if items are remaining
                    foundOrders.push({
                        id: order.id,
                        ref: order.refNo,
                        date: order.date,
                        totalQty: orderItem.qty,
                        remaining: remaining,
                        vendor: orderItem.vendor
                    });
                }
            }
        });
    }

    if (foundOrders.length > 0) {
        // Sort by date descending (newest orders first)
        foundOrders.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        foundOrders.forEach(o => {
            const option = document.createElement('option');
            option.value = o.id; // Store Order ID
            // DISPLAY FORMAT: Ref | Vendor | Rem: 30/50
            option.text = `${o.ref} | ${o.vendor} | Rem: ${o.remaining}/${o.totalQty}`;
            option.dataset.remaining = o.remaining; // Store limit in dataset
            dropdown.appendChild(option);
        });
        group.style.display = 'block';
    } else {
        group.style.display = 'none';
    }
}

// --- MISSING FUNCTIONS START HERE ---

// ১. মেক অর্ডার হিস্ট্রি এবং মিসলেনিয়াস আইটেম ফিক্স
function fetchPurchaseHistory() {
    const itemName = document.getElementById('orderItemSearch').value.trim();
    const historyBody = document.getElementById('purchaseHistoryBody');
    const historySection = document.getElementById('purchaseHistorySection');
    const note = document.getElementById('orderNewItemNote');

    if (!itemName) {
        if(historySection) historySection.style.display = 'none';
        return;
    }

    const typeRadio = document.querySelector('input[name="orderItemType"]:checked');
    const type = typeRadio ? typeRadio.value : 'store';

    // Unit Auto-Select Logic
    let foundUnit = '';
    const storeItem = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    if (storeItem) { foundUnit = storeItem.unit; } 
    else {
        const miscItem = appData.miscItems.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        if (miscItem) { foundUnit = miscItem.unit; }
    }

    if (foundUnit) {
        const unitDropdown = document.getElementById('orderUnit');
        if(unitDropdown) {
            let isMatched = false;
            for (let i = 0; i < unitDropdown.options.length; i++) {
                if (unitDropdown.options[i].value.toLowerCase() === foundUnit.toLowerCase()) {
                    unitDropdown.selectedIndex = i;
                    isMatched = true;
                    break;
                }
            }
            if (!isMatched) {
                const newOption = document.createElement('option');
                newOption.value = foundUnit; newOption.text = foundUnit;
                unitDropdown.add(newOption); unitDropdown.value = foundUnit;
            }
        }
    }

    // FIX: Misc Item হলেও ইনভয়েস চেক করবে
    const isStoreItem = appData.items.some(i => i.name.toLowerCase() === itemName.toLowerCase());
    
    if (type === 'misc' && !isStoreItem) {
        if(note) {
            note.style.display = 'block';
            note.innerText = "* New Misc Item (If no history found below)";
            note.style.color = "blue";
        }
    } else {
        if(note) note.style.display = 'none';
    }

    // Fetch History
    let history = [];
    if (appData.invoices) {
        appData.invoices.forEach(inv => {
            if (inv.items) {
                inv.items.forEach(item => {
                    if (item.name.toLowerCase() === itemName.toLowerCase()) {
                        const rate = parseFloat(item.rate) || 0;
                        const gst = parseFloat(item.gst) || 0;
                        const rateWithGst = rate * (1 + gst / 100);
                        
                        history.push({
                            date: inv.date,
                            vendor: inv.vendor,
                            rate: rate,
                            gst: gst,
                            totalRate: rateWithGst
                        });
                    }
                });
            }
        });
    }

    // SORTING: Lowest to Highest Rate
    history.sort((a, b) => a.totalRate - b.totalRate);

    if(historyBody) {
        historyBody.innerHTML = '';
        if (history.length > 0) {
            if(historySection) historySection.style.display = 'block';
            history.forEach(h => {
                historyBody.innerHTML += `
                    <tr>
                        <td><button class="btn-link" onclick="selectHistoryItem('${h.vendor}', ${h.rate}, ${h.gst})">Select</button></td>
                        <td>${formatDateToDDMMYYYY(h.date)}</td>
                        <td>${h.vendor}</td>
                        <td>
                            <span style="font-weight:bold; color:#2c3e50; font-size:1.1em;">${h.totalRate.toFixed(2)}</span>
                            <br><small style="color:#777;">(Base: ${h.rate.toFixed(2)} + ${h.gst}%)</small>
                        </td>
                    </tr>`;
            });
        } else {
            if(historySection) historySection.style.display = 'none';
        }
    }
}

// ২. সেভ করা অর্ডার ডিলিট করার ফাংশন
function deleteOrder(id) {
    if(confirm("Are you sure you want to delete this Order? This cannot be undone.")) {
        appData.orders = appData.orders.filter(o => o.id !== id);
        saveData();
        filterSavedOrders();
    }
}

// ৩. এডিট মডালে হিস্ট্রি চেক করার ফাংশন
function fetchEditOrderHistory() {
    const itemNameInput = document.getElementById('editOrderNewItemName');
    if(!itemNameInput) return;
    
    const itemName = itemNameInput.value.trim();
    const historyBody = document.getElementById('editOrderHistoryBody');
    const historySection = document.getElementById('editOrderHistorySection');

    if (!itemName) {
        if (historySection) historySection.style.display = 'none';
        return;
    }

    // Auto-select Unit
    let foundUnit = '';
    const storeItem = appData.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    const miscItem = appData.miscItems.find(i => i.name.toLowerCase() === itemName.toLowerCase());
    
    if (storeItem) foundUnit = storeItem.unit;
    else if (miscItem) foundUnit = miscItem.unit;

    if (foundUnit) {
        const unitInput = document.getElementById('editOrderNewUnit');
        if(unitInput) unitInput.value = foundUnit;
    }

    // Fetch History Logic
    let history = [];
    if (appData.invoices) {
        appData.invoices.forEach(inv => {
            if (inv.items) {
                inv.items.forEach(item => {
                    if (item.name.toLowerCase() === itemName.toLowerCase()) {
                        const rate = parseFloat(item.rate) || 0;
                        const gst = parseFloat(item.gst) || 0;
                        const rateWithGst = rate * (1 + gst / 100);
                        
                        history.push({
                            date: inv.date,
                            vendor: inv.vendor,
                            rate: rate,
                            gst: gst,
                            totalRate: rateWithGst
                        });
                    }
                });
            }
        });
    }

    // Sort Lowest to Highest
    history.sort((a, b) => a.totalRate - b.totalRate);
    
    if (historyBody) {
        historyBody.innerHTML = '';
        if (history.length > 0) {
            if(historySection) historySection.style.display = 'block';
            history.forEach(h => {
                historyBody.innerHTML += `
                    <tr>
                        <td><button class="btn-link" onclick="selectEditOrderHistoryItem('${h.vendor}', ${h.rate}, ${h.gst})">Select</button></td>
                        <td>${formatDateToDDMMYYYY(h.date)}</td>
                        <td>${h.vendor}</td>
                        <td>
                            <span style="font-weight:bold; color:#2c3e50;">${h.totalRate.toFixed(2)}</span>
                            <br><small>(Base: ${h.rate.toFixed(2)} + ${h.gst}%)</small>
                        </td>
                    </tr>`;
            });
        } else {
            if(historySection) historySection.style.display = 'none';
        }
    }
}

// ৪. এডিট হিস্ট্রি থেকে আইটেম সিলেক্ট করা
function selectEditOrderHistoryItem(vendor, rate, gst) {
    document.getElementById('editOrderNewVendor').value = vendor;
    document.getElementById('editOrderNewRate').value = rate;
    
    const gstDropdown = document.getElementById('editOrderNewGst');
    let optionFound = false;
    for(let i = 0; i < gstDropdown.options.length; i++) {
        if(parseFloat(gstDropdown.options[i].value) === gst) {
            gstDropdown.selectedIndex = i;
            optionFound = true;
            break;
        }
    }
    if(!optionFound) {
         const option = document.createElement('option');
         option.value = gst;
         option.text = gst + "%";
         gstDropdown.add(option);
         gstDropdown.value = gst;
    }
}

// ৫. মিসিং ড্রপডাউন ফাংশন (লগইন ঠিক করার জন্য জরুরি)
function populateMiscDatalist() {
    const miscListData = document.getElementById('miscListData');
    if (miscListData) {
        const sortedItems = [...appData.miscItems].sort((a, b) => a.name.localeCompare(b.name));
        const optionsHtml = sortedItems.map(item => `<option value="${item.name}"></option>`).join('');
        miscListData.innerHTML = optionsHtml;
    }
}

function populateItemDatalist() {
    const itemListData = document.getElementById('itemListData');
    if (itemListData) {
        const sortedItems = [...appData.items].sort((a, b) => a.name.localeCompare(b.name));
        const optionsHtml = sortedItems.map(item => `<option value="${item.name}"></option>`).join('');
        itemListData.innerHTML = optionsHtml;
    }
}


// --- MISSING VALIDATION FUNCTION ---
function validateOrderQty(prefix) {
    const dropdown = document.getElementById(`${prefix}OrderRef`);
    const inputQty = parseInt(document.getElementById(`${prefix}SuppliedQty`).value) || 0;
    const msg = document.getElementById(`${prefix}OrderLimitMsg`);
    const group = document.getElementById(`${prefix}OrderRefGroup`);

    // যদি অর্ডার লিংক অপশন না থাকে বা সিলেক্ট না করা থাকে
    if (!dropdown || dropdown.value === "") {
        if(msg) msg.style.display = 'none';
        return true; 
    }

    const selectedOption = dropdown.options[dropdown.selectedIndex];
    // ডেটাসেট থেকে রিমেইনিং ভ্যালু নেওয়া
    const remainingLimit = parseInt(selectedOption.dataset.remaining);

    if (inputQty > remainingLimit) {
        if(msg) {
            msg.innerText = `Error: Only ${remainingLimit} remaining in this Order!`;
            msg.style.display = 'block';
        }
        return false; // আটকাবে
    } else {
        if(msg) msg.style.display = 'none';
        return true; // অনুমতি দেবে
    }
}
// --- RATE CHART REPORT FUNCTIONS ---

// ১. ডেটা প্রসেসিং ফাংশন (Matrix তৈরি করা)
// --- UPDATED RATE CHART REPORT FUNCTIONS (WITH DATE RANGE) ---

// ১. ডেটা প্রসেসিং ফাংশন (Matrix তৈরি করা - তারিখ অনুযায়ী ফিল্টার করা)
function getRateChartMatrix() {
    // তারিখ ইনপুট থেকে মান নেওয়া
    const startDateVal = document.getElementById('rateChartStartDate').value;
    const endDateVal = document.getElementById('rateChartEndDate').value;

    if (!startDateVal || !endDateVal) {
        alert("Please select both Start Date and End Date.");
        return null; // তারিখ না দিলে নাল রিটার্ন করবে
    }

    const startDate = new Date(startDateVal);
    const endDate = new Date(endDateVal);
    // End date এর সময় দিনের শেষ পর্যন্ত সেট করা (যাতে ওই দিনের সব ইনভয়েস আসে)
    endDate.setHours(23, 59, 59, 999);

    // ক. সব ইউনিক ভেন্ডর খুঁজে বের করা (যাদের ইনভয়েস এই তারিখের মধ্যে আছে)
    const allVendorsSet = new Set();
    
    // শুধুমাত্র সিলেক্ট করা তারিখের ইনভয়েসগুলো ফিল্টার করা
    const filteredInvoices = appData.invoices.filter(inv => {
        const invDate = new Date(inv.date);
        return invDate >= startDate && invDate <= endDate;
    });

    filteredInvoices.forEach(inv => allVendorsSet.add(inv.vendor));
    const vendors = Array.from(allVendorsSet).sort();

    // খ. মেইন ডেটা স্ট্রাকচার তৈরি
    const itemMap = new Map();

    // ১. সব Store Item আগে লিস্টে আনা (কিনে থাকুক বা না থাকুক, সব দেখাবে)
    appData.items.forEach(item => {
        itemMap.set(item.name.toLowerCase(), {
            originalName: item.name,
            type: "STORE ITEM",
            rates: {} 
        });
    });

    // ২. ফিল্টার করা ইনভয়েস থেকে রেট বের করা (লেটেস্ট রেট নেওয়া হবে)
    // তারিখ অনুযায়ী সর্ট করা (পুরানো থেকে নতুন)
    const sortedInvoices = filteredInvoices.sort((a, b) => new Date(a.date) - new Date(b.date));

    sortedInvoices.forEach(inv => {
        inv.items.forEach(item => {
            const itemNameLower = item.name.toLowerCase();
            
            // যদি ম্যাপে না থাকে (মানে Misc Item), তবে যোগ করুন
            if (!itemMap.has(itemNameLower)) {
                itemMap.set(itemNameLower, {
                    originalName: item.name,
                    type: "MISC. ITEM",
                    rates: {}
                });
            }

            // রেট ক্যালকুলেশন (Rate + GST)
            const rateWithGst = item.rate * (1 + item.gst / 100);
            
            // ভেন্ডরের রেট আপডেট করা
            itemMap.get(itemNameLower).rates[inv.vendor] = rateWithGst;
        });
    });

    // ৩. ফাইনাল অ্যারে তৈরি (Store Item গুলো উপরে থাকবে)
    const reportData = Array.from(itemMap.values()).sort((a, b) => {
        if (a.type === "STORE ITEM" && b.type !== "STORE ITEM") return -1;
        if (a.type !== "STORE ITEM" && b.type === "STORE ITEM") return 1;
        return a.originalName.localeCompare(b.originalName);
    });

    return { vendors, reportData, startDate: startDateVal, endDate: endDateVal };
}

// ২. প্রিভিউ ফাংশন (HTML Table জেনারেট)
function previewRateChart() {
    const result = getRateChartMatrix();
    if (!result) return; // তারিখ না দিলে থামবে

    const { vendors, reportData } = result;
    const thead = document.getElementById('rateChartHeader');
    const tbody = document.getElementById('rateChartBody');

    // ১. হেডার তৈরি
    let headerHtml = `
        <tr>
            <th style="position: sticky; left: 0; z-index: 2; background: #2c3e50; min-width: 150px;">ITEM NAME</th>
            <th style="min-width: 100px;">ITEM TYPE</th>
    `;
    vendors.forEach(v => {
        headerHtml += `<th style="min-width: 100px;">${v}</th>`;
    });
    headerHtml += `<th style="min-width: 150px;">Mention Quality/Remarks</th></tr>`;
    thead.innerHTML = headerHtml;

    // ২. বডি তৈরি
    tbody.innerHTML = '';
    
    if (vendors.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">No purchase records found in this date range. Only Item names will be listed below.</td></tr>`;
    }

    reportData.forEach(item => {
        const rates = Object.values(item.rates).filter(r => r > 0);
        const uniqueSortedRates = [...new Set(rates)].sort((a, b) => a - b);
        
        const lowest = uniqueSortedRates[0];
        const secondLowest = uniqueSortedRates[1];

        let rowHtml = `
            <tr>
                <td style="position: sticky; left: 0; background: #fff; font-weight:500;">${item.originalName}</td>
                <td>${item.type}</td>
        `;

        // যদি ভেন্ডর লিস্ট ফাঁকা থাকে (কোনো কেনাকাটা নেই), তবুও লুপ ঘুরবে না, কিন্তু আইটেম নাম দেখাবে
        if (vendors.length > 0) {
            vendors.forEach(v => {
                const rate = item.rates[v];
                let cellContent = '-';
                let style = '';

                if (rate) {
                    const rateFormatted = rate.toFixed(2);
                    if (rate === lowest) {
                        style = 'font-weight: bold; color: green; font-size: 1.1em; border: 2px solid #a3e4d7;'; // Lowest Highlight
                        cellContent = `${rateFormatted}`;
                    } else if (rate === secondLowest) {
                        style = 'font-weight: bold; font-style: italic; color: #d35400;'; // 2nd Lowest
                        cellContent = `${rateFormatted}`;
                    } else {
                        cellContent = rateFormatted;
                    }
                    rowHtml += `<td style="${style} text-align:center;">${cellContent}</td>`;
                } else {
                    rowHtml += `<td style="color:#ccc; text-align:center;">-</td>`;
                }
            });
        }
        
        rowHtml += `<td></td></tr>`;
        tbody.innerHTML += rowHtml;
    });

    openModal('rateChartModal');
}

// ৩. এক্সপোর্ট ফাংশন (PDF & Excel)
function exportRateChart(format) {
    const result = getRateChartMatrix();
    if (!result) return;

    const { vendors, reportData, startDate, endDate } = result;
    const title = `Rate_Chart_${startDate}_to_${endDate}`;

    // ডেটা ফরম্যাট করা
    const headers = ["ITEM NAME", "ITEM TYPE", ...vendors, "REMARKS"];
    const bodyData = reportData.map(item => {
        const row = [item.originalName, item.type];
        
        const rates = Object.values(item.rates).filter(r => r > 0);
        const uniqueSortedRates = [...new Set(rates)].sort((a, b) => a - b);
        const lowest = uniqueSortedRates[0];
        const secondLowest = uniqueSortedRates[1];

        vendors.forEach(v => {
            const rate = item.rates[v];
            row.push(rate ? rate.toFixed(2) : "-");
        });
        row.push(""); 
        return { row, rates: item.rates, lowest, secondLowest };
    });

    if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        
        doc.text("COMPARATIVE RATE CHART REPORT", 14, 15);
        doc.setFontSize(10);
        doc.text(`Period: ${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)}`, 14, 22);

        doc.autoTable({
            head: [headers],
            body: bodyData.map(d => d.row),
            startY: 28,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2, halign: 'center' },
            columnStyles: { 0: { halign: 'left' } }, // Item name left align
            headStyles: { fillColor: [44, 62, 80], textColor: 255 },
            
            didParseCell: function(data) {
                // ভেন্ডর কলামগুলো চেক করে হাইলাইট করা
                if (data.section === 'body' && data.column.index >= 2 && data.column.index < headers.length - 1) {
                    const rowRaw = bodyData[data.row.index];
                    const currentVal = parseFloat(data.cell.raw);
                    
                    if (!isNaN(currentVal)) {
                        if (currentVal === rowRaw.lowest) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.textColor = [0, 128, 0]; // Green
                        } else if (currentVal === rowRaw.secondLowest) {
                            data.cell.styles.fontStyle = 'bolditalic';
                            data.cell.styles.textColor = [211, 84, 0]; // Orange
                        }
                    }
                }
            }
        });
        doc.save(`${title}.pdf`);

    } else if (format === 'excel') {
        const excelArray = [
            ["COMPARATIVE RATE CHART REPORT"],
            [`Period: ${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)}`],
            [],
            headers
        ];
        bodyData.forEach(d => excelArray.push(d.row));

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelArray);
        const wscols = headers.map(h => ({ wch: h.length + 5 }));
        ws['!cols'] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "RateChart");
        XLSX.writeFile(wb, `${title}.xlsx`);
    }
}


// Replace your existing updateLastReqInfo function with this version
function updateLastReqInfo() {
    const displayEl = document.getElementById('lastReqInfo');
    if (!displayEl) return;

    let maxRNum = -1;
    let lastStore = null;

    let maxRDNum = -1;
    let lastMisc = null;

    // Loop through all requisitions to find the one with the largest numeric ID after 'R-' or 'RD-'
    appData.requisitions.forEach(req => {
        if (!req.slipNo) return;

        // Logic for Store Items (R-series)
        if (req.slipNo.startsWith('R-')) {
            const num = parseInt(req.slipNo.replace('R-', ''));
            if (!isNaN(num) && num >= maxRNum) {
                maxRNum = num;
                lastStore = req;
            }
        } 
        // Logic for Miscellaneous Items (RD-series)
        else if (req.slipNo.startsWith('RD-')) {
            const num = parseInt(req.slipNo.replace('RD-', ''));
            if (!isNaN(num) && num >= maxRDNum) {
                maxRDNum = num;
                lastMisc = req;
            }
        }
    });

    const fmtInfo = (req) => {
        if (!req) return "N/A";
        // Shows the Slip No, Date, and Department for the highest found number
        return `<b>${req.slipNo}</b> (Date: ${formatDateToDDMMYYYY(req.date)}, Dept: ${req.department})`;
    };

    displayEl.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><small>Latest Store Req:</small><br>${fmtInfo(lastStore)}</div>
            <div><small>Latest Misc Req:</small><br>${fmtInfo(lastMisc)}</div>
        </div>
    `;
}
</script>
<div id="printContainer" style="display: none;"></div>
</div>
</body>
</html>

